

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Normative modelling tutorial &mdash; PCNToolkit 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            PCNToolkit
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Setup:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quickstart Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Background</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../background.html">PCNtoolkit Background</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Function &amp; Class Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="00_getting_started.html">Getting started with normative modelling</a></li>
<li class="toctree-l1"><a class="reference internal" href="01_loading_data.html">The NormData class</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_BLR.html">Normative Modelling: Bayesian Linear Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_HBR_Normal.html">Normative Modelling: Hierarchical Bayesian Regression with Normal likelihood</a></li>
<li class="toctree-l1"><a class="reference internal" href="04_HBR_SHASH.html">Normative Modelling: Hierarchical Bayesian Regression with SHASH likelihood</a></li>
<li class="toctree-l1"><a class="reference internal" href="05_HBR_Beta.html">Normative Modelling: Hierarchical Bayesian Regression with Beta likelihood</a></li>
<li class="toctree-l1"><a class="reference internal" href="06_cluster.html">Fitting normative models on a compute cluster</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">For developers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../autoapi/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PCNToolkit</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Normative modelling tutorial</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/pages/tutorials/03_HBR_bak.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="normative-modelling-tutorial">
<h1>Normative modelling tutorial<a class="headerlink" href="#normative-modelling-tutorial" title="Link to this heading"></a></h1>
<p>Welcome to this tutorial notebook that will go through the fitting,
evaluation, transfering, and extending of Normative models.</p>
<p>Let’s jump right in.</p>
<section id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Link to this heading"></a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>


<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pcntoolkit</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">BLR</span><span class="p">,</span>
    <span class="n">HBR</span><span class="p">,</span>
    <span class="n">BsplineBasisFunction</span><span class="p">,</span>
    <span class="n">NormativeModel</span><span class="p">,</span>
    <span class="n">NormData</span><span class="p">,</span>
    <span class="n">load_fcon1000</span><span class="p">,</span>
    <span class="n">SHASHbLikelihood</span><span class="p">,</span>
    <span class="n">NormalLikelihood</span><span class="p">,</span>
    <span class="n">make_prior</span><span class="p">,</span>
    <span class="n">plot_centiles</span><span class="p">,</span>
    <span class="n">plot_qq</span><span class="p">,</span>
    <span class="n">plot_ridge</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pcntoolkit.util.output</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s2">&quot;darkgrid&quot;</span><span class="p">)</span>

<span class="c1"># Suppress some annoying warnings and logs</span>
<span class="n">pymc_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;pymc&quot;</span><span class="p">)</span>

<span class="n">pymc_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
<span class="n">pymc_logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">chained_assignment</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># default=&#39;warn&#39;</span>
<span class="n">pcntoolkit</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">Output</span><span class="o">.</span><span class="n">set_show_messages</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<section id="load-data">
<h3>Load data<a class="headerlink" href="#load-data" title="Link to this heading"></a></h3>
<p>First we download a small example dataset from github.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Download the dataset</span>
<span class="n">norm_data</span><span class="p">:</span> <span class="n">NormData</span> <span class="o">=</span> <span class="n">load_fcon1000</span><span class="p">()</span>
<span class="n">features_to_model</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;WM-hypointensities&quot;</span><span class="p">,</span>
    <span class="c1"># &quot;Right-Lateral-Ventricle&quot;,</span>
    <span class="c1"># &quot;Right-Amygdala&quot;,</span>
    <span class="c1"># &quot;CortexVol&quot;,</span>
<span class="p">]</span>
<span class="c1"># Select only a few features</span>
<span class="n">norm_data</span> <span class="o">=</span> <span class="n">norm_data</span><span class="o">.</span><span class="n">sel</span><span class="p">({</span><span class="s2">&quot;response_vars&quot;</span><span class="p">:</span> <span class="n">features_to_model</span><span class="p">})</span>
<span class="c1"># Leave two sites out for doing transfer and extend later</span>
<span class="n">transfer_sites</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Milwaukee_b&quot;</span><span class="p">,</span> <span class="s2">&quot;Oulu&quot;</span><span class="p">]</span>
<span class="n">transfer_data</span><span class="p">,</span> <span class="n">fit_data</span> <span class="o">=</span> <span class="n">norm_data</span><span class="o">.</span><span class="n">batch_effects_split</span><span class="p">({</span><span class="s2">&quot;site&quot;</span><span class="p">:</span> <span class="n">transfer_sites</span><span class="p">},</span> <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;transfer&quot;</span><span class="p">,</span> <span class="s2">&quot;fit&quot;</span><span class="p">))</span>

<span class="c1"># Split into train and test sets</span>
<span class="n">train</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">fit_data</span><span class="o">.</span><span class="n">train_test_split</span><span class="p">()</span>
<span class="n">transfer_train</span><span class="p">,</span> <span class="n">transfer_test</span> <span class="o">=</span> <span class="n">transfer_data</span><span class="o">.</span><span class="n">train_test_split</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Inspect the data</span>
<span class="n">feature_to_plot</span> <span class="o">=</span> <span class="n">features_to_model</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">sns</span><span class="o">.</span><span class="n">countplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;batch_effects&quot;</span><span class="p">,</span> <span class="s2">&quot;site&quot;</span><span class="p">),</span> <span class="n">hue</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;batch_effects&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Sex&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Count of sites&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Site&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Count&quot;</span><span class="p">)</span>


<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">),</span>
    <span class="n">y</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="n">feature_to_plot</span><span class="p">),</span>
    <span class="n">hue</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;batch_effects&quot;</span><span class="p">,</span> <span class="s2">&quot;site&quot;</span><span class="p">),</span>
    <span class="n">style</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;batch_effects&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">),</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">([],</span> <span class="p">[])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scatter plot of age vs </span><span class="si">{</span><span class="n">feature_to_plot</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Age&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">feature_to_plot</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../../_images/03_HBR_bak_6_0.png" src="../../_images/03_HBR_bak_6_0.png" />
</section>
<section id="creating-a-normative-model">
<h3>Creating a Normative model<a class="headerlink" href="#creating-a-normative-model" title="Link to this heading"></a></h3>
<p>A normative model has a regression model for each response variable. We
provide a template regression model which is copied for each response
variable.</p>
<p>A template regression model can be anything that implements the
<code class="docutils literal notranslate"><span class="pre">RegressionModel</span></code> interface. We provide a number of built-in
regression models, but you can also create your own.</p>
<p>Here we use the <code class="docutils literal notranslate"><span class="pre">HBR</span></code> class, which implements a Hierarchical Bayesian
Regression model.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">HBR</span></code> class needs to know which likelihood function to use. We can
either use a Normal, SHASHo, SHASHb, or Beta likelihood. Each of these
likelihood functions has a number of parameters that need to be
specified.</p>
<p>Here we use the Normal likelihood. This takes a mu and a sigma
parameter, which can be created using the <code class="docutils literal notranslate"><span class="pre">make_prior</span></code> function, or by
providing the ‘Prior’ directly.</p>
<p>Here we use the <code class="docutils literal notranslate"><span class="pre">make_prior</span></code> function to create the parameters.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mu</span> <span class="o">=</span> <span class="n">make_prior</span><span class="p">(</span>
    <span class="c1"># Mu is linear because we want to allow the mean to vary as a function of the covariates.</span>
    <span class="n">linear</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="c1"># The slope coefficients are assumed to be normally distributed, with a mean of 0 and a standard deviation of 10.</span>
    <span class="n">slope</span><span class="o">=</span><span class="n">make_prior</span><span class="p">(</span><span class="n">dist_name</span><span class="o">=</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span> <span class="n">dist_params</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)),</span>
    <span class="c1"># The intercept is random, because we expect the intercept to vary between sites and sexes.</span>
    <span class="n">intercept</span><span class="o">=</span><span class="n">make_prior</span><span class="p">(</span>
        <span class="n">random</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="c1"># Mu is the mean of the intercept, which is normally distributed with a mean of 0 and a standard deviation of 1.</span>
        <span class="n">mu</span><span class="o">=</span><span class="n">make_prior</span><span class="p">(</span><span class="n">dist_name</span><span class="o">=</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span> <span class="n">dist_params</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
        <span class="c1"># Sigma is the scale at which the intercepts vary. It is a positive parameter, so we have to map it to the positive domain.</span>
        <span class="n">sigma</span><span class="o">=</span><span class="n">make_prior</span><span class="p">(</span><span class="n">dist_name</span><span class="o">=</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span> <span class="n">dist_params</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">mapping</span><span class="o">=</span><span class="s2">&quot;softplus&quot;</span><span class="p">,</span> <span class="n">mapping_params</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)),</span>
    <span class="p">),</span>
    <span class="c1"># We use a B-spline basis function to allow for non-linearity in the mean.</span>
    <span class="n">basis_function</span><span class="o">=</span><span class="n">BsplineBasisFunction</span><span class="p">(</span><span class="n">basis_column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nknots</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">make_prior</span><span class="p">(</span>
    <span class="c1"># Sigma is also linear, because we want to allow the standard deviation to vary as a function of the covariates: heteroskedasticity.</span>
    <span class="n">linear</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="c1"># The slope coefficients are assumed to be normally distributed, with a mean of 0 and a standard deviation of 2.</span>
    <span class="n">slope</span><span class="o">=</span><span class="n">make_prior</span><span class="p">(</span><span class="n">dist_name</span><span class="o">=</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span> <span class="n">dist_params</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)),</span>
    <span class="c1"># The intercept is random, because we expect the intercept to vary between sites and sexes.</span>
    <span class="n">intercept</span><span class="o">=</span><span class="n">make_prior</span><span class="p">(</span><span class="n">dist_name</span><span class="o">=</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span> <span class="n">dist_params</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
    <span class="c1"># We use a B-spline basis function to allow for non-linearity in the standard deviation.</span>
    <span class="n">basis_function</span><span class="o">=</span><span class="n">BsplineBasisFunction</span><span class="p">(</span><span class="n">basis_column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nknots</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
    <span class="c1"># We use a softplus mapping to ensure that sigma is strictly positive.</span>
    <span class="n">mapping</span><span class="o">=</span><span class="s2">&quot;softplus&quot;</span><span class="p">,</span>
    <span class="c1"># We scale the softplus mapping by a factor of 3, to avoid spikes in the resulting density.</span>
    <span class="c1"># The parameters (a, b, c) provided to a mapping f are used as: f_abc(x) = f((x - a) / b) * b + c</span>
    <span class="c1"># This basically provides an affine transformation of the softplus function.</span>
    <span class="c1"># a -&gt; horizontal shift</span>
    <span class="c1"># b -&gt; scaling</span>
    <span class="c1"># c -&gt; vertical shift</span>
    <span class="c1"># You can leave c out, and it will default to 0.</span>
    <span class="n">mapping_params</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">template_hbr</span> <span class="o">=</span> <span class="n">HBR</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;template&quot;</span><span class="p">,</span>
    <span class="c1"># The number of cores to use for sampling.</span>
    <span class="n">cores</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="c1"># Whether to show a progress bar during the model fitting.</span>
    <span class="n">progressbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="c1"># The number of draws to sample from the posterior per chain.</span>
    <span class="n">draws</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span>
    <span class="c1"># The number of tuning steps to run.</span>
    <span class="n">tune</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="c1"># The number of MCMC chains to run.</span>
    <span class="n">chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="c1"># The sampler to use for the model.</span>
    <span class="n">nuts_sampler</span><span class="o">=</span><span class="s2">&quot;nutpie&quot;</span><span class="p">,</span>
    <span class="c1"># The likelihood function to use for the model.</span>
    <span class="n">likelihood</span><span class="o">=</span><span class="n">NormalLikelihood</span><span class="p">(</span>
        <span class="n">mu</span><span class="p">,</span>
        <span class="n">sigma</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>After specifying the regression model, we can configure a normative
model.</p>
<p>A normative model has a number of configuration options: -
<code class="docutils literal notranslate"><span class="pre">savemodel</span></code>: Whether to save the model after fitting. -
<code class="docutils literal notranslate"><span class="pre">evaluate_model</span></code>: Whether to evaluate the model after fitting. -
<code class="docutils literal notranslate"><span class="pre">saveresults</span></code>: Whether to save the results after evaluation. -
<code class="docutils literal notranslate"><span class="pre">saveplots</span></code>: Whether to save the plots after fitting. - <code class="docutils literal notranslate"><span class="pre">save_dir</span></code>:
The directory to save the model, results, and plots. - <code class="docutils literal notranslate"><span class="pre">inscaler</span></code>: The
scaler to use for the input data. - <code class="docutils literal notranslate"><span class="pre">outscaler</span></code>: The scaler to use for
the output data.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">NormativeModel</span><span class="p">(</span>
    <span class="c1"># The regression model to use for the normative model.</span>
    <span class="n">template_regression_model</span><span class="o">=</span><span class="n">template_hbr</span><span class="p">,</span>
    <span class="c1"># Whether to save the model after fitting.</span>
    <span class="n">savemodel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="c1"># Whether to evaluate the model after fitting.</span>
    <span class="n">evaluate_model</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="c1"># Whether to save the results after evaluation.</span>
    <span class="n">saveresults</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="c1"># Whether to save the plots after fitting.</span>
    <span class="n">saveplots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="c1"># The directory to save the model, results, and plots.</span>
    <span class="n">save_dir</span><span class="o">=</span><span class="s2">&quot;resources/hbr/save_dir&quot;</span><span class="p">,</span>
    <span class="c1"># The scaler to use for the input data. Can be either one of &quot;standardize&quot;, &quot;minmax&quot;, &quot;robminmax&quot;, &quot;none&quot;</span>
    <span class="n">inscaler</span><span class="o">=</span><span class="s2">&quot;standardize&quot;</span><span class="p">,</span>
    <span class="c1"># The scaler to use for the output data. Can be either one of &quot;standardize&quot;, &quot;minmax&quot;, &quot;robminmax&quot;, &quot;none&quot;</span>
    <span class="n">outscaler</span><span class="o">=</span><span class="s2">&quot;standardize&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="fit-the-model">
<h3>Fit the model<a class="headerlink" href="#fit-the-model" title="Link to this heading"></a></h3>
<p>With all that configured, we can fit the model.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">fit_predict</span></code> function will fit the model, evaluate it, and save
the results and plots (if so configured).</p>
<p>After that, it will compute Z-scores and centiles for the test set.</p>
<p>All results can be found in the save directory.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span>
</pre></div>
</div>
<style>
    :root {
        --column-width-1: 40%; /* Progress column width */
        --column-width-2: 15%; /* Chain column width */
        --column-width-3: 15%; /* Divergences column width */
        --column-width-4: 15%; /* Step Size column width */
        --column-width-5: 15%; /* Gradients/Draw column width */
    }

    .nutpie {
        max-width: 800px;
        margin: 10px auto;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        //color: #333;
        //background-color: #fff;
        padding: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border-radius: 8px;
        font-size: 14px; /* Smaller font size for a more compact look */
    }
    .nutpie table {
        width: 100%;
        border-collapse: collapse; /* Remove any extra space between borders */
    }
    .nutpie th, .nutpie td {
        padding: 8px 10px; /* Reduce padding to make table more compact */
        text-align: left;
        border-bottom: 1px solid #888;
    }
    .nutpie th {
        //background-color: #f0f0f0;
    }

    .nutpie th:nth-child(1) { width: var(--column-width-1); }
    .nutpie th:nth-child(2) { width: var(--column-width-2); }
    .nutpie th:nth-child(3) { width: var(--column-width-3); }
    .nutpie th:nth-child(4) { width: var(--column-width-4); }
    .nutpie th:nth-child(5) { width: var(--column-width-5); }

    .nutpie progress {
        width: 100%;
        height: 15px; /* Smaller progress bars */
        border-radius: 5px;
    }
    progress::-webkit-progress-bar {
        background-color: #eee;
        border-radius: 5px;
    }
    progress::-webkit-progress-value {
        background-color: #5cb85c;
        border-radius: 5px;
    }
    progress::-moz-progress-bar {
        background-color: #5cb85c;
        border-radius: 5px;
    }
    .nutpie .progress-cell {
        width: 100%;
    }

    .nutpie p strong { font-size: 16px; font-weight: bold; }

    @media (prefers-color-scheme: dark) {
        .nutpie {
            //color: #ddd;
            //background-color: #1e1e1e;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .nutpie table, .nutpie th, .nutpie td {
            border-color: #555;
            color: #ccc;
        }
        .nutpie th {
            background-color: #2a2a2a;
        }
        .nutpie progress::-webkit-progress-bar {
            background-color: #444;
        }
        .nutpie progress::-webkit-progress-value {
            background-color: #3178c6;
        }
        .nutpie progress::-moz-progress-bar {
            background-color: #3178c6;
        }
    }
</style><div class="nutpie">
    <p><strong>Sampler Progress</strong></p>
    <p>Total Chains: <span id="total-chains">4</span></p>
    <p>Active Chains: <span id="active-chains">0</span></p>
    <p>
        Finished Chains:
        <span id="active-chains">4</span>
    </p>
    <p>Sampling for now</p>
    <p>
        Estimated Time to Completion:
        <span id="eta">now</span>
    </p>

    <progress
        id="total-progress-bar"
        max="8000"
        value="8000">
    </progress>
    <table>
        <thead>
            <tr>
                <th>Progress</th>
                <th>Draws</th>
                <th>Divergences</th>
                <th>Step Size</th>
                <th>Gradients/Draw</th>
            </tr>
        </thead>
        <tbody id="chain-details">

                <tr>
                    <td class="progress-cell">
                        <progress
                            max="2000"
                            value="2000">
                        </progress>
                    </td>
                    <td>2000</td>
                    <td>12</td>
                    <td>0.13</td>
                    <td>127</td>
                </tr>

                <tr>
                    <td class="progress-cell">
                        <progress
                            max="2000"
                            value="2000">
                        </progress>
                    </td>
                    <td>2000</td>
                    <td>85</td>
                    <td>0.12</td>
                    <td>31</td>
                </tr>

                <tr>
                    <td class="progress-cell">
                        <progress
                            max="2000"
                            value="2000">
                        </progress>
                    </td>
                    <td>2000</td>
                    <td>5</td>
                    <td>0.11</td>
                    <td>127</td>
                </tr>

                <tr>
                    <td class="progress-cell">
                        <progress
                            max="2000"
                            value="2000">
                        </progress>
                    </td>
                    <td>2000</td>
                    <td>18</td>
                    <td>0.11</td>
                    <td>95</td>
                </tr>

            </tr>
        </tbody>
    </table>
</div><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_centiles</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">scatter_data</span><span class="o">=</span><span class="n">train</span><span class="p">,</span>  <span class="c1"># Scatter this data along with the centiles</span>
    <span class="n">batch_effects</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;site&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Beijing_Zang&quot;</span><span class="p">,</span> <span class="s2">&quot;AnnArbor_a&quot;</span><span class="p">],</span> <span class="s2">&quot;sex&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">]},</span>  <span class="c1"># Highlight these groups</span>
    <span class="n">show_other_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># scatter other data as smaller black circles</span>
<span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/03_HBR_bak_13_0.png" src="../../_images/03_HBR_bak_13_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># If predictions are made on a dataset, the model evaluation statistics are stored in the dataset.</span>
<span class="n">display</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">get_statistics_df</span><span class="p">())</span>
<span class="n">display</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">get_statistics_df</span><span class="p">())</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>statistic</th>
      <th>MACE</th>
      <th>MAPE</th>
      <th>MSLL</th>
      <th>NLL</th>
      <th>R2</th>
      <th>RMSE</th>
      <th>Rho</th>
      <th>Rho_p</th>
      <th>SMSE</th>
      <th>ShapiroW</th>
    </tr>
    <tr>
      <th>response_vars</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>WM-hypointensities</th>
      <td>0.04</td>
      <td>14.4</td>
      <td>0.64</td>
      <td>0.78</td>
      <td>0.39</td>
      <td>0.78</td>
      <td>0.55</td>
      <td>0.0</td>
      <td>0.61</td>
      <td>0.91</td>
    </tr>
  </tbody>
</table>
</div><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>statistic</th>
      <th>MACE</th>
      <th>MAPE</th>
      <th>MSLL</th>
      <th>NLL</th>
      <th>R2</th>
      <th>RMSE</th>
      <th>Rho</th>
      <th>Rho_p</th>
      <th>SMSE</th>
      <th>ShapiroW</th>
    </tr>
    <tr>
      <th>response_vars</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>WM-hypointensities</th>
      <td>0.03</td>
      <td>5.2</td>
      <td>0.37</td>
      <td>0.86</td>
      <td>0.42</td>
      <td>0.63</td>
      <td>0.57</td>
      <td>0.0</td>
      <td>0.58</td>
      <td>0.94</td>
    </tr>
  </tbody>
</table>
</div></section>
<section id="whats-next">
<h3>What’s next?<a class="headerlink" href="#whats-next" title="Link to this heading"></a></h3>
<p>Now we have a normative model, we can use it to: - Harmonize data -
Synthesize data - Map data to Z-scores - Plot centiles - Plot QQ-plots -
Plot ridge plots - Save the model - Send it to a colleague - Load it
from file - Transfer the model to another dataset - Extend the model to
another dataset</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># turn this off because it costs time</span>
<span class="n">model</span><span class="o">.</span><span class="n">savemodel</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">model</span><span class="o">.</span><span class="n">saveresults</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">model</span><span class="o">.</span><span class="n">saveplots</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">model</span><span class="o">.</span><span class="n">evaluate_model</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---------------------------------------------------------------------------</span>

<span class="ne">NameError</span>                                 <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>

<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
      <span class="mi">1</span> <span class="c1"># turn this off because it costs time</span>
<span class="o">----&gt;</span> <span class="mi">2</span> <span class="n">model</span><span class="o">.</span><span class="n">savemodel</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="mi">3</span> <span class="n">model</span><span class="o">.</span><span class="n">saveresults</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="mi">4</span> <span class="n">model</span><span class="o">.</span><span class="n">saveplots</span> <span class="o">=</span> <span class="kc">False</span>


<span class="ne">NameError</span><span class="p">:</span> <span class="n">name</span> <span class="s1">&#39;model&#39;</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">defined</span>
</pre></div>
</div>
</section>
</section>
<section id="harmonize">
<h2>Harmonize<a class="headerlink" href="#harmonize" title="Link to this heading"></a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">harmonize</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>  <span class="c1"># &lt;- easy</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">),</span> <span class="n">y</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="n">feature_to_plot</span><span class="p">),</span> <span class="n">hue</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;batch_effects&quot;</span><span class="p">,</span> <span class="s2">&quot;site&quot;</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">),</span> <span class="n">y</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Y_harmonized&quot;</span><span class="p">,</span> <span class="n">feature_to_plot</span><span class="p">),</span> <span class="n">hue</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;batch_effects&quot;</span><span class="p">,</span> <span class="s2">&quot;site&quot;</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s2">&quot;Unharmonized&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s2">&quot;Harmonized&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">([],</span> <span class="p">[])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">([],</span> <span class="p">[])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Age&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">feature_to_plot</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Age&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">feature_to_plot</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../../_images/03_HBR_bak_18_0.png" src="../../_images/03_HBR_bak_18_0.png" />
</section>
<section id="synthesize">
<h2>Synthesize<a class="headerlink" href="#synthesize" title="Link to this heading"></a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">synthetic_data</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">synthesize</span><span class="p">(</span><span class="n">covariate_range_per_batch_effect</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># &lt;- also easy</span>
<span class="n">plot_centiles</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">covariate</span><span class="o">=</span><span class="s2">&quot;age&quot;</span><span class="p">,</span>  <span class="c1"># Which covariate to plot on the x-axis</span>
    <span class="n">scatter_data</span><span class="o">=</span><span class="n">synthetic_data</span><span class="p">,</span>
    <span class="n">show_other_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">harmonize_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">show_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/03_HBR_bak_20_0.png" src="../../_images/03_HBR_bak_20_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Synthesize new Y data for existing X data</span>
<span class="n">new_test_data</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">new_test_data</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">):</span>
    <span class="k">del</span> <span class="n">new_test_data</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">]</span>

<span class="n">synthetic</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">synthesize</span><span class="p">(</span><span class="n">new_test_data</span><span class="p">)</span>  <span class="c1"># &lt;- will fill in the missing Y data</span>
<span class="n">plot_centiles</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">centiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">],</span>  <span class="c1"># Plot arbitrary centiles</span>
    <span class="n">covariate</span><span class="o">=</span><span class="s2">&quot;age&quot;</span><span class="p">,</span>  <span class="c1"># Which covariate to plot on the x-axis</span>
    <span class="n">scatter_data</span><span class="o">=</span><span class="n">train</span><span class="p">,</span>  <span class="c1"># Scatter the train data points</span>
    <span class="n">batch_effects</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>  <span class="c1"># You can set this to &quot;all&quot; to show all batch effects</span>
    <span class="n">show_other_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Show data points that do not match any batch effects</span>
    <span class="n">harmonize_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Set this to False to see the difference</span>
    <span class="n">show_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Don&#39;t show the legend because it crowds the plot</span>
<span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/03_HBR_bak_21_0.png" src="../../_images/03_HBR_bak_21_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_qq</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">plot_id_line</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hue_data</span><span class="o">=</span><span class="s2">&quot;site&quot;</span><span class="p">,</span> <span class="n">split_data</span><span class="o">=</span><span class="s2">&quot;site&quot;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_theme</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;darkgrid&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;axes.facecolor&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)})</span>
</pre></div>
</div>
<img alt="../../_images/03_HBR_bak_22_0.png" src="../../_images/03_HBR_bak_22_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Show the distribution of predicted Z-scores per site</span>
<span class="n">plot_ridge</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;site&quot;</span><span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block">/opt/anaconda3/envs/uv_refactor/lib/python3.12/site-packages/seaborn/axisgrid.py:854: UserWarning: Dataset has 0 variance; skipping density estimate. Pass <cite>warn_singular=False</cite> to disable this warning.
  func(<a href="#id1"><span class="problematic" id="id2">*</span></a>plot_args, <a href="#id3"><span class="problematic" id="id4">**</span></a>plot_kwargs)
/opt/anaconda3/envs/uv_refactor/lib/python3.12/site-packages/seaborn/axisgrid.py:854: UserWarning: Dataset has 0 variance; skipping density estimate. Pass <cite>warn_singular=False</cite> to disable this warning.
  func(<a href="#id5"><span class="problematic" id="id6">*</span></a>plot_args, <a href="#id7"><span class="problematic" id="id8">**</span></a>plot_kwargs)</pre>
<img alt="../../_images/03_HBR_bak_23_1.png" src="../../_images/03_HBR_bak_23_1.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Show the distribution of predicted Z-scores per site</span>
<span class="n">plot_ridge</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">)</span>
<span class="n">plot_ridge</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">anaconda3</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">uv_refactor</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.12</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">seaborn</span><span class="o">/</span><span class="n">axisgrid</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">123</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">Tight</span> <span class="n">layout</span> <span class="ow">not</span> <span class="n">applied</span><span class="o">.</span> <span class="n">tight_layout</span> <span class="n">cannot</span> <span class="n">make</span> <span class="n">Axes</span> <span class="n">height</span> <span class="n">small</span> <span class="n">enough</span> <span class="n">to</span> <span class="n">accommodate</span> <span class="nb">all</span> <span class="n">Axes</span> <span class="n">decorations</span><span class="o">.</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_figure</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">anaconda3</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">uv_refactor</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.12</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">seaborn</span><span class="o">/</span><span class="n">axisgrid</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">123</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">Tight</span> <span class="n">layout</span> <span class="ow">not</span> <span class="n">applied</span><span class="o">.</span> <span class="n">The</span> <span class="n">bottom</span> <span class="ow">and</span> <span class="n">top</span> <span class="n">margins</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">made</span> <span class="n">large</span> <span class="n">enough</span> <span class="n">to</span> <span class="n">accommodate</span> <span class="nb">all</span> <span class="n">Axes</span> <span class="n">decorations</span><span class="o">.</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_figure</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">anaconda3</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">uv_refactor</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.12</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">seaborn</span><span class="o">/</span><span class="n">axisgrid</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">123</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">Tight</span> <span class="n">layout</span> <span class="ow">not</span> <span class="n">applied</span><span class="o">.</span> <span class="n">The</span> <span class="n">bottom</span> <span class="ow">and</span> <span class="n">top</span> <span class="n">margins</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">made</span> <span class="n">large</span> <span class="n">enough</span> <span class="n">to</span> <span class="n">accommodate</span> <span class="nb">all</span> <span class="n">Axes</span> <span class="n">decorations</span><span class="o">.</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_figure</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">anaconda3</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">uv_refactor</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.12</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">seaborn</span><span class="o">/</span><span class="n">axisgrid</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">123</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">Tight</span> <span class="n">layout</span> <span class="ow">not</span> <span class="n">applied</span><span class="o">.</span> <span class="n">The</span> <span class="n">bottom</span> <span class="ow">and</span> <span class="n">top</span> <span class="n">margins</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">made</span> <span class="n">large</span> <span class="n">enough</span> <span class="n">to</span> <span class="n">accommodate</span> <span class="nb">all</span> <span class="n">Axes</span> <span class="n">decorations</span><span class="o">.</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_figure</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">anaconda3</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">uv_refactor</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.12</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">seaborn</span><span class="o">/</span><span class="n">axisgrid</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">123</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">Tight</span> <span class="n">layout</span> <span class="ow">not</span> <span class="n">applied</span><span class="o">.</span> <span class="n">The</span> <span class="n">bottom</span> <span class="ow">and</span> <span class="n">top</span> <span class="n">margins</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">made</span> <span class="n">large</span> <span class="n">enough</span> <span class="n">to</span> <span class="n">accommodate</span> <span class="nb">all</span> <span class="n">Axes</span> <span class="n">decorations</span><span class="o">.</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_figure</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">anaconda3</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">uv_refactor</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.12</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">pcntoolkit</span><span class="o">/</span><span class="n">util</span><span class="o">/</span><span class="n">plotter</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">541</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">Tight</span> <span class="n">layout</span> <span class="ow">not</span> <span class="n">applied</span><span class="o">.</span> <span class="n">tight_layout</span> <span class="n">cannot</span> <span class="n">make</span> <span class="n">Axes</span> <span class="n">height</span> <span class="n">small</span> <span class="n">enough</span> <span class="n">to</span> <span class="n">accommodate</span> <span class="nb">all</span> <span class="n">Axes</span> <span class="n">decorations</span><span class="o">.</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../../_images/03_HBR_bak_24_1.png" src="../../_images/03_HBR_bak_24_1.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">anaconda3</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">uv_refactor</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.12</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">seaborn</span><span class="o">/</span><span class="n">axisgrid</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">123</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">Tight</span> <span class="n">layout</span> <span class="ow">not</span> <span class="n">applied</span><span class="o">.</span> <span class="n">tight_layout</span> <span class="n">cannot</span> <span class="n">make</span> <span class="n">Axes</span> <span class="n">height</span> <span class="n">small</span> <span class="n">enough</span> <span class="n">to</span> <span class="n">accommodate</span> <span class="nb">all</span> <span class="n">Axes</span> <span class="n">decorations</span><span class="o">.</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_figure</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">anaconda3</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">uv_refactor</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.12</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">seaborn</span><span class="o">/</span><span class="n">axisgrid</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">123</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">Tight</span> <span class="n">layout</span> <span class="ow">not</span> <span class="n">applied</span><span class="o">.</span> <span class="n">The</span> <span class="n">bottom</span> <span class="ow">and</span> <span class="n">top</span> <span class="n">margins</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">made</span> <span class="n">large</span> <span class="n">enough</span> <span class="n">to</span> <span class="n">accommodate</span> <span class="nb">all</span> <span class="n">Axes</span> <span class="n">decorations</span><span class="o">.</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_figure</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">anaconda3</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">uv_refactor</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.12</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">seaborn</span><span class="o">/</span><span class="n">axisgrid</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">123</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">Tight</span> <span class="n">layout</span> <span class="ow">not</span> <span class="n">applied</span><span class="o">.</span> <span class="n">The</span> <span class="n">bottom</span> <span class="ow">and</span> <span class="n">top</span> <span class="n">margins</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">made</span> <span class="n">large</span> <span class="n">enough</span> <span class="n">to</span> <span class="n">accommodate</span> <span class="nb">all</span> <span class="n">Axes</span> <span class="n">decorations</span><span class="o">.</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_figure</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">anaconda3</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">uv_refactor</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.12</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">seaborn</span><span class="o">/</span><span class="n">axisgrid</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">123</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">Tight</span> <span class="n">layout</span> <span class="ow">not</span> <span class="n">applied</span><span class="o">.</span> <span class="n">The</span> <span class="n">bottom</span> <span class="ow">and</span> <span class="n">top</span> <span class="n">margins</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">made</span> <span class="n">large</span> <span class="n">enough</span> <span class="n">to</span> <span class="n">accommodate</span> <span class="nb">all</span> <span class="n">Axes</span> <span class="n">decorations</span><span class="o">.</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_figure</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">anaconda3</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">uv_refactor</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.12</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">seaborn</span><span class="o">/</span><span class="n">axisgrid</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">123</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">Tight</span> <span class="n">layout</span> <span class="ow">not</span> <span class="n">applied</span><span class="o">.</span> <span class="n">The</span> <span class="n">bottom</span> <span class="ow">and</span> <span class="n">top</span> <span class="n">margins</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">made</span> <span class="n">large</span> <span class="n">enough</span> <span class="n">to</span> <span class="n">accommodate</span> <span class="nb">all</span> <span class="n">Axes</span> <span class="n">decorations</span><span class="o">.</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_figure</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">anaconda3</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">uv_refactor</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.12</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">pcntoolkit</span><span class="o">/</span><span class="n">util</span><span class="o">/</span><span class="n">plotter</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">541</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">Tight</span> <span class="n">layout</span> <span class="ow">not</span> <span class="n">applied</span><span class="o">.</span> <span class="n">tight_layout</span> <span class="n">cannot</span> <span class="n">make</span> <span class="n">Axes</span> <span class="n">height</span> <span class="n">small</span> <span class="n">enough</span> <span class="n">to</span> <span class="n">accommodate</span> <span class="nb">all</span> <span class="n">Axes</span> <span class="n">decorations</span><span class="o">.</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../../_images/03_HBR_bak_24_3.png" src="../../_images/03_HBR_bak_24_3.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Remove the Z-scores if they exist (for demonstration purposes)</span>
<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">):</span>
    <span class="k">del</span> <span class="n">test</span><span class="p">[</span><span class="s2">&quot;Z&quot;</span><span class="p">]</span>

<span class="c1"># Get new Z-scores</span>
<span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>

<span class="c1"># Display the Z-scores</span>
<span class="n">display</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="s2">&quot;Z&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">())</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>response_vars</th>
      <th>WM-hypointensities</th>
    </tr>
    <tr>
      <th>observations</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>515</th>
      <td>-0.296410</td>
    </tr>
    <tr>
      <th>441</th>
      <td>-0.528196</td>
    </tr>
    <tr>
      <th>1029</th>
      <td>0.574404</td>
    </tr>
    <tr>
      <th>64</th>
      <td>0.327241</td>
    </tr>
    <tr>
      <th>654</th>
      <td>-0.770792</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>611</th>
      <td>1.766515</td>
    </tr>
    <tr>
      <th>549</th>
      <td>1.590130</td>
    </tr>
    <tr>
      <th>640</th>
      <td>-0.880070</td>
    </tr>
    <tr>
      <th>648</th>
      <td>-0.203221</td>
    </tr>
    <tr>
      <th>635</th>
      <td>-1.524593</td>
    </tr>
  </tbody>
</table>
<p>186 rows × 1 columns</p>
</div></section>
<section id="transfer-and-extend">
<h2>Transfer and extend<a class="headerlink" href="#transfer-and-extend" title="Link to this heading"></a></h2>
<p>We can transfer the model to a new dataset with new sites. Then we will
be able to use it on the new dataset.</p>
<p>We can also extend the model to a new dataset. Then we will be able to
use it on the new dataset as well as the old one.</p>
<p>Both are possible without access to the original data.</p>
<p>Isn’t that cool?</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Turn this back on</span>
<span class="n">model</span><span class="o">.</span><span class="n">savemodel</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">model</span><span class="o">.</span><span class="n">saveresults</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">model</span><span class="o">.</span><span class="n">saveplots</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">model</span><span class="o">.</span><span class="n">evaluate_model</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Transfer the model to a new dataset</span>
<span class="n">transfered_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">transfer_predict</span><span class="p">(</span><span class="n">transfer_train</span><span class="p">,</span> <span class="n">transfer_test</span><span class="p">,</span> <span class="n">freedom</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
<style>
    :root {
        --column-width-1: 40%; /* Progress column width */
        --column-width-2: 15%; /* Chain column width */
        --column-width-3: 15%; /* Divergences column width */
        --column-width-4: 15%; /* Step Size column width */
        --column-width-5: 15%; /* Gradients/Draw column width */
    }

    .nutpie {
        max-width: 800px;
        margin: 10px auto;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        //color: #333;
        //background-color: #fff;
        padding: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border-radius: 8px;
        font-size: 14px; /* Smaller font size for a more compact look */
    }
    .nutpie table {
        width: 100%;
        border-collapse: collapse; /* Remove any extra space between borders */
    }
    .nutpie th, .nutpie td {
        padding: 8px 10px; /* Reduce padding to make table more compact */
        text-align: left;
        border-bottom: 1px solid #888;
    }
    .nutpie th {
        //background-color: #f0f0f0;
    }

    .nutpie th:nth-child(1) { width: var(--column-width-1); }
    .nutpie th:nth-child(2) { width: var(--column-width-2); }
    .nutpie th:nth-child(3) { width: var(--column-width-3); }
    .nutpie th:nth-child(4) { width: var(--column-width-4); }
    .nutpie th:nth-child(5) { width: var(--column-width-5); }

    .nutpie progress {
        width: 100%;
        height: 15px; /* Smaller progress bars */
        border-radius: 5px;
    }
    progress::-webkit-progress-bar {
        background-color: #eee;
        border-radius: 5px;
    }
    progress::-webkit-progress-value {
        background-color: #5cb85c;
        border-radius: 5px;
    }
    progress::-moz-progress-bar {
        background-color: #5cb85c;
        border-radius: 5px;
    }
    .nutpie .progress-cell {
        width: 100%;
    }

    .nutpie p strong { font-size: 16px; font-weight: bold; }

    @media (prefers-color-scheme: dark) {
        .nutpie {
            //color: #ddd;
            //background-color: #1e1e1e;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .nutpie table, .nutpie th, .nutpie td {
            border-color: #555;
            color: #ccc;
        }
        .nutpie th {
            background-color: #2a2a2a;
        }
        .nutpie progress::-webkit-progress-bar {
            background-color: #444;
        }
        .nutpie progress::-webkit-progress-value {
            background-color: #3178c6;
        }
        .nutpie progress::-moz-progress-bar {
            background-color: #3178c6;
        }
    }
</style><div class="nutpie">
    <p><strong>Sampler Progress</strong></p>
    <p>Total Chains: <span id="total-chains">4</span></p>
    <p>Active Chains: <span id="active-chains">0</span></p>
    <p>
        Finished Chains:
        <span id="active-chains">4</span>
    </p>
    <p>Sampling for now</p>
    <p>
        Estimated Time to Completion:
        <span id="eta">now</span>
    </p>

    <progress
        id="total-progress-bar"
        max="8000"
        value="8000">
    </progress>
    <table>
        <thead>
            <tr>
                <th>Progress</th>
                <th>Draws</th>
                <th>Divergences</th>
                <th>Step Size</th>
                <th>Gradients/Draw</th>
            </tr>
        </thead>
        <tbody id="chain-details">

                <tr>
                    <td class="progress-cell">
                        <progress
                            max="2000"
                            value="2000">
                        </progress>
                    </td>
                    <td>2000</td>
                    <td>1</td>
                    <td>0.20</td>
                    <td>31</td>
                </tr>

                <tr>
                    <td class="progress-cell">
                        <progress
                            max="2000"
                            value="2000">
                        </progress>
                    </td>
                    <td>2000</td>
                    <td>2</td>
                    <td>0.20</td>
                    <td>63</td>
                </tr>

                <tr>
                    <td class="progress-cell">
                        <progress
                            max="2000"
                            value="2000">
                        </progress>
                    </td>
                    <td>2000</td>
                    <td>5</td>
                    <td>0.23</td>
                    <td>15</td>
                </tr>

                <tr>
                    <td class="progress-cell">
                        <progress
                            max="2000"
                            value="2000">
                        </progress>
                    </td>
                    <td>2000</td>
                    <td>3</td>
                    <td>0.24</td>
                    <td>31</td>
                </tr>

            </tr>
        </tbody>
    </table>
</div><div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme="dark"],
html[data-theme="dark"],
body[data-theme="dark"],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1f1f1f;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 0 20px 0 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: inline-block;
  opacity: 0;
  height: 0;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:focus + label {
  border: 2px solid var(--xr-font-color0);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: "►";
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: "▼";
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: "(";
}

.xr-dim-list:after {
  content: ")";
}

.xr-dim-list li:not(:last-child):after {
  content: ",";
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-index-preview {
  grid-column: 2 / 5;
  color: var(--xr-font-color2);
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data,
.xr-index-data-in:checked ~ .xr-index-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-index-name div,
.xr-index-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2,
.xr-no-icon {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.NormData&gt; Size: 6kB
Dimensions:            (observations: 30, response_vars: 1, covariates: 1,
                        batch_effect_dims: 2, centile: 5, statistic: 10)
Coordinates:
  * observations       (observations) int64 240B 951 953 915 943 ... 973 908 976
  * response_vars      (response_vars) &lt;U18 72B &#x27;WM-hypointensities&#x27;
  * covariates         (covariates) &lt;U3 12B &#x27;age&#x27;
  * batch_effect_dims  (batch_effect_dims) &lt;U4 32B &#x27;sex&#x27; &#x27;site&#x27;
  * centile            (centile) float64 40B 0.05 0.25 0.5 0.75 0.95
  * statistic          (statistic) &lt;U8 320B &#x27;MACE&#x27; &#x27;MAPE&#x27; ... &#x27;SMSE&#x27; &#x27;ShapiroW&#x27;
Data variables:
    subjects           (observations) object 240B &#x27;Oulu_sub72795&#x27; ... &#x27;Oulu_s...
    Y                  (observations, response_vars) float64 240B 1.287e+03 ....
    X                  (observations, covariates) float64 240B 21.0 ... 21.0
    batch_effects      (observations, batch_effect_dims) &lt;U11 3kB &#x27;0&#x27; ... &#x27;Oulu&#x27;
    Z                  (observations, response_vars) float64 240B 0.0839 ... ...
    centiles           (centile, observations, response_vars) float64 1kB 737...
    logp               (observations, response_vars) float64 240B -0.1018 ......
    Y_harmonized       (observations, response_vars) float64 240B 1.162e+03 ....
    Yhat               (observations, response_vars) float64 240B 0.08675 ......
    statistics         (response_vars, statistic) float64 80B 0.07333 ... 0.988
Attributes:
    real_ids:                       True
    is_scaled:                      False
    name:                           transfer_test
    unique_batch_effects:           {&#x27;sex&#x27;: [&#x27;0&#x27;, &#x27;1&#x27;], &#x27;site&#x27;: [&#x27;Milwaukee_b...
    batch_effect_counts:            {&#x27;sex&#x27;: {&#x27;0&#x27;: 96, &#x27;1&#x27;: 52}, &#x27;site&#x27;: {&#x27;Mil...
    batch_effect_covariate_ranges:  {&#x27;sex&#x27;: {&#x27;0&#x27;: {&#x27;age&#x27;: {&#x27;min&#x27;: 20.0, &#x27;max&#x27;...
    covariate_ranges:               {&#x27;age&#x27;: {&#x27;min&#x27;: 20.0, &#x27;max&#x27;: 65.0}}</pre><div class='xr-wrap' style='display:none'><div class='xr-header'><div class='xr-obj-type'>xarray.NormData</div></div><ul class='xr-sections'><li class='xr-section-item'><input id='section-9e4b405b-e114-43b6-be36-26a043f65a76' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-9e4b405b-e114-43b6-be36-26a043f65a76' class='xr-section-summary'  title='Expand/collapse section'>Dimensions:</label><div class='xr-section-inline-details'><ul class='xr-dim-list'><li><span class='xr-has-index'>observations</span>: 30</li><li><span class='xr-has-index'>response_vars</span>: 1</li><li><span class='xr-has-index'>covariates</span>: 1</li><li><span class='xr-has-index'>batch_effect_dims</span>: 2</li><li><span class='xr-has-index'>centile</span>: 5</li><li><span class='xr-has-index'>statistic</span>: 10</li></ul></div><div class='xr-section-details'></div></li><li class='xr-section-item'><input id='section-7bf0d091-7de3-4899-bbac-2997431ed7ed' class='xr-section-summary-in' type='checkbox'  checked><label for='section-7bf0d091-7de3-4899-bbac-2997431ed7ed' class='xr-section-summary' >Coordinates: <span>(6)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>observations</span></div><div class='xr-var-dims'>(observations)</div><div class='xr-var-dtype'>int64</div><div class='xr-var-preview xr-preview'>951 953 915 943 ... 904 973 908 976</div><input id='attrs-9aabecec-29b0-4e26-9de3-655b738ad84a' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-9aabecec-29b0-4e26-9de3-655b738ad84a' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-7b0e1a65-3f3e-43f5-ac07-119868476ccb' class='xr-var-data-in' type='checkbox'><label for='data-7b0e1a65-3f3e-43f5-ac07-119868476ccb' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([951, 953, 915, 943, 903, 906, 959, 969, 887, 738, 705, 888, 739, 907,
       736, 717, 983, 965, 897, 724, 964, 957, 706, 711, 931, 697, 904, 973,
       908, 976])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>response_vars</span></div><div class='xr-var-dims'>(response_vars)</div><div class='xr-var-dtype'>&lt;U18</div><div class='xr-var-preview xr-preview'>&#x27;WM-hypointensities&#x27;</div><input id='attrs-20c59d51-f8c5-4932-8e84-bec39084afcd' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-20c59d51-f8c5-4932-8e84-bec39084afcd' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-c9bdbea1-bf6c-436e-a66e-558880836644' class='xr-var-data-in' type='checkbox'><label for='data-c9bdbea1-bf6c-436e-a66e-558880836644' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([&#x27;WM-hypointensities&#x27;], dtype=&#x27;&lt;U18&#x27;)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>covariates</span></div><div class='xr-var-dims'>(covariates)</div><div class='xr-var-dtype'>&lt;U3</div><div class='xr-var-preview xr-preview'>&#x27;age&#x27;</div><input id='attrs-69ef9ed4-de1f-4a8c-a179-e50124dafd42' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-69ef9ed4-de1f-4a8c-a179-e50124dafd42' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-08278d87-86d9-4594-af7b-9c2b5ff7a107' class='xr-var-data-in' type='checkbox'><label for='data-08278d87-86d9-4594-af7b-9c2b5ff7a107' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([&#x27;age&#x27;], dtype=&#x27;&lt;U3&#x27;)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>batch_effect_dims</span></div><div class='xr-var-dims'>(batch_effect_dims)</div><div class='xr-var-dtype'>&lt;U4</div><div class='xr-var-preview xr-preview'>&#x27;sex&#x27; &#x27;site&#x27;</div><input id='attrs-720bcd9f-8a1f-4866-8bca-25b48e3f37ee' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-720bcd9f-8a1f-4866-8bca-25b48e3f37ee' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-5a81768a-ae0e-4d7b-876d-d910e7f6ff6d' class='xr-var-data-in' type='checkbox'><label for='data-5a81768a-ae0e-4d7b-876d-d910e7f6ff6d' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([&#x27;sex&#x27;, &#x27;site&#x27;], dtype=&#x27;&lt;U4&#x27;)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>centile</span></div><div class='xr-var-dims'>(centile)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>0.05 0.25 0.5 0.75 0.95</div><input id='attrs-79a36adc-a314-4f7a-9e66-5107800d280b' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-79a36adc-a314-4f7a-9e66-5107800d280b' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-32079e86-216f-4d6a-9db0-91b111702973' class='xr-var-data-in' type='checkbox'><label for='data-32079e86-216f-4d6a-9db0-91b111702973' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([0.05, 0.25, 0.5 , 0.75, 0.95])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>statistic</span></div><div class='xr-var-dims'>(statistic)</div><div class='xr-var-dtype'>&lt;U8</div><div class='xr-var-preview xr-preview'>&#x27;MACE&#x27; &#x27;MAPE&#x27; ... &#x27;SMSE&#x27; &#x27;ShapiroW&#x27;</div><input id='attrs-e65a9890-332b-4992-bb27-373b442df1ca' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-e65a9890-332b-4992-bb27-373b442df1ca' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-80de9dda-3be9-4809-8587-7d93e304ec61' class='xr-var-data-in' type='checkbox'><label for='data-80de9dda-3be9-4809-8587-7d93e304ec61' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([&#x27;MACE&#x27;, &#x27;MAPE&#x27;, &#x27;MSLL&#x27;, &#x27;NLL&#x27;, &#x27;R2&#x27;, &#x27;RMSE&#x27;, &#x27;Rho&#x27;, &#x27;Rho_p&#x27;, &#x27;SMSE&#x27;,
       &#x27;ShapiroW&#x27;], dtype=&#x27;&lt;U8&#x27;)</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-e1c458ad-07f6-4fbf-9872-4ee82b1511ce' class='xr-section-summary-in' type='checkbox'  checked><label for='section-e1c458ad-07f6-4fbf-9872-4ee82b1511ce' class='xr-section-summary' >Data variables: <span>(10)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span>subjects</span></div><div class='xr-var-dims'>(observations)</div><div class='xr-var-dtype'>object</div><div class='xr-var-preview xr-preview'>&#x27;Oulu_sub72795&#x27; ... &#x27;Oulu_sub94314&#x27;</div><input id='attrs-6567304e-b853-424a-9aab-423a4391367c' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-6567304e-b853-424a-9aab-423a4391367c' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-1a64b2f2-34be-4182-a230-eefd4075d9f6' class='xr-var-data-in' type='checkbox'><label for='data-1a64b2f2-34be-4182-a230-eefd4075d9f6' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([&#x27;Oulu_sub72795&#x27;, &#x27;Oulu_sub73709&#x27;, &#x27;Oulu_sub26554&#x27;, &#x27;Oulu_sub62124&#x27;,
       &#x27;Oulu_sub16378&#x27;, &#x27;Oulu_sub19971&#x27;, &#x27;Oulu_sub75620&#x27;, &#x27;Oulu_sub86410&#x27;,
       &#x27;Oulu_sub01679&#x27;, &#x27;Milwaukee_b_sub91468&#x27;, &#x27;Milwaukee_b_sub24237&#x27;,
       &#x27;Oulu_sub02036&#x27;, &#x27;Milwaukee_b_sub93170&#x27;, &#x27;Oulu_sub20495&#x27;,
       &#x27;Milwaukee_b_sub87784&#x27;, &#x27;Milwaukee_b_sub53971&#x27;, &#x27;Oulu_sub98661&#x27;,
       &#x27;Oulu_sub79784&#x27;, &#x27;Oulu_sub12152&#x27;, &#x27;Milwaukee_b_sub58967&#x27;,
       &#x27;Oulu_sub78648&#x27;, &#x27;Oulu_sub75293&#x27;, &#x27;Milwaukee_b_sub28782&#x27;,
       &#x27;Milwaukee_b_sub45019&#x27;, &#x27;Oulu_sub41731&#x27;, &#x27;Milwaukee_b_sub09931&#x27;,
       &#x27;Oulu_sub18356&#x27;, &#x27;Oulu_sub91105&#x27;, &#x27;Oulu_sub20926&#x27;, &#x27;Oulu_sub94314&#x27;],
      dtype=object)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>Y</span></div><div class='xr-var-dims'>(observations, response_vars)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>1.287e+03 1.161e+03 ... 646.6</div><input id='attrs-3ff076f9-6b9f-427a-babf-7c7704535f8f' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-3ff076f9-6b9f-427a-babf-7c7704535f8f' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-41b7ce6d-732e-4fe8-a1fb-421064fce8c5' class='xr-var-data-in' type='checkbox'><label for='data-41b7ce6d-732e-4fe8-a1fb-421064fce8c5' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[1287.3],
       [1160.6],
       [1773. ],
       [1328.2],
       [1134.3],
       [1026.1],
       [ 707.3],
       [ 940.1],
       [1281.9],
       [1013. ],
       [2311.5],
       [1179. ],
       [2083.9],
       [1139.1],
       [2153. ],
       [ 986.8],
       [1041.5],
       [1325.1],
       [1379. ],
       [ 763.4],
       [ 881.5],
       [ 716.9],
       [2123.2],
       [ 607.4],
       [1688.3],
       [1601.1],
       [1147.6],
       [1567.5],
       [1518. ],
       [ 646.6]])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>X</span></div><div class='xr-var-dims'>(observations, covariates)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>21.0 22.0 22.0 ... 22.0 21.0 21.0</div><input id='attrs-c831f389-add6-4b83-a5f4-fe82a2375bbf' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-c831f389-add6-4b83-a5f4-fe82a2375bbf' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-49e91c4d-8482-4e2f-b693-6cc213136762' class='xr-var-data-in' type='checkbox'><label for='data-49e91c4d-8482-4e2f-b693-6cc213136762' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[21.],
       [22.],
       [22.],
       [20.],
       [21.],
       [22.],
       [22.],
       [22.],
       [22.],
       [44.],
       [52.],
       [22.],
       [65.],
       [22.],
       [58.],
       [47.],
       [21.],
       [21.],
       [21.],
       [61.],
       [21.],
       [21.],
       [64.],
       [44.],
       [22.],
       [48.],
       [21.],
       [22.],
       [21.],
       [21.]])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>batch_effects</span></div><div class='xr-var-dims'>(observations, batch_effect_dims)</div><div class='xr-var-dtype'>&lt;U11</div><div class='xr-var-preview xr-preview'>&#x27;0&#x27; &#x27;Oulu&#x27; &#x27;0&#x27; ... &#x27;0&#x27; &#x27;Oulu&#x27;</div><input id='attrs-41b4cc36-9170-4a10-a8d9-029c37233a0f' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-41b4cc36-9170-4a10-a8d9-029c37233a0f' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-d6daa2eb-20da-4c03-83f6-11fb6e191531' class='xr-var-data-in' type='checkbox'><label for='data-d6daa2eb-20da-4c03-83f6-11fb6e191531' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[&#x27;0&#x27;, &#x27;Oulu&#x27;],
       [&#x27;0&#x27;, &#x27;Oulu&#x27;],
       [&#x27;1&#x27;, &#x27;Oulu&#x27;],
       [&#x27;0&#x27;, &#x27;Oulu&#x27;],
       [&#x27;1&#x27;, &#x27;Oulu&#x27;],
       [&#x27;0&#x27;, &#x27;Oulu&#x27;],
       [&#x27;0&#x27;, &#x27;Oulu&#x27;],
       [&#x27;0&#x27;, &#x27;Oulu&#x27;],
       [&#x27;1&#x27;, &#x27;Oulu&#x27;],
       [&#x27;1&#x27;, &#x27;Milwaukee_b&#x27;],
       [&#x27;0&#x27;, &#x27;Milwaukee_b&#x27;],
       [&#x27;0&#x27;, &#x27;Oulu&#x27;],
       [&#x27;0&#x27;, &#x27;Milwaukee_b&#x27;],
       [&#x27;0&#x27;, &#x27;Oulu&#x27;],
       [&#x27;1&#x27;, &#x27;Milwaukee_b&#x27;],
       [&#x27;0&#x27;, &#x27;Milwaukee_b&#x27;],
       [&#x27;0&#x27;, &#x27;Oulu&#x27;],
       [&#x27;0&#x27;, &#x27;Oulu&#x27;],
       [&#x27;1&#x27;, &#x27;Oulu&#x27;],
       [&#x27;0&#x27;, &#x27;Milwaukee_b&#x27;],
       [&#x27;0&#x27;, &#x27;Oulu&#x27;],
       [&#x27;1&#x27;, &#x27;Oulu&#x27;],
       [&#x27;0&#x27;, &#x27;Milwaukee_b&#x27;],
       [&#x27;0&#x27;, &#x27;Milwaukee_b&#x27;],
       [&#x27;0&#x27;, &#x27;Oulu&#x27;],
       [&#x27;1&#x27;, &#x27;Milwaukee_b&#x27;],
       [&#x27;1&#x27;, &#x27;Oulu&#x27;],
       [&#x27;1&#x27;, &#x27;Oulu&#x27;],
       [&#x27;1&#x27;, &#x27;Oulu&#x27;],
       [&#x27;0&#x27;, &#x27;Oulu&#x27;]], dtype=&#x27;&lt;U11&#x27;)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>Z</span></div><div class='xr-var-dims'>(observations, response_vars)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>0.0839 -0.16 ... -0.02551 -1.124</div><input id='attrs-7aaa8dd0-0302-4ad3-9016-dbf1689df387' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-7aaa8dd0-0302-4ad3-9016-dbf1689df387' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-0c23679e-afcf-4f8d-9f46-373ffb6173e7' class='xr-var-data-in' type='checkbox'><label for='data-0c23679e-afcf-4f8d-9f46-373ffb6173e7' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[ 0.08389786],
       [-0.15999086],
       [ 0.45791906],
       [ 0.16352985],
       [-0.74862637],
       [-0.41679716],
       [-1.0254949 ],
       [-0.58100044],
       [-0.47975805],
       [-0.40142062],
       [ 1.09737349],
       [-0.124859  ],
       [ 0.01111274],
       [-0.20104168],
       [ 0.34614275],
       [-0.08671075],
       [-0.37933542],
       [ 0.15513553],
       [-0.28746615],
       [-0.57464551],
       [-0.68087051],
       [-1.53525604],
       [ 0.10659991],
       [-0.54742908],
       [ 0.84756811],
       [ 0.25872781],
       [-0.72356127],
       [ 0.06554959],
       [-0.02550754],
       [-1.12356171]])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>centiles</span></div><div class='xr-var-dims'>(centile, observations, response_vars)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>737.7 737.4 ... 1.956e+03 1.9e+03</div><input id='attrs-0a1c0703-f485-4999-9bbb-4849f2b0700d' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-0a1c0703-f485-4999-9bbb-4849f2b0700d' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-42545125-f4d9-4098-9c1c-eee7b082be71' class='xr-var-data-in' type='checkbox'><label for='data-42545125-f4d9-4098-9c1c-eee7b082be71' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[[ 737.72256132],
        [ 737.39372351],
        [ 793.47068192],
        [ 734.68050055],
        [ 793.79951973],
        [ 737.39372351],
        [ 737.39372351],
        [ 737.39372351],
        [ 793.47068192],
        [ 277.53213776],
        [-109.46705524],
        [ 737.39372351],
        [-514.43048217],
        [ 737.39372351],
        [-303.03346448],
        [ 113.70533605],
        [ 737.72256132],
        [ 737.72256132],
        [ 793.79951973],
        [-447.61956555],
...
        [2672.70423515],
        [1887.60584208],
        [4240.76815489],
        [1887.60584208],
        [3170.46664036],
        [2438.91455452],
        [1900.12307086],
        [1900.12307086],
        [1956.20002927],
        [3487.60675174],
        [1900.12307086],
        [1956.20002927],
        [4019.64601924],
        [2293.19087731],
        [1887.60584208],
        [2540.28552709],
        [1956.20002927],
        [1943.68280048],
        [1956.20002927],
        [1900.12307086]]])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>logp</span></div><div class='xr-var-dims'>(observations, response_vars)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>-0.1018 -0.1817 ... -0.1807 -1.908</div><input id='attrs-4320178d-6e03-4f8a-82f0-619ced82f280' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-4320178d-6e03-4f8a-82f0-619ced82f280' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-09c680e7-6ec4-4384-84d8-f9d3bfaad144' class='xr-var-data-in' type='checkbox'><label for='data-09c680e7-6ec4-4384-84d8-f9d3bfaad144' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[-0.1017848 ],
       [-0.18174762],
       [-0.75740663],
       [-0.11519726],
       [-0.33084695],
       [-0.42286136],
       [-1.58542515],
       [-0.65459036],
       [-0.11917345],
       [-0.79718915],
       [-1.71332458],
       [-0.16026933],
       [-1.51443361],
       [-0.21035319],
       [-1.42311537],
       [-0.87966421],
       [-0.40599755],
       [-0.09793288],
       [-0.09889165],
       [-1.51474217],
       [-0.86403942],
       [-1.83325607],
       [-1.48820892],
       [-1.21575774],
       [-0.6649963 ],
       [-0.89819613],
       [-0.30591462],
       [-0.25029067],
       [-0.18072049],
       [-1.90798866]])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>Y_harmonized</span></div><div class='xr-var-dims'>(observations, response_vars)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>1.162e+03 1.035e+03 ... 518.0</div><input id='attrs-010275b5-6e78-4895-9715-1c5632e5439b' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-010275b5-6e78-4895-9715-1c5632e5439b' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-d0d22ab3-1024-4f23-92d3-847a98ea2162' class='xr-var-data-in' type='checkbox'><label for='data-d0d22ab3-1024-4f23-92d3-847a98ea2162' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[1162.08545053],
       [1034.50382555],
       [1359.78257122],
       [1203.49545224],
       [ 717.99087577],
       [ 899.31643668],
       [ 578.8871462 ],
       [ 812.87691667],
       [ 866.17270749],
       [ 724.09500105],
       [2326.38472677],
       [1052.99786239],
       [2080.86669491],
       [1012.89394554],
       [1867.26719597],
       [ 989.53000251],
       [ 914.98226987],
       [1200.08585829],
       [ 963.98822446],
       [ 746.60930502],
       [ 754.13398302],
       [ 298.37790748],
       [2122.80196795],
       [ 605.14247091],
       [1564.90074082],
       [1319.34503278],
       [ 731.36138962],
       [1153.2323228 ],
       [1103.72517366],
       [ 517.98859191]])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>Yhat</span></div><div class='xr-var-dims'>(observations, response_vars)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>0.08675 0.07881 ... 0.1561 0.08675</div><input id='attrs-1eef8476-7ea9-465c-a65e-ca97e8972b75' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-1eef8476-7ea9-465c-a65e-ca97e8972b75' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-517a8626-3cb4-42a2-869a-405a6c615007' class='xr-var-data-in' type='checkbox'><label for='data-517a8626-3cb4-42a2-869a-405a6c615007' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[0.08675367],
       [0.07880793],
       [0.14817906],
       [0.09577404],
       [0.15612481],
       [0.07880793],
       [0.07880793],
       [0.07880793],
       [0.14817906],
       [0.07992154],
       [0.04060572],
       [0.07880793],
       [0.76002425],
       [0.07880793],
       [0.22876163],
       [0.03403855],
       [0.08675367],
       [0.08675367],
       [0.15612481],
       [0.33549235],
       [0.08675367],
       [0.15612481],
       [0.630166  ],
       [0.0105504 ],
       [0.07880793],
       [0.10555082],
       [0.15612481],
       [0.14817906],
       [0.15612481],
       [0.08675367]])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>statistics</span></div><div class='xr-var-dims'>(response_vars, statistic)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>0.07333 1.086 ... 0.847 0.988</div><input id='attrs-92ca2f01-36f2-4afc-8f80-80cb2b4be466' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-92ca2f01-36f2-4afc-8f80-80cb2b4be466' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-a22adf17-a965-4bc9-bd3c-65435696d56e' class='xr-var-data-in' type='checkbox'><label for='data-a22adf17-a965-4bc9-bd3c-65435696d56e' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[0.07333333, 1.08571816, 0.09096773, 0.75647721, 0.15299324,
        0.51969307, 0.35750293, 0.05243243, 0.84700676, 0.98795793]])</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-7c4e5a78-f549-4777-b453-b5a2090bb59f' class='xr-section-summary-in' type='checkbox'  ><label for='section-7c4e5a78-f549-4777-b453-b5a2090bb59f' class='xr-section-summary' >Indexes: <span>(6)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-index-name'><div>observations</div></div><div class='xr-index-preview'>PandasIndex</div><input type='checkbox' disabled/><label></label><input id='index-3acf50ae-d54e-40b3-9a25-358ff8618629' class='xr-index-data-in' type='checkbox'/><label for='index-3acf50ae-d54e-40b3-9a25-358ff8618629' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Index([951, 953, 915, 943, 903, 906, 959, 969, 887, 738, 705, 888, 739, 907,
       736, 717, 983, 965, 897, 724, 964, 957, 706, 711, 931, 697, 904, 973,
       908, 976],
      dtype=&#x27;int64&#x27;, name=&#x27;observations&#x27;))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>response_vars</div></div><div class='xr-index-preview'>PandasIndex</div><input type='checkbox' disabled/><label></label><input id='index-3a9d6613-f7ab-45d8-b2b9-e803ee908217' class='xr-index-data-in' type='checkbox'/><label for='index-3a9d6613-f7ab-45d8-b2b9-e803ee908217' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Index([&#x27;WM-hypointensities&#x27;], dtype=&#x27;object&#x27;, name=&#x27;response_vars&#x27;))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>covariates</div></div><div class='xr-index-preview'>PandasIndex</div><input type='checkbox' disabled/><label></label><input id='index-d4690396-32de-4a82-b868-1b45a9363335' class='xr-index-data-in' type='checkbox'/><label for='index-d4690396-32de-4a82-b868-1b45a9363335' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Index([&#x27;age&#x27;], dtype=&#x27;object&#x27;, name=&#x27;covariates&#x27;))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>batch_effect_dims</div></div><div class='xr-index-preview'>PandasIndex</div><input type='checkbox' disabled/><label></label><input id='index-ff3e14ab-c28e-4ea2-a018-eee8c9b4fdd6' class='xr-index-data-in' type='checkbox'/><label for='index-ff3e14ab-c28e-4ea2-a018-eee8c9b4fdd6' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Index([&#x27;sex&#x27;, &#x27;site&#x27;], dtype=&#x27;object&#x27;, name=&#x27;batch_effect_dims&#x27;))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>centile</div></div><div class='xr-index-preview'>PandasIndex</div><input type='checkbox' disabled/><label></label><input id='index-93faef2a-a3c2-4ecb-8e2c-05a07bbff461' class='xr-index-data-in' type='checkbox'/><label for='index-93faef2a-a3c2-4ecb-8e2c-05a07bbff461' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Index([0.05, 0.25, 0.5, 0.75, 0.95], dtype=&#x27;float64&#x27;, name=&#x27;centile&#x27;))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>statistic</div></div><div class='xr-index-preview'>PandasIndex</div><input type='checkbox' disabled/><label></label><input id='index-0faeace3-30e6-48a5-a5d2-144ee9de59b2' class='xr-index-data-in' type='checkbox'/><label for='index-0faeace3-30e6-48a5-a5d2-144ee9de59b2' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Index([&#x27;MACE&#x27;, &#x27;MAPE&#x27;, &#x27;MSLL&#x27;, &#x27;NLL&#x27;, &#x27;R2&#x27;, &#x27;RMSE&#x27;, &#x27;Rho&#x27;, &#x27;Rho_p&#x27;, &#x27;SMSE&#x27;,
       &#x27;ShapiroW&#x27;],
      dtype=&#x27;object&#x27;, name=&#x27;statistic&#x27;))</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-88181641-a4e4-43d7-a696-7c294ff54d41' class='xr-section-summary-in' type='checkbox'  checked><label for='section-88181641-a4e4-43d7-a696-7c294ff54d41' class='xr-section-summary' >Attributes: <span>(7)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'><dt><span>real_ids :</span></dt><dd>True</dd><dt><span>is_scaled :</span></dt><dd>False</dd><dt><span>name :</span></dt><dd>transfer_test</dd><dt><span>unique_batch_effects :</span></dt><dd>{&#x27;sex&#x27;: [&#x27;0&#x27;, &#x27;1&#x27;], &#x27;site&#x27;: [&#x27;Milwaukee_b&#x27;, &#x27;Oulu&#x27;]}</dd><dt><span>batch_effect_counts :</span></dt><dd>{&#x27;sex&#x27;: {&#x27;0&#x27;: 96, &#x27;1&#x27;: 52}, &#x27;site&#x27;: {&#x27;Milwaukee_b&#x27;: 46, &#x27;Oulu&#x27;: 102}}</dd><dt><span>batch_effect_covariate_ranges :</span></dt><dd>{&#x27;sex&#x27;: {&#x27;0&#x27;: {&#x27;age&#x27;: {&#x27;min&#x27;: 20.0, &#x27;max&#x27;: 65.0}}, &#x27;1&#x27;: {&#x27;age&#x27;: {&#x27;min&#x27;: 20.0, &#x27;max&#x27;: 58.0}}}, &#x27;site&#x27;: {&#x27;Milwaukee_b&#x27;: {&#x27;age&#x27;: {&#x27;min&#x27;: 44.0, &#x27;max&#x27;: 65.0}}, &#x27;Oulu&#x27;: {&#x27;age&#x27;: {&#x27;min&#x27;: 20.0, &#x27;max&#x27;: 23.0}}}}</dd><dt><span>covariate_ranges :</span></dt><dd>{&#x27;age&#x27;: {&#x27;min&#x27;: 20.0, &#x27;max&#x27;: 65.0}}</dd></dl></div></li></ul></div></div><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_centiles</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">transfered_model</span><span class="p">,</span>
    <span class="n">covariate</span><span class="o">=</span><span class="s2">&quot;age&quot;</span><span class="p">,</span>
    <span class="n">batch_effects</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
    <span class="n">scatter_data</span><span class="o">=</span><span class="n">transfer_train</span><span class="p">,</span>
    <span class="n">show_other_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">harmonize_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">show_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/03_HBR_bak_29_0.png" src="../../_images/03_HBR_bak_29_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># And extend the model to a new dataset</span>
<span class="n">extended_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">extend_predict</span><span class="p">(</span><span class="n">transfer_train</span><span class="p">,</span> <span class="n">transfer_test</span><span class="p">)</span>
</pre></div>
</div>
<style>
    :root {
        --column-width-1: 40%; /* Progress column width */
        --column-width-2: 15%; /* Chain column width */
        --column-width-3: 15%; /* Divergences column width */
        --column-width-4: 15%; /* Step Size column width */
        --column-width-5: 15%; /* Gradients/Draw column width */
    }

    .nutpie {
        max-width: 800px;
        margin: 10px auto;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        //color: #333;
        //background-color: #fff;
        padding: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border-radius: 8px;
        font-size: 14px; /* Smaller font size for a more compact look */
    }
    .nutpie table {
        width: 100%;
        border-collapse: collapse; /* Remove any extra space between borders */
    }
    .nutpie th, .nutpie td {
        padding: 8px 10px; /* Reduce padding to make table more compact */
        text-align: left;
        border-bottom: 1px solid #888;
    }
    .nutpie th {
        //background-color: #f0f0f0;
    }

    .nutpie th:nth-child(1) { width: var(--column-width-1); }
    .nutpie th:nth-child(2) { width: var(--column-width-2); }
    .nutpie th:nth-child(3) { width: var(--column-width-3); }
    .nutpie th:nth-child(4) { width: var(--column-width-4); }
    .nutpie th:nth-child(5) { width: var(--column-width-5); }

    .nutpie progress {
        width: 100%;
        height: 15px; /* Smaller progress bars */
        border-radius: 5px;
    }
    progress::-webkit-progress-bar {
        background-color: #eee;
        border-radius: 5px;
    }
    progress::-webkit-progress-value {
        background-color: #5cb85c;
        border-radius: 5px;
    }
    progress::-moz-progress-bar {
        background-color: #5cb85c;
        border-radius: 5px;
    }
    .nutpie .progress-cell {
        width: 100%;
    }

    .nutpie p strong { font-size: 16px; font-weight: bold; }

    @media (prefers-color-scheme: dark) {
        .nutpie {
            //color: #ddd;
            //background-color: #1e1e1e;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .nutpie table, .nutpie th, .nutpie td {
            border-color: #555;
            color: #ccc;
        }
        .nutpie th {
            background-color: #2a2a2a;
        }
        .nutpie progress::-webkit-progress-bar {
            background-color: #444;
        }
        .nutpie progress::-webkit-progress-value {
            background-color: #3178c6;
        }
        .nutpie progress::-moz-progress-bar {
            background-color: #3178c6;
        }
    }
</style><div class="nutpie">
    <p><strong>Sampler Progress</strong></p>
    <p>Total Chains: <span id="total-chains">4</span></p>
    <p>Active Chains: <span id="active-chains">0</span></p>
    <p>
        Finished Chains:
        <span id="active-chains">4</span>
    </p>
    <p>Sampling for 12 seconds</p>
    <p>
        Estimated Time to Completion:
        <span id="eta">now</span>
    </p>

    <progress
        id="total-progress-bar"
        max="8000"
        value="8000">
    </progress>
    <table>
        <thead>
            <tr>
                <th>Progress</th>
                <th>Draws</th>
                <th>Divergences</th>
                <th>Step Size</th>
                <th>Gradients/Draw</th>
            </tr>
        </thead>
        <tbody id="chain-details">

                <tr>
                    <td class="progress-cell">
                        <progress
                            max="2000"
                            value="2000">
                        </progress>
                    </td>
                    <td>2000</td>
                    <td>20</td>
                    <td>0.10</td>
                    <td>63</td>
                </tr>

                <tr>
                    <td class="progress-cell">
                        <progress
                            max="2000"
                            value="2000">
                        </progress>
                    </td>
                    <td>2000</td>
                    <td>16</td>
                    <td>0.12</td>
                    <td>31</td>
                </tr>

                <tr>
                    <td class="progress-cell">
                        <progress
                            max="2000"
                            value="2000">
                        </progress>
                    </td>
                    <td>2000</td>
                    <td>7</td>
                    <td>0.11</td>
                    <td>127</td>
                </tr>

                <tr>
                    <td class="progress-cell">
                        <progress
                            max="2000"
                            value="2000">
                        </progress>
                    </td>
                    <td>2000</td>
                    <td>10</td>
                    <td>0.13</td>
                    <td>95</td>
                </tr>

            </tr>
        </tbody>
    </table>
</div><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_centiles</span><span class="p">(</span>
    <span class="n">extended_model</span><span class="p">,</span>
    <span class="n">covariate</span><span class="o">=</span><span class="s2">&quot;age&quot;</span><span class="p">,</span>
    <span class="n">batch_effects</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
    <span class="n">show_other_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">harmonize_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">show_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">scatter_data</span><span class="o">=</span><span class="n">extended_model</span><span class="o">.</span><span class="n">synthesize</span><span class="p">(</span><span class="n">covariate_range_per_batch_effect</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/03_HBR_bak_31_0.png" src="../../_images/03_HBR_bak_31_0.png" />
<section id="next-steps">
<h3>Next steps<a class="headerlink" href="#next-steps" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Check out the <a class="reference external" href="runner_example.ipynb">runner example</a> to see how to
fit and evaluate a model in parallel and in K-fold cross validation on
a cluster using the runner class.</p></li>
<li><p>Check out the <a class="reference external" href="command_line_interface.ipynb">command line
interface</a> example to see how to use
the pcntoolkit from the command line.</p></li>
<li><p>Try some of the regression models down here. Just substitute the
<code class="docutils literal notranslate"><span class="pre">HBR</span></code> model with one of the other models.</p></li>
</ul>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># SHASHb model with fixed values for epsilon and delta</span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">make_prior</span><span class="p">(</span>
    <span class="n">linear</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">slope</span><span class="o">=</span><span class="n">make_prior</span><span class="p">(</span><span class="n">dist_name</span><span class="o">=</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span> <span class="n">dist_params</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)),</span>
    <span class="n">intercept</span><span class="o">=</span><span class="n">make_prior</span><span class="p">(</span>
        <span class="n">random</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">mu</span><span class="o">=</span><span class="n">make_prior</span><span class="p">(</span><span class="n">dist_name</span><span class="o">=</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span> <span class="n">dist_params</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
        <span class="n">sigma</span><span class="o">=</span><span class="n">make_prior</span><span class="p">(</span><span class="n">dist_name</span><span class="o">=</span><span class="s2">&quot;Gamma&quot;</span><span class="p">,</span> <span class="n">dist_params</span><span class="o">=</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
    <span class="p">),</span>
    <span class="n">basis_function</span><span class="o">=</span><span class="n">BsplineBasisFunction</span><span class="p">(</span><span class="n">basis_column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nknots</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">make_prior</span><span class="p">(</span>
    <span class="n">linear</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">slope</span><span class="o">=</span><span class="n">make_prior</span><span class="p">(</span><span class="n">dist_name</span><span class="o">=</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span> <span class="n">dist_params</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)),</span>
    <span class="n">intercept</span><span class="o">=</span><span class="n">make_prior</span><span class="p">(</span><span class="n">dist_name</span><span class="o">=</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span> <span class="n">dist_params</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
    <span class="n">basis_function</span><span class="o">=</span><span class="n">BsplineBasisFunction</span><span class="p">(</span><span class="n">basis_column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nknots</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">mapping</span><span class="o">=</span><span class="s2">&quot;softplus&quot;</span><span class="p">,</span>
    <span class="n">mapping_params</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">epsilon</span> <span class="o">=</span> <span class="n">make_prior</span><span class="p">(</span>
    <span class="n">dist_name</span><span class="o">=</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span>
    <span class="n">dist_params</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">delta</span> <span class="o">=</span> <span class="n">make_prior</span><span class="p">(</span>
    <span class="n">dist_name</span><span class="o">=</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span>
    <span class="n">dist_params</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
    <span class="n">mapping</span><span class="o">=</span><span class="s2">&quot;softplus&quot;</span><span class="p">,</span>
    <span class="n">mapping_params</span><span class="o">=</span><span class="p">(</span>
        <span class="mf">0.0</span><span class="p">,</span>
        <span class="mf">3.0</span><span class="p">,</span>  <span class="c1"># Scale for smoothness</span>
        <span class="mf">0.6</span><span class="p">,</span>  <span class="c1"># We need to provide a vertical shift as well, because the SHASH mapping goes a bit wild with low values for delta</span>
    <span class="p">),</span>
<span class="p">)</span>

<span class="n">shashb1_regression_model</span> <span class="o">=</span> <span class="n">HBR</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;template&quot;</span><span class="p">,</span>
    <span class="n">cores</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">progressbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">draws</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span>
    <span class="n">tune</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">nuts_sampler</span><span class="o">=</span><span class="s2">&quot;nutpie&quot;</span><span class="p">,</span>
    <span class="n">likelihood</span><span class="o">=</span><span class="n">SHASHbLikelihood</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">delta</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># SHASHb model with linear regression in epsilon and delta</span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">make_prior</span><span class="p">(</span>
    <span class="n">linear</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">slope</span><span class="o">=</span><span class="n">make_prior</span><span class="p">(</span><span class="n">dist_name</span><span class="o">=</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span> <span class="n">dist_params</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)),</span>
    <span class="n">intercept</span><span class="o">=</span><span class="n">make_prior</span><span class="p">(</span>
        <span class="n">random</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">mu</span><span class="o">=</span><span class="n">make_prior</span><span class="p">(</span><span class="n">dist_name</span><span class="o">=</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span> <span class="n">dist_params</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
        <span class="n">sigma</span><span class="o">=</span><span class="n">make_prior</span><span class="p">(</span><span class="n">dist_name</span><span class="o">=</span><span class="s2">&quot;Gamma&quot;</span><span class="p">,</span> <span class="n">dist_params</span><span class="o">=</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
    <span class="p">),</span>
    <span class="n">basis_function</span><span class="o">=</span><span class="n">BsplineBasisFunction</span><span class="p">(</span><span class="n">basis_column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nknots</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">make_prior</span><span class="p">(</span>
    <span class="n">linear</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">slope</span><span class="o">=</span><span class="n">make_prior</span><span class="p">(</span><span class="n">dist_name</span><span class="o">=</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span> <span class="n">dist_params</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)),</span>
    <span class="n">intercept</span><span class="o">=</span><span class="n">make_prior</span><span class="p">(</span><span class="n">dist_name</span><span class="o">=</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span> <span class="n">dist_params</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
    <span class="n">basis_function</span><span class="o">=</span><span class="n">BsplineBasisFunction</span><span class="p">(</span><span class="n">basis_column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nknots</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">mapping</span><span class="o">=</span><span class="s2">&quot;softplus&quot;</span><span class="p">,</span>
    <span class="n">mapping_params</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">epsilon</span> <span class="o">=</span> <span class="n">make_prior</span><span class="p">(</span>
    <span class="n">linear</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">slope</span><span class="o">=</span><span class="n">make_prior</span><span class="p">(</span><span class="n">dist_name</span><span class="o">=</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span> <span class="n">dist_params</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
    <span class="n">intercept</span><span class="o">=</span><span class="n">make_prior</span><span class="p">(</span><span class="n">dist_name</span><span class="o">=</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span> <span class="n">dist_params</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
    <span class="n">basis_function</span><span class="o">=</span><span class="n">BsplineBasisFunction</span><span class="p">(</span><span class="n">basis_column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nknots</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">delta</span> <span class="o">=</span> <span class="n">make_prior</span><span class="p">(</span>
    <span class="n">linear</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">slope</span><span class="o">=</span><span class="n">make_prior</span><span class="p">(</span><span class="n">dist_name</span><span class="o">=</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span> <span class="n">dist_params</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
    <span class="n">intercept</span><span class="o">=</span><span class="n">make_prior</span><span class="p">(</span><span class="n">dist_name</span><span class="o">=</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span> <span class="n">dist_params</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
    <span class="n">basis_function</span><span class="o">=</span><span class="n">BsplineBasisFunction</span><span class="p">(</span><span class="n">basis_column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nknots</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">mapping</span><span class="o">=</span><span class="s2">&quot;softplus&quot;</span><span class="p">,</span>
    <span class="n">mapping_params</span><span class="o">=</span><span class="p">(</span>
        <span class="mf">0.0</span><span class="p">,</span>
        <span class="mf">3.0</span><span class="p">,</span>  <span class="c1"># Scale for smoothness</span>
        <span class="mf">0.6</span><span class="p">,</span>  <span class="c1"># We need to provide a vertical shift as well, because the SHASH mapping goes a bit wild with low values for delta</span>
    <span class="p">),</span>
<span class="p">)</span>

<span class="n">shashb2_regression_model</span> <span class="o">=</span> <span class="n">HBR</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;template&quot;</span><span class="p">,</span>
    <span class="n">cores</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">progressbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">draws</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span>
    <span class="n">tune</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">nuts_sampler</span><span class="o">=</span><span class="s2">&quot;nutpie&quot;</span><span class="p">,</span>
    <span class="n">likelihood</span><span class="o">=</span><span class="n">SHASHbLikelihood</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">delta</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># BLR model</span>
<span class="n">template_blr</span> <span class="o">=</span> <span class="n">BLR</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;template&quot;</span><span class="p">,</span>
    <span class="n">n_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">tol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span>
    <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;l-bfgs-b&quot;</span><span class="p">,</span>
    <span class="n">l_bfgs_b_epsilon</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">l_bfgs_b_l</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">l_bfgs_b_norm</span><span class="o">=</span><span class="s2">&quot;l2&quot;</span><span class="p">,</span>
    <span class="n">fixed_effect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">basis_function_mean</span><span class="o">=</span><span class="n">BsplineBasisFunction</span><span class="p">(</span><span class="n">basis_column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nknots</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
    <span class="n">heteroskedastic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">basis_function_var</span><span class="o">=</span><span class="n">BsplineBasisFunction</span><span class="p">(</span><span class="n">basis_column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nknots</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
    <span class="n">fixed_effect_var</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Creating a normative model with keyword arguments only</span>
<span class="c1"># Useful for procedural model creation</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">NormativeModel</span><span class="o">.</span><span class="n">from_args</span><span class="p">(</span>
    <span class="n">alg</span><span class="o">=</span><span class="s2">&quot;hbr&quot;</span><span class="p">,</span>
    <span class="n">likelihood</span><span class="o">=</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span>
    <span class="n">linear_mu</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">random_intercept_mu</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">dist_name_sigma_intercept_mu</span><span class="o">=</span><span class="s2">&quot;Gamma&quot;</span><span class="p">,</span>
    <span class="n">dist_params_sigma_intercept_mu</span><span class="o">=</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
    <span class="n">basis_function_mu</span><span class="o">=</span><span class="s2">&quot;bspline&quot;</span><span class="p">,</span>
    <span class="n">basis_function_mu_nknots</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">basis_function_mu_left_expand</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">basis_function_mu_right_expand</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">basis_function_mu_knot_method</span><span class="o">=</span><span class="s2">&quot;uniform&quot;</span><span class="p">,</span>
    <span class="n">linear_sigma</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">mapping_sigma</span><span class="o">=</span><span class="s2">&quot;softplus&quot;</span><span class="p">,</span>
    <span class="n">mapping_params_sigma</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">),</span>
    <span class="n">random_intercept_sigma</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">dist_name_sigma_intercept_sigma</span><span class="o">=</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span>
    <span class="n">dist_params_sigma_intercept_sigma</span><span class="o">=</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
    <span class="n">mapping_sigma_intercept_sigma</span><span class="o">=</span><span class="s2">&quot;softplus&quot;</span><span class="p">,</span>
    <span class="n">draws</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span>
    <span class="n">tune</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
    <span class="n">cores</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="n">chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">nuts_sampler</span><span class="o">=</span><span class="s2">&quot;nutpie&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">template</span><span class="p">:</span> <span class="n">HBR</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">template_regression_model</span>  <span class="c1"># type: ignore</span>
<span class="nb">print</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">draws</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">tune</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">cores</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">chains</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">nuts_sampler</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2048</span>
<span class="mi">512</span>
<span class="mi">8</span>
<span class="mi">4</span>
<span class="n">nutpie</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Andre Marquand.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>