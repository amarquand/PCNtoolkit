

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Predictive Clinical Neuroscience Toolkit &mdash; Predictive Clinical Neuroscience Toolkit 0.20 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../_static/pages/css/pcntoolkit_tabs.css" />
      <link rel="stylesheet" type="text/css" href="../_static/pages/css/pcntoolkit.css" />
      <link rel="stylesheet" type="text/css" href="../_static/pages/css/pcntoolkit_nomaxwidth.css" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=0144e382"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Braincharts: transfer" href="apply_normative_models.html" />
    <link rel="prev" title="DEMO ON NORMATIVE MODELING" href="normative_modelling_walkthrough.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html">
            
              <img src="../_static/pcn-logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Background</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="pcntoolkit_background.html">PCNtoolkit Background</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Function &amp; Class Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="modindex.html">Module Index</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="normative_modelling_walkthrough.html"><strong>DEMO ON NORMATIVE MODELING</strong></a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Predictive Clinical Neuroscience Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="#hierarchical-bayesian-regression-normative-modelling-and-transfer-onto-unseen-site">Hierarchical Bayesian Regression Normative Modelling and Transfer onto unseen site.</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#created-by-saige-rutherford">Created by Saige Rutherford</a></li>
<li class="toctree-l2"><a class="reference internal" href="#adapted-edited-by-andre-marquand-and-pierre-berthet">adapted/edited by Andre Marquand and Pierre Berthet</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#step-0-install-necessary-libraries-grab-data-files">Step 0: Install necessary libraries &amp; grab data files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#step-1-prepare-training-and-testing-sets">Step 1: Prepare training and testing sets</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-2-configure-hbr-inputs-covariates-measures-and-batch-effects">Step 2: Configure HBR inputs: covariates, measures and batch effects</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-3-files-and-folders-grooming">Step 3: Files and Folders grooming</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-4-estimating-the-models">Step 4: Estimating the models</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-5-transfering-the-models-to-unseen-sites">Step 5: Transfering the models to unseen sites</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-6-interpreting-model-performance">Step 6: Interpreting model performance</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="apply_normative_models.html">Braincharts: transfer</a></li>
<li class="toctree-l1"><a class="reference internal" href="BLR_normativemodel_protocol.html">Predictive Clinical Neuroscience Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="BLR_normativemodel_protocol.html#the-normative-modeling-framework-for-computational-psychiatry-protocol">The Normative Modeling Framework for Computational Psychiatry Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="BLR_normativemodel_protocol.html#data-preparation">Data Preparation</a></li>
<li class="toctree-l1"><a class="reference internal" href="BLR_normativemodel_protocol.html#algorithm-modeling">Algorithm &amp; Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="BLR_normativemodel_protocol.html#evaluation-interpretation">Evaluation &amp; Interpretation</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualizations.html">Visualization of normative modeling outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="post_hoc_analysis.html">Post-hoc analysis on normative modeling outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="other_predictive_models.html">Load Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="other_predictive_models.html#create-train-test-splits">Create Train/Test Splits</a></li>
<li class="toctree-l1"><a class="reference internal" href="other_predictive_models.html#principal-component-regression-bbs">Principal Component Regression (BBS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="other_predictive_models.html#connectome-predictive-modelling">Connectome Predictive Modelling</a></li>
<li class="toctree-l1"><a class="reference internal" href="other_predictive_models.html#lasso-linear-regression-l1-regularization">Lasso (Linear Regression + L1 Regularization)</a></li>
<li class="toctree-l1"><a class="reference internal" href="other_predictive_models.html#ridge-linear-regression-l2-regularization">Ridge (Linear Regression + L2 Regularization)</a></li>
<li class="toctree-l1"><a class="reference internal" href="other_predictive_models.html#elastic-net-linear-regression-l1-l2-regularization">Elastic Net (Linear Regression + L1/L2 Regularization)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other Useful Stuff</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="FAQs.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="citing.html">How to cite PCNtoolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="acknowledgements.html">Acknowledgements</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Predictive Clinical Neuroscience Toolkit</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Predictive Clinical Neuroscience Toolkit</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/pages/HBR_NormativeModel_FCONdata_Tutorial.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="predictive-clinical-neuroscience-toolkit">
<h1><a class="reference external" href="https://github.com/amarquand/PCNtoolkit">Predictive Clinical Neuroscience Toolkit</a><a class="headerlink" href="#predictive-clinical-neuroscience-toolkit" title="Link to this heading"></a></h1>
</section>
<section id="hierarchical-bayesian-regression-normative-modelling-and-transfer-onto-unseen-site">
<h1>Hierarchical Bayesian Regression Normative Modelling and Transfer onto unseen site.<a class="headerlink" href="#hierarchical-bayesian-regression-normative-modelling-and-transfer-onto-unseen-site" title="Link to this heading"></a></h1>
<p>This notebook will go through basic data preparation (training and
testing set, <a class="reference external" href="https://github.com/predictive-clinical-neuroscience/PCNtoolkit-demo/blob/main/tutorials/BLR_protocol/BLR_normativemodel_protocol.ipynb">see Saige’s
tutorial</a>
on Normative Modelling for more detail), the actual training of the
models, and will finally describe how to transfer the trained models
onto unseen sites.</p>
<section id="created-by-saige-rutherford">
<h2>Created by <a class="reference external" href="https://twitter.com/being_saige">Saige Rutherford</a><a class="headerlink" href="#created-by-saige-rutherford" title="Link to this heading"></a></h2>
</section>
<section id="adapted-edited-by-andre-marquand-and-pierre-berthet">
<h2>adapted/edited by Andre Marquand and Pierre Berthet<a class="headerlink" href="#adapted-edited-by-andre-marquand-and-pierre-berthet" title="Link to this heading"></a></h2>
<section id="step-0-install-necessary-libraries-grab-data-files">
<h3>Step 0: Install necessary libraries &amp; grab data files<a class="headerlink" href="#step-0-install-necessary-libraries-grab-data-files" title="Link to this heading"></a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>pcntoolkit
<span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>nutpie
</pre></div>
</div>
<pre class="literal-block">Collecting <a class="reference external" href="https://github.com/amarquand/PCNtoolkit/archive/dev.zip">https://github.com/amarquand/PCNtoolkit/archive/dev.zip</a>
  Downloading <a class="reference external" href="https://github.com/amarquand/PCNtoolkit/archive/dev.zip">https://github.com/amarquand/PCNtoolkit/archive/dev.zip</a>
[2K     [32m[0m [32m64.9 MB[0m [31m15.9 MB/s[0m [33m0:00:05[0m
[?25h  Installing build dependencies ... [?25l[?25hdone
  Getting requirements to build wheel ... [?25l[?25hdone
  Preparing metadata (pyproject.toml) ... [?25l[?25hdone
Collecting bspline&lt;0.2.0,&gt;=0.1.1 (from pcntoolkit==0.31.0)
  Downloading bspline-0.1.1.tar.gz (84 kB)
[2K     [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m84.2/84.2 kB[0m [31m2.3 MB/s[0m eta [36m0:00:00[0m
[?25h  Preparing metadata (setup.py) ... [?25l[?25hdone
Collecting matplotlib&lt;4.0.0,&gt;=3.9.2 (from pcntoolkit==0.31.0)
  Downloading matplotlib-3.9.2-cp310-cp310-manylinux_2_17_x86_64.manylinux2014_x86_64.whl.metadata (11 kB)
Requirement already satisfied: nibabel&lt;6.0.0,&gt;=5.3.1 in /usr/local/lib/python3.10/dist-packages (from pcntoolkit==0.31.0) (5.3.2)
Requirement already satisfied: numpy&lt;2.0,&gt;=1.26 in /usr/local/lib/python3.10/dist-packages (from pcntoolkit==0.31.0) (1.26.4)
Requirement already satisfied: pymc&lt;6.0.0,&gt;=5.18.0 in /usr/local/lib/python3.10/dist-packages (from pcntoolkit==0.31.0) (5.18.0)
Requirement already satisfied: scikit-learn&lt;2.0.0,&gt;=1.5.2 in /usr/local/lib/python3.10/dist-packages (from pcntoolkit==0.31.0) (1.5.2)
Requirement already satisfied: scipy&lt;2.0,&gt;=1.12 in /usr/local/lib/python3.10/dist-packages (from pcntoolkit==0.31.0) (1.13.1)
Requirement already satisfied: seaborn&lt;0.14.0,&gt;=0.13.2 in /usr/local/lib/python3.10/dist-packages (from pcntoolkit==0.31.0) (0.13.2)
Requirement already satisfied: six&lt;2.0.0,&gt;=1.16.0 in /usr/local/lib/python3.10/dist-packages (from pcntoolkit==0.31.0) (1.16.0)
Requirement already satisfied: contourpy&gt;=1.0.1 in /usr/local/lib/python3.10/dist-packages (from matplotlib&lt;4.0.0,&gt;=3.9.2-&gt;pcntoolkit==0.31.0) (1.3.1)
Requirement already satisfied: cycler&gt;=0.10 in /usr/local/lib/python3.10/dist-packages (from matplotlib&lt;4.0.0,&gt;=3.9.2-&gt;pcntoolkit==0.31.0) (0.12.1)
Requirement already satisfied: fonttools&gt;=4.22.0 in /usr/local/lib/python3.10/dist-packages (from matplotlib&lt;4.0.0,&gt;=3.9.2-&gt;pcntoolkit==0.31.0) (4.54.1)
Requirement already satisfied: kiwisolver&gt;=1.3.1 in /usr/local/lib/python3.10/dist-packages (from matplotlib&lt;4.0.0,&gt;=3.9.2-&gt;pcntoolkit==0.31.0) (1.4.7)
Requirement already satisfied: packaging&gt;=20.0 in /usr/local/lib/python3.10/dist-packages (from matplotlib&lt;4.0.0,&gt;=3.9.2-&gt;pcntoolkit==0.31.0) (24.2)
Requirement already satisfied: pillow&gt;=8 in /usr/local/lib/python3.10/dist-packages (from matplotlib&lt;4.0.0,&gt;=3.9.2-&gt;pcntoolkit==0.31.0) (11.0.0)
Requirement already satisfied: pyparsing&gt;=2.3.1 in /usr/local/lib/python3.10/dist-packages (from matplotlib&lt;4.0.0,&gt;=3.9.2-&gt;pcntoolkit==0.31.0) (3.2.0)
Requirement already satisfied: python-dateutil&gt;=2.7 in /usr/local/lib/python3.10/dist-packages (from matplotlib&lt;4.0.0,&gt;=3.9.2-&gt;pcntoolkit==0.31.0) (2.8.2)
Requirement already satisfied: importlib-resources&gt;=5.12 in /usr/local/lib/python3.10/dist-packages (from nibabel&lt;6.0.0,&gt;=5.3.1-&gt;pcntoolkit==0.31.0) (6.4.5)
Requirement already satisfied: typing-extensions&gt;=4.6 in /usr/local/lib/python3.10/dist-packages (from nibabel&lt;6.0.0,&gt;=5.3.1-&gt;pcntoolkit==0.31.0) (4.12.2)
Requirement already satisfied: arviz&gt;=0.13.0 in /usr/local/lib/python3.10/dist-packages (from pymc&lt;6.0.0,&gt;=5.18.0-&gt;pcntoolkit==0.31.0) (0.20.0)
Requirement already satisfied: cachetools&gt;=4.2.1 in /usr/local/lib/python3.10/dist-packages (from pymc&lt;6.0.0,&gt;=5.18.0-&gt;pcntoolkit==0.31.0) (5.5.0)
Requirement already satisfied: cloudpickle in /usr/local/lib/python3.10/dist-packages (from pymc&lt;6.0.0,&gt;=5.18.0-&gt;pcntoolkit==0.31.0) (3.1.0)
Requirement already satisfied: pandas&gt;=0.24.0 in /usr/local/lib/python3.10/dist-packages (from pymc&lt;6.0.0,&gt;=5.18.0-&gt;pcntoolkit==0.31.0) (2.2.2)
Requirement already satisfied: pytensor&lt;2.26,&gt;=2.25.1 in /usr/local/lib/python3.10/dist-packages (from pymc&lt;6.0.0,&gt;=5.18.0-&gt;pcntoolkit==0.31.0) (2.25.5)
Requirement already satisfied: rich&gt;=13.7.1 in /usr/local/lib/python3.10/dist-packages (from pymc&lt;6.0.0,&gt;=5.18.0-&gt;pcntoolkit==0.31.0) (13.9.4)
Requirement already satisfied: threadpoolctl&lt;4.0.0,&gt;=3.1.0 in /usr/local/lib/python3.10/dist-packages (from pymc&lt;6.0.0,&gt;=5.18.0-&gt;pcntoolkit==0.31.0) (3.5.0)
Requirement already satisfied: joblib&gt;=1.2.0 in /usr/local/lib/python3.10/dist-packages (from scikit-learn&lt;2.0.0,&gt;=1.5.2-&gt;pcntoolkit==0.31.0) (1.4.2)
Requirement already satisfied: setuptools&gt;=60.0.0 in /usr/local/lib/python3.10/dist-packages (from arviz&gt;=0.13.0-&gt;pymc&lt;6.0.0,&gt;=5.18.0-&gt;pcntoolkit==0.31.0) (75.1.0)
Requirement already satisfied: xarray&gt;=2022.6.0 in /usr/local/lib/python3.10/dist-packages (from arviz&gt;=0.13.0-&gt;pymc&lt;6.0.0,&gt;=5.18.0-&gt;pcntoolkit==0.31.0) (2024.10.0)
Requirement already satisfied: h5netcdf&gt;=1.0.2 in /usr/local/lib/python3.10/dist-packages (from arviz&gt;=0.13.0-&gt;pymc&lt;6.0.0,&gt;=5.18.0-&gt;pcntoolkit==0.31.0) (1.4.1)
Requirement already satisfied: xarray-einstats&gt;=0.3 in /usr/local/lib/python3.10/dist-packages (from arviz&gt;=0.13.0-&gt;pymc&lt;6.0.0,&gt;=5.18.0-&gt;pcntoolkit==0.31.0) (0.8.0)
Requirement already satisfied: pytz&gt;=2020.1 in /usr/local/lib/python3.10/dist-packages (from pandas&gt;=0.24.0-&gt;pymc&lt;6.0.0,&gt;=5.18.0-&gt;pcntoolkit==0.31.0) (2024.2)
Requirement already satisfied: tzdata&gt;=2022.7 in /usr/local/lib/python3.10/dist-packages (from pandas&gt;=0.24.0-&gt;pymc&lt;6.0.0,&gt;=5.18.0-&gt;pcntoolkit==0.31.0) (2024.2)
Requirement already satisfied: filelock&gt;=3.15 in /usr/local/lib/python3.10/dist-packages (from pytensor&lt;2.26,&gt;=2.25.1-&gt;pymc&lt;6.0.0,&gt;=5.18.0-&gt;pcntoolkit==0.31.0) (3.16.1)
Requirement already satisfied: etuples in /usr/local/lib/python3.10/dist-packages (from pytensor&lt;2.26,&gt;=2.25.1-&gt;pymc&lt;6.0.0,&gt;=5.18.0-&gt;pcntoolkit==0.31.0) (0.3.9)
Requirement already satisfied: logical-unification in /usr/local/lib/python3.10/dist-packages (from pytensor&lt;2.26,&gt;=2.25.1-&gt;pymc&lt;6.0.0,&gt;=5.18.0-&gt;pcntoolkit==0.31.0) (0.4.6)
Requirement already satisfied: miniKanren in /usr/local/lib/python3.10/dist-packages (from pytensor&lt;2.26,&gt;=2.25.1-&gt;pymc&lt;6.0.0,&gt;=5.18.0-&gt;pcntoolkit==0.31.0) (1.0.3)
Requirement already satisfied: cons in /usr/local/lib/python3.10/dist-packages (from pytensor&lt;2.26,&gt;=2.25.1-&gt;pymc&lt;6.0.0,&gt;=5.18.0-&gt;pcntoolkit==0.31.0) (0.4.6)
Requirement already satisfied: markdown-it-py&gt;=2.2.0 in /usr/local/lib/python3.10/dist-packages (from rich&gt;=13.7.1-&gt;pymc&lt;6.0.0,&gt;=5.18.0-&gt;pcntoolkit==0.31.0) (3.0.0)
Requirement already satisfied: pygments&lt;3.0.0,&gt;=2.13.0 in /usr/local/lib/python3.10/dist-packages (from rich&gt;=13.7.1-&gt;pymc&lt;6.0.0,&gt;=5.18.0-&gt;pcntoolkit==0.31.0) (2.18.0)
Requirement already satisfied: h5py in /usr/local/lib/python3.10/dist-packages (from h5netcdf&gt;=1.0.2-&gt;arviz&gt;=0.13.0-&gt;pymc&lt;6.0.0,&gt;=5.18.0-&gt;pcntoolkit==0.31.0) (3.12.1)
Requirement already satisfied: mdurl~=0.1 in /usr/local/lib/python3.10/dist-packages (from markdown-it-py&gt;=2.2.0-&gt;rich&gt;=13.7.1-&gt;pymc&lt;6.0.0,&gt;=5.18.0-&gt;pcntoolkit==0.31.0) (0.1.2)
Requirement already satisfied: toolz in /usr/local/lib/python3.10/dist-packages (from logical-unification-&gt;pytensor&lt;2.26,&gt;=2.25.1-&gt;pymc&lt;6.0.0,&gt;=5.18.0-&gt;pcntoolkit==0.31.0) (0.12.1)
Requirement already satisfied: multipledispatch in /usr/local/lib/python3.10/dist-packages (from logical-unification-&gt;pytensor&lt;2.26,&gt;=2.25.1-&gt;pymc&lt;6.0.0,&gt;=5.18.0-&gt;pcntoolkit==0.31.0) (1.0.0)
Downloading matplotlib-3.9.2-cp310-cp310-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (8.3 MB)
[2K   [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m8.3/8.3 MB[0m [31m55.1 MB/s[0m eta [36m0:00:00[0m
[?25hBuilding wheels for collected packages: pcntoolkit, bspline
  Building wheel for pcntoolkit (pyproject.toml) ... [?25l[?25hdone
  Created wheel for pcntoolkit: filename=pcntoolkit-0.31.0-py3-none-any.whl size=114835 sha256=40635c10c24ccf2c319ee965aaf1038272cd5578f14d9cb3dd14598ddab31d00
  Stored in directory: /tmp/pip-ephem-wheel-cache-f502unec/wheels/9e/c4/29/3bca3a5facf8ef69b8622461d8520d24a19d3745aefa093d1e
  Building wheel for bspline (setup.py) ... [?25l[?25hdone
  Created wheel for bspline: filename=bspline-0.1.1-py3-none-any.whl size=84482 sha256=150d24f295ccda92c9789d421e52c3858d43c66874deec4a463a87b4e5533448
  Stored in directory: /root/.cache/pip/wheels/3c/ab/0a/70927853a6d9166bc777922736063a6f99c43a327c802f9326
Successfully built pcntoolkit bspline
Installing collected packages: bspline, matplotlib, pcntoolkit
  Attempting uninstall: matplotlib
    Found existing installation: matplotlib 3.8.0
    Uninstalling matplotlib-3.8.0:
      Successfully uninstalled matplotlib-3.8.0
Successfully installed bspline-0.1.1 matplotlib-3.9.2 pcntoolkit-0.31.0
Collecting nutpie
  Downloading nutpie-0.13.2-cp310-cp310-manylinux_2_28_x86_64.whl.metadata (5.4 kB)
Requirement already satisfied: pyarrow&gt;=12.0.0 in /usr/local/lib/python3.10/dist-packages (from nutpie) (17.0.0)
Requirement already satisfied: pandas&gt;=2.0 in /usr/local/lib/python3.10/dist-packages (from nutpie) (2.2.2)
Requirement already satisfied: xarray&gt;=2023.6.0 in /usr/local/lib/python3.10/dist-packages (from nutpie) (2024.10.0)
Requirement already satisfied: arviz&gt;=0.15.0 in /usr/local/lib/python3.10/dist-packages (from nutpie) (0.20.0)
Requirement already satisfied: setuptools&gt;=60.0.0 in /usr/local/lib/python3.10/dist-packages (from arviz&gt;=0.15.0-&gt;nutpie) (75.1.0)
Requirement already satisfied: matplotlib&gt;=3.5 in /usr/local/lib/python3.10/dist-packages (from arviz&gt;=0.15.0-&gt;nutpie) (3.9.2)
Requirement already satisfied: numpy&gt;=1.23.0 in /usr/local/lib/python3.10/dist-packages (from arviz&gt;=0.15.0-&gt;nutpie) (1.26.4)
Requirement already satisfied: scipy&gt;=1.9.0 in /usr/local/lib/python3.10/dist-packages (from arviz&gt;=0.15.0-&gt;nutpie) (1.13.1)
Requirement already satisfied: packaging in /usr/local/lib/python3.10/dist-packages (from arviz&gt;=0.15.0-&gt;nutpie) (24.2)
Requirement already satisfied: h5netcdf&gt;=1.0.2 in /usr/local/lib/python3.10/dist-packages (from arviz&gt;=0.15.0-&gt;nutpie) (1.4.1)
Requirement already satisfied: typing-extensions&gt;=4.1.0 in /usr/local/lib/python3.10/dist-packages (from arviz&gt;=0.15.0-&gt;nutpie) (4.12.2)
Requirement already satisfied: xarray-einstats&gt;=0.3 in /usr/local/lib/python3.10/dist-packages (from arviz&gt;=0.15.0-&gt;nutpie) (0.8.0)
Requirement already satisfied: python-dateutil&gt;=2.8.2 in /usr/local/lib/python3.10/dist-packages (from pandas&gt;=2.0-&gt;nutpie) (2.8.2)
Requirement already satisfied: pytz&gt;=2020.1 in /usr/local/lib/python3.10/dist-packages (from pandas&gt;=2.0-&gt;nutpie) (2024.2)
Requirement already satisfied: tzdata&gt;=2022.7 in /usr/local/lib/python3.10/dist-packages (from pandas&gt;=2.0-&gt;nutpie) (2024.2)
Requirement already satisfied: h5py in /usr/local/lib/python3.10/dist-packages (from h5netcdf&gt;=1.0.2-&gt;arviz&gt;=0.15.0-&gt;nutpie) (3.12.1)
Requirement already satisfied: contourpy&gt;=1.0.1 in /usr/local/lib/python3.10/dist-packages (from matplotlib&gt;=3.5-&gt;arviz&gt;=0.15.0-&gt;nutpie) (1.3.1)
Requirement already satisfied: cycler&gt;=0.10 in /usr/local/lib/python3.10/dist-packages (from matplotlib&gt;=3.5-&gt;arviz&gt;=0.15.0-&gt;nutpie) (0.12.1)
Requirement already satisfied: fonttools&gt;=4.22.0 in /usr/local/lib/python3.10/dist-packages (from matplotlib&gt;=3.5-&gt;arviz&gt;=0.15.0-&gt;nutpie) (4.54.1)
Requirement already satisfied: kiwisolver&gt;=1.3.1 in /usr/local/lib/python3.10/dist-packages (from matplotlib&gt;=3.5-&gt;arviz&gt;=0.15.0-&gt;nutpie) (1.4.7)
Requirement already satisfied: pillow&gt;=8 in /usr/local/lib/python3.10/dist-packages (from matplotlib&gt;=3.5-&gt;arviz&gt;=0.15.0-&gt;nutpie) (11.0.0)
Requirement already satisfied: pyparsing&gt;=2.3.1 in /usr/local/lib/python3.10/dist-packages (from matplotlib&gt;=3.5-&gt;arviz&gt;=0.15.0-&gt;nutpie) (3.2.0)
Requirement already satisfied: six&gt;=1.5 in /usr/local/lib/python3.10/dist-packages (from python-dateutil&gt;=2.8.2-&gt;pandas&gt;=2.0-&gt;nutpie) (1.16.0)
Downloading nutpie-0.13.2-cp310-cp310-manylinux_2_28_x86_64.whl (1.5 MB)
[2K   [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m1.5/1.5 MB[0m [31m16.5 MB/s[0m eta [36m0:00:00[0m
[?25hInstalling collected packages: nutpie
Successfully installed nutpie-0.13.2</pre>
<p>For this tutorial we will use data from the <a class="reference external" href="http://fcon_1000.projects.nitrc.org/">Functional Connectom
Project FCON1000</a> to create a
multi-site dataset.</p>
<p>The dataset contains some cortical measures (eg thickness), processed by
Freesurfer 6.0, and some covariates (eg age, site, gender).</p>
<p>First we import the required package, and create a working directory.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pcntoolkit</span> <span class="k">as</span> <span class="nn">ptk</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">processing_dir</span> <span class="o">=</span> <span class="s2">&quot;HBR_demo&quot;</span>    <span class="c1"># replace with desired working directory</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">)</span>
<span class="n">processing_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
</pre></div>
</div>
<section id="overview">
<h4>Overview<a class="headerlink" href="#overview" title="Link to this heading"></a></h4>
<p>Here we get the FCON dataset, remove the ICBM site for later transfer,
assign some site id to the different scanner sites and print an overview
of the left hemisphere mean raw cortical thickness as a function of age,
color coded by the various sites:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fcon</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;https://raw.githubusercontent.com/predictive-clinical-neuroscience/PCNtoolkit-demo/main/data/fcon1000.csv&#39;</span><span class="p">)</span>

<span class="c1"># extract the ICBM site for transfer</span>
<span class="n">icbm</span> <span class="o">=</span> <span class="n">fcon</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fcon</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ICBM&#39;</span><span class="p">]</span>
<span class="n">icbm</span><span class="p">[</span><span class="s1">&#39;sitenum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># remove from the training set (also Pittsburgh because it only has 3 samples)</span>
<span class="n">fcon</span> <span class="o">=</span> <span class="n">fcon</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fcon</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;ICBM&#39;</span><span class="p">]</span>
<span class="n">fcon</span> <span class="o">=</span> <span class="n">fcon</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fcon</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;Pittsburgh&#39;</span><span class="p">]</span>

<span class="n">sites</span> <span class="o">=</span> <span class="n">fcon</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="n">fcon</span><span class="p">[</span><span class="s1">&#39;sitenum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sites</span><span class="p">):</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">fcon</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span>
    <span class="n">fcon</span><span class="p">[</span><span class="s1">&#39;sitenum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;site&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">fcon</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">fcon</span><span class="p">[</span><span class="s1">&#39;lh_MeanThickness_thickness&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">sites</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;LH mean cortical thickness [mm]&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block">&lt;ipython-input-4-a7d14b9f2beb&gt;:5: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>
  icbm['sitenum'] = 0
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!
You are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.
A typical example is when you are setting values in a column of a DataFrame, like:

df[&quot;col&quot;][row_indexer] = value

Use <cite>df.loc[row_indexer, &quot;col&quot;] = values</cite> instead, to perform the assignment in a single step and ensure this keeps updating the original <cite>df</cite>.

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>

  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>
  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!
You are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.
A typical example is when you are setting values in a column of a DataFrame, like:

df[&quot;col&quot;][row_indexer] = value

Use <cite>df.loc[row_indexer, &quot;col&quot;] = values</cite> instead, to perform the assignment in a single step and ensure this keeps updating the original <cite>df</cite>.

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>

  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>
  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!
You are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.
A typical example is when you are setting values in a column of a DataFrame, like:

df[&quot;col&quot;][row_indexer] = value

Use <cite>df.loc[row_indexer, &quot;col&quot;] = values</cite> instead, to perform the assignment in a single step and ensure this keeps updating the original <cite>df</cite>.

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>

  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>
  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!
You are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.
A typical example is when you are setting values in a column of a DataFrame, like:

df[&quot;col&quot;][row_indexer] = value

Use <cite>df.loc[row_indexer, &quot;col&quot;] = values</cite> instead, to perform the assignment in a single step and ensure this keeps updating the original <cite>df</cite>.

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>

  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>
  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!
You are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.
A typical example is when you are setting values in a column of a DataFrame, like:

df[&quot;col&quot;][row_indexer] = value

Use <cite>df.loc[row_indexer, &quot;col&quot;] = values</cite> instead, to perform the assignment in a single step and ensure this keeps updating the original <cite>df</cite>.

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>

  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>
  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!
You are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.
A typical example is when you are setting values in a column of a DataFrame, like:

df[&quot;col&quot;][row_indexer] = value

Use <cite>df.loc[row_indexer, &quot;col&quot;] = values</cite> instead, to perform the assignment in a single step and ensure this keeps updating the original <cite>df</cite>.

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>

  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>
  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!
You are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.
A typical example is when you are setting values in a column of a DataFrame, like:

df[&quot;col&quot;][row_indexer] = value

Use <cite>df.loc[row_indexer, &quot;col&quot;] = values</cite> instead, to perform the assignment in a single step and ensure this keeps updating the original <cite>df</cite>.

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>

  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>
  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!
You are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.
A typical example is when you are setting values in a column of a DataFrame, like:

df[&quot;col&quot;][row_indexer] = value

Use <cite>df.loc[row_indexer, &quot;col&quot;] = values</cite> instead, to perform the assignment in a single step and ensure this keeps updating the original <cite>df</cite>.

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>

  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>
  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!
You are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.
A typical example is when you are setting values in a column of a DataFrame, like:

df[&quot;col&quot;][row_indexer] = value

Use <cite>df.loc[row_indexer, &quot;col&quot;] = values</cite> instead, to perform the assignment in a single step and ensure this keeps updating the original <cite>df</cite>.

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>

  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>
  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!
You are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.
A typical example is when you are setting values in a column of a DataFrame, like:

df[&quot;col&quot;][row_indexer] = value

Use <cite>df.loc[row_indexer, &quot;col&quot;] = values</cite> instead, to perform the assignment in a single step and ensure this keeps updating the original <cite>df</cite>.

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>

  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>
  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!
You are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.
A typical example is when you are setting values in a column of a DataFrame, like:

df[&quot;col&quot;][row_indexer] = value

Use <cite>df.loc[row_indexer, &quot;col&quot;] = values</cite> instead, to perform the assignment in a single step and ensure this keeps updating the original <cite>df</cite>.

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>

  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>
  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!
You are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.
A typical example is when you are setting values in a column of a DataFrame, like:

df[&quot;col&quot;][row_indexer] = value

Use <cite>df.loc[row_indexer, &quot;col&quot;] = values</cite> instead, to perform the assignment in a single step and ensure this keeps updating the original <cite>df</cite>.

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>

  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>
  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!
You are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.
A typical example is when you are setting values in a column of a DataFrame, like:

df[&quot;col&quot;][row_indexer] = value

Use <cite>df.loc[row_indexer, &quot;col&quot;] = values</cite> instead, to perform the assignment in a single step and ensure this keeps updating the original <cite>df</cite>.

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>

  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>
  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!
You are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.
A typical example is when you are setting values in a column of a DataFrame, like:

df[&quot;col&quot;][row_indexer] = value

Use <cite>df.loc[row_indexer, &quot;col&quot;] = values</cite> instead, to perform the assignment in a single step and ensure this keeps updating the original <cite>df</cite>.

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>

  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>
  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!
You are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.
A typical example is when you are setting values in a column of a DataFrame, like:

df[&quot;col&quot;][row_indexer] = value

Use <cite>df.loc[row_indexer, &quot;col&quot;] = values</cite> instead, to perform the assignment in a single step and ensure this keeps updating the original <cite>df</cite>.

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>

  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>
  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!
You are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.
A typical example is when you are setting values in a column of a DataFrame, like:

df[&quot;col&quot;][row_indexer] = value

Use <cite>df.loc[row_indexer, &quot;col&quot;] = values</cite> instead, to perform the assignment in a single step and ensure this keeps updating the original <cite>df</cite>.

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>

  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>
  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!
You are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.
A typical example is when you are setting values in a column of a DataFrame, like:

df[&quot;col&quot;][row_indexer] = value

Use <cite>df.loc[row_indexer, &quot;col&quot;] = values</cite> instead, to perform the assignment in a single step and ensure this keeps updating the original <cite>df</cite>.

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>

  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>
  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!
You are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.
A typical example is when you are setting values in a column of a DataFrame, like:

df[&quot;col&quot;][row_indexer] = value

Use <cite>df.loc[row_indexer, &quot;col&quot;] = values</cite> instead, to perform the assignment in a single step and ensure this keeps updating the original <cite>df</cite>.

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>

  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>
  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!
You are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.
A typical example is when you are setting values in a column of a DataFrame, like:

df[&quot;col&quot;][row_indexer] = value

Use <cite>df.loc[row_indexer, &quot;col&quot;] = values</cite> instead, to perform the assignment in a single step and ensure this keeps updating the original <cite>df</cite>.

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>

  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>
  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!
You are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.
A typical example is when you are setting values in a column of a DataFrame, like:

df[&quot;col&quot;][row_indexer] = value

Use <cite>df.loc[row_indexer, &quot;col&quot;] = values</cite> instead, to perform the assignment in a single step and ensure this keeps updating the original <cite>df</cite>.

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>

  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>
  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!
You are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.
A typical example is when you are setting values in a column of a DataFrame, like:

df[&quot;col&quot;][row_indexer] = value

Use <cite>df.loc[row_indexer, &quot;col&quot;] = values</cite> instead, to perform the assignment in a single step and ensure this keeps updating the original <cite>df</cite>.

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>

  fcon['sitenum'].loc[idx] = i
&lt;ipython-input-4-a7d14b9f2beb&gt;:18: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy">https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</a>
  fcon['sitenum'].loc[idx] = i</pre>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>site AnnArbor_a 24
site AnnArbor_b 32
site Atlanta 28
site Baltimore 23
site Bangor 20
site Beijing_Zang 198
site Berlin_Margulies 26
site Cambridge_Buckner 198
site Cleveland 31
site Leiden_2180 12
site Leiden_2200 19
site Milwaukee_b 46
site Munchen 15
site NewYork_a 83
site NewYork_a_ADHD 25
site Newark 19
site Oulu 102
site Oxford 22
site PaloAlto 17
site Queensland 19
site SaintLouis 31
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Text(0.5, 0, &#39;age&#39;)
</pre></div>
</div>
<img alt="../_images/HBR_NormativeModel_FCONdata_Tutorial_10_3.png" src="../_images/HBR_NormativeModel_FCONdata_Tutorial_10_3.png" />
</section>
</section>
<section id="step-1-prepare-training-and-testing-sets">
<h3>Step 1: Prepare training and testing sets<a class="headerlink" href="#step-1-prepare-training-and-testing-sets" title="Link to this heading"></a></h3>
<p>Then we randomly split half of the samples (participants) to be either
in the training or in the testing samples. We do this for the remaing
FCON dataset and for the ICBM data. The transfer function will also
require a training and a test sample.</p>
<p>The numbers of samples per sites used for training and for testing are
then displayed.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">fcon</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.5</span>
<span class="n">te</span> <span class="o">=</span> <span class="o">~</span><span class="n">tr</span>

<span class="n">fcon_tr</span> <span class="o">=</span> <span class="n">fcon</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tr</span><span class="p">]</span>
<span class="n">fcon_te</span> <span class="o">=</span> <span class="n">fcon</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">te</span><span class="p">]</span>

<span class="n">tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">icbm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.5</span>
<span class="n">te</span> <span class="o">=</span> <span class="o">~</span><span class="n">tr</span>

<span class="n">icbm_tr</span> <span class="o">=</span> <span class="n">icbm</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tr</span><span class="p">]</span>
<span class="n">icbm_te</span> <span class="o">=</span> <span class="n">icbm</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">te</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sample size check&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sites</span><span class="p">):</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">fcon_tr</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span>
    <span class="n">idxte</span> <span class="o">=</span> <span class="n">fcon_te</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">s</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span> <span class="nb">sum</span><span class="p">(</span><span class="n">idxte</span><span class="p">))</span>

<span class="n">fcon_tr</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;/fcon1000_tr.csv&#39;</span><span class="p">)</span>
<span class="n">fcon_te</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;/fcon1000_te.csv&#39;</span><span class="p">)</span>
<span class="n">icbm_tr</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;/fcon1000_icbm_tr.csv&#39;</span><span class="p">)</span>
<span class="n">icbm_te</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;/fcon1000_icbm_te.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>sample size check
0 AnnArbor_a 10 14
1 AnnArbor_b 19 13
2 Atlanta 12 16
3 Baltimore 12 11
4 Bangor 10 10
5 Beijing_Zang 91 107
6 Berlin_Margulies 9 17
7 Cambridge_Buckner 96 102
8 Cleveland 13 18
9 Leiden_2180 5 7
10 Leiden_2200 11 8
11 Milwaukee_b 18 28
12 Munchen 9 6
13 NewYork_a 38 45
14 NewYork_a_ADHD 15 10
15 Newark 9 10
16 Oulu 50 52
17 Oxford 9 13
18 PaloAlto 8 9
19 Queensland 10 9
20 SaintLouis 18 13
</pre></div>
</div>
<p>Otherwise you can just load these pre defined subsets:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Optional</span>
<span class="c1">#fcon_tr = pd.read_csv(&#39;https://raw.githubusercontent.com/predictive-clinical-neuroscience/PCNtoolkit-demo/main/data/fcon1000_tr.csv&#39;)</span>
<span class="c1">#fcon_te = pd.read_csv(&#39;https://raw.githubusercontent.com/predictive-clinical-neuroscience/PCNtoolkit-demo/main/data/fcon1000_te.csv&#39;)</span>
<span class="c1">#icbm_tr = pd.read_csv(&#39;https://raw.githubusercontent.com/predictive-clinical-neuroscience/PCNtoolkit-demo/main/data/fcon1000_icbm_tr.csv&#39;)</span>
<span class="c1">#icbm_te = pd.read_csv(&#39;https://raw.githubusercontent.com/predictive-clinical-neuroscience/PCNtoolkit-demo/main/data/fcon1000_icbm_te.csv&#39;)</span>
</pre></div>
</div>
</section>
<section id="step-2-configure-hbr-inputs-covariates-measures-and-batch-effects">
<h3>Step 2: Configure HBR inputs: covariates, measures and batch effects<a class="headerlink" href="#step-2-configure-hbr-inputs-covariates-measures-and-batch-effects" title="Link to this heading"></a></h3>
<p>We will here only use the mean cortical thickness for the Right and Left
hemisphere: two idps.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">idps</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rh_MeanThickness_thickness&#39;</span><span class="p">,</span><span class="s1">&#39;lh_MeanThickness_thickness&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>As input to the model, we need covariates (used to describe predictable
source of variability (fixed effects), here ‘age’), measures (here
cortical thickness on two idps), and batch effects (random source of
variability, here ‘scanner site’ and ‘sex’).</p>
<p><code class="docutils literal notranslate"><span class="pre">X</span></code> corresponds to the covariate(s)</p>
<p><code class="docutils literal notranslate"><span class="pre">Y</span></code> to the measure(s)</p>
<p><code class="docutils literal notranslate"><span class="pre">batch_effects</span></code> to the random effects</p>
<p>We need these values both for the training (<code class="docutils literal notranslate"><span class="pre">_train</span></code>) and for the
testing set (<code class="docutils literal notranslate"><span class="pre">_test</span></code>).</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span> <span class="o">=</span> <span class="p">(</span><span class="n">fcon_tr</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">Y_train</span> <span class="o">=</span> <span class="n">fcon_tr</span><span class="p">[</span><span class="n">idps</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="c1"># configure batch effects for site and sex</span>
<span class="c1">#batch_effects_train = fcon_tr[[&#39;sitenum&#39;,&#39;sex&#39;]].to_numpy(dtype=int)</span>

<span class="c1"># or only site</span>
<span class="n">batch_effects_train</span> <span class="o">=</span> <span class="n">fcon_tr</span><span class="p">[[</span><span class="s1">&#39;sitenum&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;X_train.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_train</span><span class="p">),</span> <span class="n">file</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;Y_train.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Y_train</span><span class="p">),</span> <span class="n">file</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;trbefile.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">batch_effects_train</span><span class="p">),</span> <span class="n">file</span><span class="p">)</span>


<span class="n">X_test</span> <span class="o">=</span> <span class="p">(</span><span class="n">fcon_te</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">Y_test</span> <span class="o">=</span> <span class="n">fcon_te</span><span class="p">[</span><span class="n">idps</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="c1">#batch_effects_test = fcon_te[[&#39;sitenum&#39;,&#39;sex&#39;]].to_numpy(dtype=int)</span>
<span class="n">batch_effects_test</span> <span class="o">=</span> <span class="n">fcon_te</span><span class="p">[[</span><span class="s1">&#39;sitenum&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;X_test.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_test</span><span class="p">),</span> <span class="n">file</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;Y_test.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Y_test</span><span class="p">),</span> <span class="n">file</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;tsbefile.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">batch_effects_test</span><span class="p">),</span> <span class="n">file</span><span class="p">)</span>

<span class="c1"># a simple function to quickly load pickle files</span>
<span class="k">def</span> <span class="nf">ldpkl</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batch_effects_test</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>array([[ 0],
       [ 0],
       [ 0],
       [ 0],
       [ 0],
       [ 0],
       [ 0],
       [ 0],
       [ 0],
       [ 0],
       [ 0],
       [ 0],
       [ 0],
       [ 0],
       [ 1],
       [ 1],
       [ 1],
       [ 1],
       [ 1],
       [ 1],
       [ 1],
       [ 1],
       [ 1],
       [ 1],
       [ 1],
       [ 1],
       [ 1],
       [ 2],
       [ 2],
       [ 2],
       [ 2],
       [ 2],
       [ 2],
       [ 2],
       [ 2],
       [ 2],
       [ 2],
       [ 2],
       [ 2],
       [ 2],
       [ 2],
       [ 2],
       [ 2],
       [ 3],
       [ 3],
       [ 3],
       [ 3],
       [ 3],
       [ 3],
       [ 3],
       [ 3],
       [ 3],
       [ 3],
       [ 3],
       [ 4],
       [ 4],
       [ 4],
       [ 4],
       [ 4],
       [ 4],
       [ 4],
       [ 4],
       [ 4],
       [ 4],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 5],
       [ 6],
       [ 6],
       [ 6],
       [ 6],
       [ 6],
       [ 6],
       [ 6],
       [ 6],
       [ 6],
       [ 6],
       [ 6],
       [ 6],
       [ 6],
       [ 6],
       [ 6],
       [ 6],
       [ 6],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 7],
       [ 8],
       [ 8],
       [ 8],
       [ 8],
       [ 8],
       [ 8],
       [ 8],
       [ 8],
       [ 8],
       [ 8],
       [ 8],
       [ 8],
       [ 8],
       [ 8],
       [ 8],
       [ 8],
       [ 8],
       [ 8],
       [ 9],
       [ 9],
       [ 9],
       [ 9],
       [ 9],
       [ 9],
       [ 9],
       [10],
       [10],
       [10],
       [10],
       [10],
       [10],
       [10],
       [10],
       [11],
       [11],
       [11],
       [11],
       [11],
       [11],
       [11],
       [11],
       [11],
       [11],
       [11],
       [11],
       [11],
       [11],
       [11],
       [11],
       [11],
       [11],
       [11],
       [11],
       [11],
       [11],
       [11],
       [11],
       [11],
       [11],
       [11],
       [11],
       [12],
       [12],
       [12],
       [12],
       [12],
       [12],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [13],
       [14],
       [14],
       [14],
       [14],
       [14],
       [14],
       [14],
       [14],
       [14],
       [14],
       [15],
       [15],
       [15],
       [15],
       [15],
       [15],
       [15],
       [15],
       [15],
       [15],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [16],
       [17],
       [17],
       [17],
       [17],
       [17],
       [17],
       [17],
       [17],
       [17],
       [17],
       [17],
       [17],
       [17],
       [18],
       [18],
       [18],
       [18],
       [18],
       [18],
       [18],
       [18],
       [18],
       [19],
       [19],
       [19],
       [19],
       [19],
       [19],
       [19],
       [19],
       [19],
       [20],
       [20],
       [20],
       [20],
       [20],
       [20],
       [20],
       [20],
       [20],
       [20],
       [20],
       [20],
       [20]])
</pre></div>
</div>
</section>
<section id="step-3-files-and-folders-grooming">
<h3>Step 3: Files and Folders grooming<a class="headerlink" href="#step-3-files-and-folders-grooming" title="Link to this heading"></a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">respfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span> <span class="s1">&#39;Y_train.pkl&#39;</span><span class="p">)</span>       <span class="c1"># measurements  (eg cortical thickness) of the training samples (columns: the various features/ROIs, rows: observations or subjects)</span>
<span class="n">covfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span> <span class="s1">&#39;X_train.pkl&#39;</span><span class="p">)</span>        <span class="c1"># covariates (eg age) the training samples (columns: covariates, rows: observations or subjects)</span>

<span class="n">testrespfile_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span> <span class="s1">&#39;Y_test.pkl&#39;</span><span class="p">)</span>       <span class="c1"># measurements  for the testing samples</span>
<span class="n">testcovfile_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span> <span class="s1">&#39;X_test.pkl&#39;</span><span class="p">)</span>        <span class="c1"># covariate file for the testing samples</span>

<span class="n">trbefile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span> <span class="s1">&#39;trbefile.pkl&#39;</span><span class="p">)</span>      <span class="c1"># training batch effects file (eg scanner_id, gender)  (columns: the various batch effects, rows: observations or subjects)</span>
<span class="n">tsbefile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span> <span class="s1">&#39;tsbefile.pkl&#39;</span><span class="p">)</span>      <span class="c1"># testing batch effects file</span>

<span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span> <span class="s1">&#39;Models/&#39;</span><span class="p">)</span>    <span class="c1">#  output path, where the models will be written</span>
<span class="n">log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span> <span class="s1">&#39;log/&#39;</span><span class="p">)</span>           <span class="c1">#</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">log_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">log_dir</span><span class="p">)</span>

<span class="n">outputsuffix</span> <span class="o">=</span> <span class="s1">&#39;_estimate&#39;</span>      <span class="c1"># a string to name the output files, of use only to you, so adapt it for your needs.</span>
</pre></div>
</div>
</section>
<section id="step-4-estimating-the-models">
<h3>Step 4: Estimating the models<a class="headerlink" href="#step-4-estimating-the-models" title="Link to this heading"></a></h3>
<p>Now we have everything ready to estimate the normative models. The
<code class="docutils literal notranslate"><span class="pre">estimate</span></code> function only needs the training and testing sets, each
divided in three datasets: covariates, measures and batch effects. We
obviously specify <code class="docutils literal notranslate"><span class="pre">alg=hbr</span></code> to use the hierarchical bayesian
regression method, well suited for the multi sites datasets. The
remaining arguments are basic data management: where the models, logs,
and output files will be written and how they will be named.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ptk</span><span class="o">.</span><span class="n">normative</span><span class="o">.</span><span class="n">estimate</span><span class="p">(</span><span class="n">covfile</span><span class="o">=</span><span class="n">covfile</span><span class="p">,</span>
                       <span class="n">respfile</span><span class="o">=</span><span class="n">respfile</span><span class="p">,</span>
                       <span class="n">tsbefile</span><span class="o">=</span><span class="n">tsbefile</span><span class="p">,</span>
                       <span class="n">trbefile</span><span class="o">=</span><span class="n">trbefile</span><span class="p">,</span>
                       <span class="n">inscaler</span><span class="o">=</span><span class="s1">&#39;standardize&#39;</span><span class="p">,</span>
                       <span class="n">outscaler</span><span class="o">=</span><span class="s1">&#39;standardize&#39;</span><span class="p">,</span>
                       <span class="n">linear_mu</span><span class="o">=</span><span class="s1">&#39;True&#39;</span><span class="p">,</span>
                       <span class="n">random_intercept_mu</span><span class="o">=</span><span class="s1">&#39;True&#39;</span><span class="p">,</span>
                       <span class="n">centered_intercept_mu</span><span class="o">=</span><span class="s1">&#39;True&#39;</span><span class="p">,</span>
                       <span class="n">alg</span><span class="o">=</span><span class="s1">&#39;hbr&#39;</span><span class="p">,</span>
                       <span class="n">log_path</span><span class="o">=</span><span class="n">log_dir</span><span class="p">,</span>
                       <span class="n">binary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span>
                       <span class="n">testcov</span><span class="o">=</span> <span class="n">testcovfile_path</span><span class="p">,</span>
                       <span class="n">testresp</span> <span class="o">=</span> <span class="n">testrespfile_path</span><span class="p">,</span>
                       <span class="n">outputsuffix</span><span class="o">=</span><span class="n">outputsuffix</span><span class="p">,</span>
                       <span class="n">savemodel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">nuts_sampler</span><span class="o">=</span><span class="s1">&#39;nutpie&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>inscaler: standardize
outscaler: standardize
Processing data in /content/HBR_demo/Y_train.pkl
Estimating model  1 of 2
</pre></div>
</div>
<style>
    :root {
        --column-width-1: 40%; /* Progress column width */
        --column-width-2: 15%; /* Chain column width */
        --column-width-3: 15%; /* Divergences column width */
        --column-width-4: 15%; /* Step Size column width */
        --column-width-5: 15%; /* Gradients/Draw column width */
    }

    .nutpie {
        max-width: 800px;
        margin: 10px auto;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        //color: #333;
        //background-color: #fff;
        padding: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border-radius: 8px;
        font-size: 14px; /* Smaller font size for a more compact look */
    }
    .nutpie table {
        width: 100%;
        border-collapse: collapse; /* Remove any extra space between borders */
    }
    .nutpie th, .nutpie td {
        padding: 8px 10px; /* Reduce padding to make table more compact */
        text-align: left;
        border-bottom: 1px solid #888;
    }
    .nutpie th {
        //background-color: #f0f0f0;
    }

    .nutpie th:nth-child(1) { width: var(--column-width-1); }
    .nutpie th:nth-child(2) { width: var(--column-width-2); }
    .nutpie th:nth-child(3) { width: var(--column-width-3); }
    .nutpie th:nth-child(4) { width: var(--column-width-4); }
    .nutpie th:nth-child(5) { width: var(--column-width-5); }

    .nutpie progress {
        width: 100%;
        height: 15px; /* Smaller progress bars */
        border-radius: 5px;
    }
    progress::-webkit-progress-bar {
        background-color: #eee;
        border-radius: 5px;
    }
    progress::-webkit-progress-value {
        background-color: #5cb85c;
        border-radius: 5px;
    }
    progress::-moz-progress-bar {
        background-color: #5cb85c;
        border-radius: 5px;
    }
    .nutpie .progress-cell {
        width: 100%;
    }

    .nutpie p strong { font-size: 16px; font-weight: bold; }

    @media (prefers-color-scheme: dark) {
        .nutpie {
            //color: #ddd;
            //background-color: #1e1e1e;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .nutpie table, .nutpie th, .nutpie td {
            border-color: #555;
            color: #ccc;
        }
        .nutpie th {
            background-color: #2a2a2a;
        }
        .nutpie progress::-webkit-progress-bar {
            background-color: #444;
        }
        .nutpie progress::-webkit-progress-value {
            background-color: #3178c6;
        }
        .nutpie progress::-moz-progress-bar {
            background-color: #3178c6;
        }
    }
</style><div class="nutpie">
    <p><strong>Sampler Progress</strong></p>
    <p>Total Chains: <span id="total-chains">1</span></p>
    <p>Active Chains: <span id="active-chains">0</span></p>
    <p>
        Finished Chains:
        <span id="active-chains">1</span>
    </p>
    <p>Sampling for now</p>
    <p>
        Estimated Time to Completion:
        <span id="eta">now</span>
    </p>

    <progress
        id="total-progress-bar"
        max="1500"
        value="1500">
    </progress>
    <table>
        <thead>
            <tr>
                <th>Progress</th>
                <th>Draws</th>
                <th>Divergences</th>
                <th>Step Size</th>
                <th>Gradients/Draw</th>
            </tr>
        </thead>
        <tbody id="chain-details">

                <tr>
                    <td class="progress-cell">
                        <progress
                            max="1500"
                            value="1500">
                        </progress>
                    </td>
                    <td>1500</td>
                    <td>0</td>
                    <td>0.34</td>
                    <td>15</td>
                </tr>

            </tr>
        </tbody>
    </table>
</div><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Output()
</pre></div>
</div>
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Output()
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Normal
</pre></div>
</div>
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Estimating model  2 of 2
</pre></div>
</div>
<style>
    :root {
        --column-width-1: 40%; /* Progress column width */
        --column-width-2: 15%; /* Chain column width */
        --column-width-3: 15%; /* Divergences column width */
        --column-width-4: 15%; /* Step Size column width */
        --column-width-5: 15%; /* Gradients/Draw column width */
    }

    .nutpie {
        max-width: 800px;
        margin: 10px auto;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        //color: #333;
        //background-color: #fff;
        padding: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border-radius: 8px;
        font-size: 14px; /* Smaller font size for a more compact look */
    }
    .nutpie table {
        width: 100%;
        border-collapse: collapse; /* Remove any extra space between borders */
    }
    .nutpie th, .nutpie td {
        padding: 8px 10px; /* Reduce padding to make table more compact */
        text-align: left;
        border-bottom: 1px solid #888;
    }
    .nutpie th {
        //background-color: #f0f0f0;
    }

    .nutpie th:nth-child(1) { width: var(--column-width-1); }
    .nutpie th:nth-child(2) { width: var(--column-width-2); }
    .nutpie th:nth-child(3) { width: var(--column-width-3); }
    .nutpie th:nth-child(4) { width: var(--column-width-4); }
    .nutpie th:nth-child(5) { width: var(--column-width-5); }

    .nutpie progress {
        width: 100%;
        height: 15px; /* Smaller progress bars */
        border-radius: 5px;
    }
    progress::-webkit-progress-bar {
        background-color: #eee;
        border-radius: 5px;
    }
    progress::-webkit-progress-value {
        background-color: #5cb85c;
        border-radius: 5px;
    }
    progress::-moz-progress-bar {
        background-color: #5cb85c;
        border-radius: 5px;
    }
    .nutpie .progress-cell {
        width: 100%;
    }

    .nutpie p strong { font-size: 16px; font-weight: bold; }

    @media (prefers-color-scheme: dark) {
        .nutpie {
            //color: #ddd;
            //background-color: #1e1e1e;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .nutpie table, .nutpie th, .nutpie td {
            border-color: #555;
            color: #ccc;
        }
        .nutpie th {
            background-color: #2a2a2a;
        }
        .nutpie progress::-webkit-progress-bar {
            background-color: #444;
        }
        .nutpie progress::-webkit-progress-value {
            background-color: #3178c6;
        }
        .nutpie progress::-moz-progress-bar {
            background-color: #3178c6;
        }
    }
</style><div class="nutpie">
    <p><strong>Sampler Progress</strong></p>
    <p>Total Chains: <span id="total-chains">1</span></p>
    <p>Active Chains: <span id="active-chains">0</span></p>
    <p>
        Finished Chains:
        <span id="active-chains">1</span>
    </p>
    <p>Sampling for now</p>
    <p>
        Estimated Time to Completion:
        <span id="eta">now</span>
    </p>

    <progress
        id="total-progress-bar"
        max="1500"
        value="1500">
    </progress>
    <table>
        <thead>
            <tr>
                <th>Progress</th>
                <th>Draws</th>
                <th>Divergences</th>
                <th>Step Size</th>
                <th>Gradients/Draw</th>
            </tr>
        </thead>
        <tbody id="chain-details">

                <tr>
                    <td class="progress-cell">
                        <progress
                            max="1500"
                            value="1500">
                        </progress>
                    </td>
                    <td>1500</td>
                    <td>0</td>
                    <td>0.33</td>
                    <td>15</td>
                </tr>

            </tr>
        </tbody>
    </table>
</div><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Output()
</pre></div>
</div>
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Normal
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Output()
</pre></div>
</div>
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Saving model meta-data...
Evaluating the model ...
Writing outputs ...
</pre></div>
</div>
<p>Here some analyses can be done, there are also some error metrics that
could be of interest. This is covered in step 6 and in <a class="reference external" href="https://github.com/predictive-clinical-neuroscience/PCNtoolkit-demo/blob/main/tutorials/BLR_protocol/BLR_normativemodel_protocol.ipynb">Saige’s
tutorial</a>
on Normative Modelling.</p>
</section>
<section id="step-5-transfering-the-models-to-unseen-sites">
<h3>Step 5: Transfering the models to unseen sites<a class="headerlink" href="#step-5-transfering-the-models-to-unseen-sites" title="Link to this heading"></a></h3>
<p>Similarly to what was done before for the FCON data, we also need to
prepare the ICBM specific data, in order to run the transfer function:
training and testing set of covariates, measures and batch effects:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_adapt</span> <span class="o">=</span> <span class="p">(</span><span class="n">icbm_tr</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">Y_adapt</span> <span class="o">=</span> <span class="n">icbm_tr</span><span class="p">[</span><span class="n">idps</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="c1">#batch_effects_adapt = icbm_tr[[&#39;sitenum&#39;,&#39;sex&#39;]].to_numpy(dtype=int)</span>
<span class="n">batch_effects_adapt</span> <span class="o">=</span> <span class="n">icbm_tr</span><span class="p">[[</span><span class="s1">&#39;sitenum&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;X_adaptation.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_adapt</span><span class="p">),</span> <span class="n">file</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;Y_adaptation.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Y_adapt</span><span class="p">),</span> <span class="n">file</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;adbefile.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">batch_effects_adapt</span><span class="p">),</span> <span class="n">file</span><span class="p">)</span>

<span class="c1"># Test data (new dataset)</span>
<span class="n">X_test_txfr</span> <span class="o">=</span> <span class="p">(</span><span class="n">icbm_te</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">Y_test_txfr</span> <span class="o">=</span> <span class="n">icbm_te</span><span class="p">[</span><span class="n">idps</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="c1">#batch_effects_test_txfr = icbm_te[[&#39;sitenum&#39;,&#39;sex&#39;]].to_numpy(dtype=int)</span>
<span class="n">batch_effects_test_txfr</span> <span class="o">=</span> <span class="n">icbm_te</span><span class="p">[[</span><span class="s1">&#39;sitenum&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;X_test_txfr.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_test_txfr</span><span class="p">),</span> <span class="n">file</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;Y_test_txfr.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Y_test_txfr</span><span class="p">),</span> <span class="n">file</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;txbefile.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">batch_effects_test_txfr</span><span class="p">),</span> <span class="n">file</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">respfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span> <span class="s1">&#39;Y_adaptation.pkl&#39;</span><span class="p">)</span>
<span class="n">covfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span> <span class="s1">&#39;X_adaptation.pkl&#39;</span><span class="p">)</span>
<span class="n">testrespfile_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span> <span class="s1">&#39;Y_test_txfr.pkl&#39;</span><span class="p">)</span>
<span class="n">testcovfile_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span> <span class="s1">&#39;X_test_txfr.pkl&#39;</span><span class="p">)</span>
<span class="n">trbefile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span> <span class="s1">&#39;adbefile.pkl&#39;</span><span class="p">)</span>
<span class="n">tsbefile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span> <span class="s1">&#39;txbefile.pkl&#39;</span><span class="p">)</span>

<span class="n">log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span> <span class="s1">&#39;log_transfer/&#39;</span><span class="p">)</span>
<span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span> <span class="s1">&#39;Transfer/&#39;</span><span class="p">)</span>
<span class="n">model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span> <span class="s1">&#39;Models/&#39;</span><span class="p">)</span>  <span class="c1"># path to the previously trained models</span>
<span class="n">outputsuffix</span> <span class="o">=</span> <span class="s1">&#39;_transfer&#39;</span>  <span class="c1"># suffix added to the output files from the transfer function</span>
</pre></div>
</div>
<p>Here, the difference is that the transfer function needs a model path,
which points to the models we just trained, and new site data (training
and testing). That is basically the only difference.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">yhat</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">z_scores</span> <span class="o">=</span> <span class="n">ptk</span><span class="o">.</span><span class="n">normative</span><span class="o">.</span><span class="n">transfer</span><span class="p">(</span><span class="n">covfile</span><span class="o">=</span><span class="n">covfile</span><span class="p">,</span>
                                            <span class="n">respfile</span><span class="o">=</span><span class="n">respfile</span><span class="p">,</span>
                                            <span class="n">tsbefile</span><span class="o">=</span><span class="n">tsbefile</span><span class="p">,</span>
                                            <span class="n">trbefile</span><span class="o">=</span><span class="n">trbefile</span><span class="p">,</span>
                                            <span class="n">inscaler</span><span class="o">=</span><span class="s1">&#39;standardize&#39;</span><span class="p">,</span>
                                            <span class="n">outscaler</span><span class="o">=</span><span class="s1">&#39;standardize&#39;</span><span class="p">,</span>
                                            <span class="n">linear_mu</span><span class="o">=</span><span class="s1">&#39;True&#39;</span><span class="p">,</span>
                                            <span class="n">random_intercept_mu</span><span class="o">=</span><span class="s1">&#39;True&#39;</span><span class="p">,</span>
                                            <span class="n">centered_intercept_mu</span><span class="o">=</span><span class="s1">&#39;True&#39;</span><span class="p">,</span>
                                            <span class="n">model_path</span> <span class="o">=</span> <span class="n">model_path</span><span class="p">,</span>
                                            <span class="n">alg</span><span class="o">=</span><span class="s1">&#39;hbr&#39;</span><span class="p">,</span>
                                            <span class="n">log_path</span><span class="o">=</span><span class="n">log_dir</span><span class="p">,</span>
                                            <span class="n">binary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                            <span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span>
                                            <span class="n">testcov</span><span class="o">=</span> <span class="n">testcovfile_path</span><span class="p">,</span>
                                            <span class="n">testresp</span> <span class="o">=</span> <span class="n">testrespfile_path</span><span class="p">,</span>
                                            <span class="n">outputsuffix</span><span class="o">=</span><span class="n">outputsuffix</span><span class="p">,</span>
                                            <span class="n">savemodel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                            <span class="n">nuts_sampler</span><span class="o">=</span><span class="s1">&#39;nutpie&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Loading data ...
Using HBR transform...
Transferring model  1 of 2
</pre></div>
</div>
<style>
    :root {
        --column-width-1: 40%; /* Progress column width */
        --column-width-2: 15%; /* Chain column width */
        --column-width-3: 15%; /* Divergences column width */
        --column-width-4: 15%; /* Step Size column width */
        --column-width-5: 15%; /* Gradients/Draw column width */
    }

    .nutpie {
        max-width: 800px;
        margin: 10px auto;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        //color: #333;
        //background-color: #fff;
        padding: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border-radius: 8px;
        font-size: 14px; /* Smaller font size for a more compact look */
    }
    .nutpie table {
        width: 100%;
        border-collapse: collapse; /* Remove any extra space between borders */
    }
    .nutpie th, .nutpie td {
        padding: 8px 10px; /* Reduce padding to make table more compact */
        text-align: left;
        border-bottom: 1px solid #888;
    }
    .nutpie th {
        //background-color: #f0f0f0;
    }

    .nutpie th:nth-child(1) { width: var(--column-width-1); }
    .nutpie th:nth-child(2) { width: var(--column-width-2); }
    .nutpie th:nth-child(3) { width: var(--column-width-3); }
    .nutpie th:nth-child(4) { width: var(--column-width-4); }
    .nutpie th:nth-child(5) { width: var(--column-width-5); }

    .nutpie progress {
        width: 100%;
        height: 15px; /* Smaller progress bars */
        border-radius: 5px;
    }
    progress::-webkit-progress-bar {
        background-color: #eee;
        border-radius: 5px;
    }
    progress::-webkit-progress-value {
        background-color: #5cb85c;
        border-radius: 5px;
    }
    progress::-moz-progress-bar {
        background-color: #5cb85c;
        border-radius: 5px;
    }
    .nutpie .progress-cell {
        width: 100%;
    }

    .nutpie p strong { font-size: 16px; font-weight: bold; }

    @media (prefers-color-scheme: dark) {
        .nutpie {
            //color: #ddd;
            //background-color: #1e1e1e;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .nutpie table, .nutpie th, .nutpie td {
            border-color: #555;
            color: #ccc;
        }
        .nutpie th {
            background-color: #2a2a2a;
        }
        .nutpie progress::-webkit-progress-bar {
            background-color: #444;
        }
        .nutpie progress::-webkit-progress-value {
            background-color: #3178c6;
        }
        .nutpie progress::-moz-progress-bar {
            background-color: #3178c6;
        }
    }
</style><div class="nutpie">
    <p><strong>Sampler Progress</strong></p>
    <p>Total Chains: <span id="total-chains">1</span></p>
    <p>Active Chains: <span id="active-chains">0</span></p>
    <p>
        Finished Chains:
        <span id="active-chains">1</span>
    </p>
    <p>Sampling for now</p>
    <p>
        Estimated Time to Completion:
        <span id="eta">now</span>
    </p>

    <progress
        id="total-progress-bar"
        max="1500"
        value="1500">
    </progress>
    <table>
        <thead>
            <tr>
                <th>Progress</th>
                <th>Draws</th>
                <th>Divergences</th>
                <th>Step Size</th>
                <th>Gradients/Draw</th>
            </tr>
        </thead>
        <tbody id="chain-details">

                <tr>
                    <td class="progress-cell">
                        <progress
                            max="1500"
                            value="1500">
                        </progress>
                    </td>
                    <td>1500</td>
                    <td>2</td>
                    <td>0.47</td>
                    <td>7</td>
                </tr>

            </tr>
        </tbody>
    </table>
</div><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Output()
</pre></div>
</div>
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Using HBR transform...
Transferring model  2 of 2
</pre></div>
</div>
<style>
    :root {
        --column-width-1: 40%; /* Progress column width */
        --column-width-2: 15%; /* Chain column width */
        --column-width-3: 15%; /* Divergences column width */
        --column-width-4: 15%; /* Step Size column width */
        --column-width-5: 15%; /* Gradients/Draw column width */
    }

    .nutpie {
        max-width: 800px;
        margin: 10px auto;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        //color: #333;
        //background-color: #fff;
        padding: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border-radius: 8px;
        font-size: 14px; /* Smaller font size for a more compact look */
    }
    .nutpie table {
        width: 100%;
        border-collapse: collapse; /* Remove any extra space between borders */
    }
    .nutpie th, .nutpie td {
        padding: 8px 10px; /* Reduce padding to make table more compact */
        text-align: left;
        border-bottom: 1px solid #888;
    }
    .nutpie th {
        //background-color: #f0f0f0;
    }

    .nutpie th:nth-child(1) { width: var(--column-width-1); }
    .nutpie th:nth-child(2) { width: var(--column-width-2); }
    .nutpie th:nth-child(3) { width: var(--column-width-3); }
    .nutpie th:nth-child(4) { width: var(--column-width-4); }
    .nutpie th:nth-child(5) { width: var(--column-width-5); }

    .nutpie progress {
        width: 100%;
        height: 15px; /* Smaller progress bars */
        border-radius: 5px;
    }
    progress::-webkit-progress-bar {
        background-color: #eee;
        border-radius: 5px;
    }
    progress::-webkit-progress-value {
        background-color: #5cb85c;
        border-radius: 5px;
    }
    progress::-moz-progress-bar {
        background-color: #5cb85c;
        border-radius: 5px;
    }
    .nutpie .progress-cell {
        width: 100%;
    }

    .nutpie p strong { font-size: 16px; font-weight: bold; }

    @media (prefers-color-scheme: dark) {
        .nutpie {
            //color: #ddd;
            //background-color: #1e1e1e;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .nutpie table, .nutpie th, .nutpie td {
            border-color: #555;
            color: #ccc;
        }
        .nutpie th {
            background-color: #2a2a2a;
        }
        .nutpie progress::-webkit-progress-bar {
            background-color: #444;
        }
        .nutpie progress::-webkit-progress-value {
            background-color: #3178c6;
        }
        .nutpie progress::-moz-progress-bar {
            background-color: #3178c6;
        }
    }
</style><div class="nutpie">
    <p><strong>Sampler Progress</strong></p>
    <p>Total Chains: <span id="total-chains">1</span></p>
    <p>Active Chains: <span id="active-chains">0</span></p>
    <p>
        Finished Chains:
        <span id="active-chains">1</span>
    </p>
    <p>Sampling for now</p>
    <p>
        Estimated Time to Completion:
        <span id="eta">now</span>
    </p>

    <progress
        id="total-progress-bar"
        max="1500"
        value="1500">
    </progress>
    <table>
        <thead>
            <tr>
                <th>Progress</th>
                <th>Draws</th>
                <th>Divergences</th>
                <th>Step Size</th>
                <th>Gradients/Draw</th>
            </tr>
        </thead>
        <tbody id="chain-details">

                <tr>
                    <td class="progress-cell">
                        <progress
                            max="1500"
                            value="1500">
                        </progress>
                    </td>
                    <td>1500</td>
                    <td>1</td>
                    <td>0.40</td>
                    <td>15</td>
                </tr>

            </tr>
        </tbody>
    </table>
</div><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Output()
</pre></div>
</div>
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Evaluating the model ...
Writing outputs ...
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output_path</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&#39;/content/HBR_demo/Transfer/&#39;
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">EV</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;EXPV_estimate.pkl&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">EV</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>          0
0  0.438215
1  0.439181
</pre></div>
</div>
<p>And that is it, you now have models that benefited from prior knowledge
about different scanner sites to learn on unseen sites.</p>
</section>
<section id="step-6-interpreting-model-performance">
<h3>Step 6: Interpreting model performance<a class="headerlink" href="#step-6-interpreting-model-performance" title="Link to this heading"></a></h3>
<p>Output evaluation metrics definitions: * yhat - predictive mean * ys2
- predictive variance * nm - normative model * Z - deviance scores *
Rho - Pearson correlation between true and predicted responses * pRho -
parametric p-value for this correlation * RMSE - root mean squared
error between true/predicted responses * SMSE - standardised mean
squared error * EV - explained variance * MSLL - mean standardized log
loss * See page 23 in
<a class="reference external" href="http://www.gaussianprocess.org/gpml/chapters/RW2.pdf">http://www.gaussianprocess.org/gpml/chapters/RW2.pdf</a></p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="normative_modelling_walkthrough.html" class="btn btn-neutral float-left" title="DEMO ON NORMATIVE MODELING" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="apply_normative_models.html" class="btn btn-neutral float-right" title="Braincharts: transfer" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Andre F. Marquand.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>