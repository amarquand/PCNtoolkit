

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Predictive Clinical Neuroscience Toolkit &mdash; Predictive Clinical Neuroscience Toolkit 0.20 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b76e3c8a" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=fd3f3429" />
      <link rel="stylesheet" type="text/css" href="../_static/pages/css/pcntoolkit_tabs.css" />
      <link rel="stylesheet" type="text/css" href="../_static/pages/css/pcntoolkit.css" />
      <link rel="stylesheet" type="text/css" href="../_static/pages/css/pcntoolkit_nomaxwidth.css" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=0144e382"></script>
      <script src="../_static/doctools.js?v=9a2dae69"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Using lifespan models to make predictions on new data" href="apply_normative_models.html" />
    <link rel="prev" title="DEMO ON NORMATIVE MODELING" href="normative_modelling_walkthrough.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html">
            
              <img src="../_static/pcn-logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Background</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="pcntoolkit_background.html">PCNtoolkit Background</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Function &amp; Class Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="modindex.html">Module Index</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="normative_modelling_walkthrough.html"><strong>DEMO ON NORMATIVE MODELING</strong></a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Predictive Clinical Neuroscience Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="#hierarchical-bayesian-regression-normative-modelling-and-transfer-onto-unseen-site">Hierarchical Bayesian Regression Normative Modelling and Transfer onto unseen site.</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#created-by-saige-rutherford">Created by Saige Rutherford</a></li>
<li class="toctree-l2"><a class="reference internal" href="#adapted-edited-by-andre-marquand-and-pierre-berthet">adapted/edited by Andre Marquand and Pierre Berthet</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#step-0-install-necessary-libraries-grab-data-files">Step 0: Install necessary libraries &amp; grab data files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#step-1-prepare-training-and-testing-sets">Step 1: Prepare training and testing sets</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-2-configure-hbr-inputs-covariates-measures-and-batch-effects">Step 2: Configure HBR inputs: covariates, measures and batch effects</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-3-files-and-folders-grooming">Step 3: Files and Folders grooming</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-4-estimating-the-models">Step 4: Estimating the models</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-5-transfering-the-models-to-unseen-sites">Step 5: Transfering the models to unseen sites</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-6-interpreting-model-performance">Step 6: Interpreting model performance</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="apply_normative_models.html">Using lifespan models to make predictions on new data</a></li>
<li class="toctree-l1"><a class="reference internal" href="BLR_normativemodel_protocol.html">Predictive Clinical Neuroscience Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="BLR_normativemodel_protocol.html#the-normative-modeling-framework-for-computational-psychiatry-protocol">The Normative Modeling Framework for Computational Psychiatry Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="BLR_normativemodel_protocol.html#data-preparation">Data Preparation</a></li>
<li class="toctree-l1"><a class="reference internal" href="BLR_normativemodel_protocol.html#algorithm-modeling">Algorithm &amp; Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="BLR_normativemodel_protocol.html#evaluation-interpretation">Evaluation &amp; Interpretation</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualizations.html">Visualization of normative modeling outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="post_hoc_analysis.html">Post-hoc analysis on normative modeling outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="other_predictive_models.html">Load Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="other_predictive_models.html#create-train-test-splits">Create Train/Test Splits</a></li>
<li class="toctree-l1"><a class="reference internal" href="other_predictive_models.html#principal-component-regression-bbs">Principal Component Regression (BBS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="other_predictive_models.html#connectome-predictive-modelling">Connectome Predictive Modelling</a></li>
<li class="toctree-l1"><a class="reference internal" href="other_predictive_models.html#lasso-linear-regression-l1-regularization">Lasso (Linear Regression + L1 Regularization)</a></li>
<li class="toctree-l1"><a class="reference internal" href="other_predictive_models.html#ridge-linear-regression-l2-regularization">Ridge (Linear Regression + L2 Regularization)</a></li>
<li class="toctree-l1"><a class="reference internal" href="other_predictive_models.html#elastic-net-linear-regression-l1-l2-regularization">Elastic Net (Linear Regression + L1/L2 Regularization)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other Useful Stuff</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="FAQs.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="citing.html">How to cite PCNtoolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="acknowledgements.html">Acknowledgements</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Predictive Clinical Neuroscience Toolkit</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Predictive Clinical Neuroscience Toolkit</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/pages/HBR_NormativeModel_FCONdata_Tutorial.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="predictive-clinical-neuroscience-toolkit">
<h1><a class="reference external" href="https://github.com/amarquand/PCNtoolkit">Predictive Clinical Neuroscience Toolkit</a><a class="headerlink" href="#predictive-clinical-neuroscience-toolkit" title="Link to this heading"></a></h1>
</section>
<section id="hierarchical-bayesian-regression-normative-modelling-and-transfer-onto-unseen-site">
<h1>Hierarchical Bayesian Regression Normative Modelling and Transfer onto unseen site.<a class="headerlink" href="#hierarchical-bayesian-regression-normative-modelling-and-transfer-onto-unseen-site" title="Link to this heading"></a></h1>
<p>This notebook will go through basic data preparation (training and
testing set, <a class="reference external" href="https://github.com/predictive-clinical-neuroscience/PCNtoolkit-demo/blob/main/tutorials/BLR_protocol/BLR_normativemodel_protocol.ipynb">see Saige’s
tutorial</a>
on Normative Modelling for more detail), the actual training of the
models, and will finally describe how to transfer the trained models
onto unseen sites.</p>
<section id="created-by-saige-rutherford">
<h2>Created by <a class="reference external" href="https://twitter.com/being_saige">Saige Rutherford</a><a class="headerlink" href="#created-by-saige-rutherford" title="Link to this heading"></a></h2>
</section>
<section id="adapted-edited-by-andre-marquand-and-pierre-berthet">
<h2>adapted/edited by Andre Marquand and Pierre Berthet<a class="headerlink" href="#adapted-edited-by-andre-marquand-and-pierre-berthet" title="Link to this heading"></a></h2>
<section id="step-0-install-necessary-libraries-grab-data-files">
<h3>Step 0: Install necessary libraries &amp; grab data files<a class="headerlink" href="#step-0-install-necessary-libraries-grab-data-files" title="Link to this heading"></a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>pcntoolkit
</pre></div>
</div>
<p>For this tutorial we will use data from the <a class="reference external" href="http://fcon_1000.projects.nitrc.org/">Functional Connectom
Project FCON1000</a> to create a
multi-site dataset.</p>
<p>The dataset contains some cortical measures (eg thickness), processed by
Freesurfer 6.0, and some covariates (eg age, site, gender).</p>
<p>First we import the required package, and create a working directory.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pcntoolkit</span> <span class="k">as</span> <span class="nn">ptk</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">processing_dir</span> <span class="o">=</span> <span class="s2">&quot;HBR_demo&quot;</span>  <span class="c1"># replace with desired working directory</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">)</span>
<span class="n">processing_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
</pre></div>
</div>
<section id="overview">
<h4>Overview<a class="headerlink" href="#overview" title="Link to this heading"></a></h4>
<p>Here we get the FCON dataset, remove the ICBM site for later transfer,
assign some site id to the different scanner sites and print an overview
of the left hemisphere mean raw cortical thickness as a function of age,
color coded by the various sites:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fcon</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s2">&quot;https://raw.githubusercontent.com/predictive-clinical-neuroscience/PCNtoolkit-demo/main/data/fcon1000.csv&quot;</span>
<span class="p">)</span>

<span class="c1"># extract the ICBM site for transfer</span>
<span class="n">icbm</span> <span class="o">=</span> <span class="n">fcon</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fcon</span><span class="p">[</span><span class="s2">&quot;site&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ICBM&quot;</span><span class="p">]</span>
<span class="n">icbm</span><span class="p">[</span><span class="s2">&quot;sitenum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># remove from the training set (also Pittsburgh because it only has 3 samples)</span>
<span class="n">fcon</span> <span class="o">=</span> <span class="n">fcon</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fcon</span><span class="p">[</span><span class="s2">&quot;site&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;ICBM&quot;</span><span class="p">]</span>
<span class="n">fcon</span> <span class="o">=</span> <span class="n">fcon</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fcon</span><span class="p">[</span><span class="s2">&quot;site&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;Pittsburgh&quot;</span><span class="p">]</span>

<span class="n">sites</span> <span class="o">=</span> <span class="n">fcon</span><span class="p">[</span><span class="s2">&quot;site&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="n">fcon</span><span class="p">[</span><span class="s2">&quot;sitenum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sites</span><span class="p">):</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">fcon</span><span class="p">[</span><span class="s2">&quot;site&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span>
    <span class="n">fcon</span><span class="p">[</span><span class="s2">&quot;sitenum&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;site&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">fcon</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">fcon</span><span class="p">[</span><span class="s2">&quot;lh_MeanThickness_thickness&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">sites</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;LH mean cortical thickness [mm]&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;age&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="step-1-prepare-training-and-testing-sets">
<h3>Step 1: Prepare training and testing sets<a class="headerlink" href="#step-1-prepare-training-and-testing-sets" title="Link to this heading"></a></h3>
<p>Then we randomly split half of the samples (participants) to be either
in the training or in the testing samples. We do this for the remaing
FCON dataset and for the ICBM data. The transfer function will also
require a training and a test sample.</p>
<p>The numbers of samples per sites used for training and for testing are
then displayed.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">fcon</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.5</span>
<span class="n">te</span> <span class="o">=</span> <span class="o">~</span><span class="n">tr</span>

<span class="n">fcon_tr</span> <span class="o">=</span> <span class="n">fcon</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tr</span><span class="p">]</span>
<span class="n">fcon_te</span> <span class="o">=</span> <span class="n">fcon</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">te</span><span class="p">]</span>

<span class="n">tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">icbm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.5</span>
<span class="n">te</span> <span class="o">=</span> <span class="o">~</span><span class="n">tr</span>

<span class="n">icbm_tr</span> <span class="o">=</span> <span class="n">icbm</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tr</span><span class="p">]</span>
<span class="n">icbm_te</span> <span class="o">=</span> <span class="n">icbm</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">te</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sample size check&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sites</span><span class="p">):</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">fcon_tr</span><span class="p">[</span><span class="s2">&quot;site&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span>
    <span class="n">idxte</span> <span class="o">=</span> <span class="n">fcon_te</span><span class="p">[</span><span class="s2">&quot;site&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span> <span class="nb">sum</span><span class="p">(</span><span class="n">idxte</span><span class="p">))</span>

<span class="n">fcon_tr</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="s2">&quot;/fcon1000_tr.csv&quot;</span><span class="p">)</span>
<span class="n">fcon_te</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="s2">&quot;/fcon1000_te.csv&quot;</span><span class="p">)</span>
<span class="n">icbm_tr</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="s2">&quot;/fcon1000_icbm_tr.csv&quot;</span><span class="p">)</span>
<span class="n">icbm_te</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="s2">&quot;/fcon1000_icbm_te.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Otherwise you can just load these pre defined subsets:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Optional</span>
<span class="c1"># fcon_tr = pd.read_csv(&#39;https://raw.githubusercontent.com/predictive-clinical-neuroscience/PCNtoolkit-demo/main/data/fcon1000_tr.csv&#39;)</span>
<span class="c1"># fcon_te = pd.read_csv(&#39;https://raw.githubusercontent.com/predictive-clinical-neuroscience/PCNtoolkit-demo/main/data/fcon1000_te.csv&#39;)</span>
<span class="c1"># icbm_tr = pd.read_csv(&#39;https://raw.githubusercontent.com/predictive-clinical-neuroscience/PCNtoolkit-demo/main/data/fcon1000_icbm_tr.csv&#39;)</span>
<span class="c1"># icbm_te = pd.read_csv(&#39;https://raw.githubusercontent.com/predictive-clinical-neuroscience/PCNtoolkit-demo/main/data/fcon1000_icbm_te.csv&#39;)</span>
</pre></div>
</div>
</section>
<section id="step-2-configure-hbr-inputs-covariates-measures-and-batch-effects">
<h3>Step 2: Configure HBR inputs: covariates, measures and batch effects<a class="headerlink" href="#step-2-configure-hbr-inputs-covariates-measures-and-batch-effects" title="Link to this heading"></a></h3>
<p>We will here only use the mean cortical thickness for the Right and Left
hemisphere: two idps.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">idps</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;rh_MeanThickness_thickness&quot;</span><span class="p">,</span> <span class="s2">&quot;lh_MeanThickness_thickness&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>As input to the model, we need covariates (used to describe predictable
source of variability (fixed effects), here ‘age’), measures (here
cortical thickness on two idps), and batch effects (random source of
variability, here ‘scanner site’ and ‘sex’).</p>
<p><code class="docutils literal notranslate"><span class="pre">X</span></code> corresponds to the covariate(s)</p>
<p><code class="docutils literal notranslate"><span class="pre">Y</span></code> to the measure(s)</p>
<p><code class="docutils literal notranslate"><span class="pre">batch_effects</span></code> to the random effects</p>
<p>We need these values both for the training (<code class="docutils literal notranslate"><span class="pre">_train</span></code>) and for the
testing set (<code class="docutils literal notranslate"><span class="pre">_test</span></code>).</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span> <span class="o">=</span> <span class="p">(</span><span class="n">fcon_tr</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">Y_train</span> <span class="o">=</span> <span class="n">fcon_tr</span><span class="p">[</span><span class="n">idps</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="c1"># configure batch effects for site and sex</span>
<span class="c1"># batch_effects_train = fcon_tr[[&#39;sitenum&#39;,&#39;sex&#39;]].to_numpy(dtype=int)</span>

<span class="c1"># or only site</span>
<span class="n">batch_effects_train</span> <span class="o">=</span> <span class="n">fcon_tr</span><span class="p">[[</span><span class="s2">&quot;sitenum&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;X_train.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_train</span><span class="p">),</span> <span class="n">file</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;Y_train.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Y_train</span><span class="p">),</span> <span class="n">file</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;trbefile.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">batch_effects_train</span><span class="p">),</span> <span class="n">file</span><span class="p">)</span>


<span class="n">X_test</span> <span class="o">=</span> <span class="p">(</span><span class="n">fcon_te</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">Y_test</span> <span class="o">=</span> <span class="n">fcon_te</span><span class="p">[</span><span class="n">idps</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="c1"># batch_effects_test = fcon_te[[&#39;sitenum&#39;,&#39;sex&#39;]].to_numpy(dtype=int)</span>
<span class="n">batch_effects_test</span> <span class="o">=</span> <span class="n">fcon_te</span><span class="p">[[</span><span class="s2">&quot;sitenum&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;X_test.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_test</span><span class="p">),</span> <span class="n">file</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;Y_test.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Y_test</span><span class="p">),</span> <span class="n">file</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;tsbefile.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">batch_effects_test</span><span class="p">),</span> <span class="n">file</span><span class="p">)</span>


<span class="c1"># a simple function to quickly load pickle files</span>
<span class="k">def</span> <span class="nf">ldpkl</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batch_effects_test</span>
</pre></div>
</div>
</section>
<section id="step-3-files-and-folders-grooming">
<h3>Step 3: Files and Folders grooming<a class="headerlink" href="#step-3-files-and-folders-grooming" title="Link to this heading"></a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">respfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">processing_dir</span><span class="p">,</span> <span class="s2">&quot;Y_train.pkl&quot;</span>
<span class="p">)</span>  <span class="c1"># measurements  (eg cortical thickness) of the training samples (columns: the various features/ROIs, rows: observations or subjects)</span>
<span class="n">covfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">processing_dir</span><span class="p">,</span> <span class="s2">&quot;X_train.pkl&quot;</span>
<span class="p">)</span>  <span class="c1"># covariates (eg age) the training samples (columns: covariates, rows: observations or subjects)</span>

<span class="n">testrespfile_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">processing_dir</span><span class="p">,</span> <span class="s2">&quot;Y_test.pkl&quot;</span>
<span class="p">)</span>  <span class="c1"># measurements  for the testing samples</span>
<span class="n">testcovfile_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">processing_dir</span><span class="p">,</span> <span class="s2">&quot;X_test.pkl&quot;</span>
<span class="p">)</span>  <span class="c1"># covariate file for the testing samples</span>

<span class="n">trbefile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">processing_dir</span><span class="p">,</span> <span class="s2">&quot;trbefile.pkl&quot;</span>
<span class="p">)</span>  <span class="c1"># training batch effects file (eg scanner_id, gender)  (columns: the various batch effects, rows: observations or subjects)</span>
<span class="n">tsbefile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span> <span class="s2">&quot;tsbefile.pkl&quot;</span><span class="p">)</span>  <span class="c1"># testing batch effects file</span>

<span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">processing_dir</span><span class="p">,</span> <span class="s2">&quot;Models/&quot;</span>
<span class="p">)</span>  <span class="c1">#  output path, where the models will be written</span>
<span class="n">log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span> <span class="s2">&quot;log/&quot;</span><span class="p">)</span>  <span class="c1">#</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">log_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">log_dir</span><span class="p">)</span>

<span class="n">outputsuffix</span> <span class="o">=</span> <span class="s2">&quot;_estimate&quot;</span>  <span class="c1"># a string to name the output files, of use only to you, so adapt it for your needs.</span>
</pre></div>
</div>
</section>
<section id="step-4-estimating-the-models">
<h3>Step 4: Estimating the models<a class="headerlink" href="#step-4-estimating-the-models" title="Link to this heading"></a></h3>
<p>Now we have everything ready to estimate the normative models. The
<code class="docutils literal notranslate"><span class="pre">estimate</span></code> function only needs the training and testing sets, each
divided in three datasets: covariates, measures and batch effects. We
obviously specify <code class="docutils literal notranslate"><span class="pre">alg=hbr</span></code> to use the hierarchical bayesian
regression method, well suited for the multi sites datasets. The
remaining arguments are basic data management: where the models, logs,
and output files will be written and how they will be named.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ptk</span><span class="o">.</span><span class="n">normative</span><span class="o">.</span><span class="n">estimate</span><span class="p">(</span>
    <span class="n">covfile</span><span class="o">=</span><span class="n">covfile</span><span class="p">,</span>
    <span class="n">respfile</span><span class="o">=</span><span class="n">respfile</span><span class="p">,</span>
    <span class="n">tsbefile</span><span class="o">=</span><span class="n">tsbefile</span><span class="p">,</span>
    <span class="n">trbefile</span><span class="o">=</span><span class="n">trbefile</span><span class="p">,</span>
    <span class="n">inscaler</span><span class="o">=</span><span class="s2">&quot;standardize&quot;</span><span class="p">,</span>
    <span class="n">outscaler</span><span class="o">=</span><span class="s2">&quot;standardize&quot;</span><span class="p">,</span>
    <span class="n">linear_mu</span><span class="o">=</span><span class="s2">&quot;True&quot;</span><span class="p">,</span>
    <span class="n">random_intercept_mu</span><span class="o">=</span><span class="s2">&quot;True&quot;</span><span class="p">,</span>
    <span class="n">centered_intercept_mu</span><span class="o">=</span><span class="s2">&quot;True&quot;</span><span class="p">,</span>
    <span class="n">alg</span><span class="o">=</span><span class="s2">&quot;hbr&quot;</span><span class="p">,</span>
    <span class="n">log_path</span><span class="o">=</span><span class="n">log_dir</span><span class="p">,</span>
    <span class="n">binary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span>
    <span class="n">testcov</span><span class="o">=</span><span class="n">testcovfile_path</span><span class="p">,</span>
    <span class="n">testresp</span><span class="o">=</span><span class="n">testrespfile_path</span><span class="p">,</span>
    <span class="n">outputsuffix</span><span class="o">=</span><span class="n">outputsuffix</span><span class="p">,</span>
    <span class="n">savemodel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">nuts_sampler</span><span class="o">=</span><span class="s2">&quot;nutpie&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Here some analyses can be done, there are also some error metrics that
could be of interest. This is covered in step 6 and in <a class="reference external" href="https://github.com/predictive-clinical-neuroscience/PCNtoolkit-demo/blob/main/tutorials/BLR_protocol/BLR_normativemodel_protocol.ipynb">Saige’s
tutorial</a>
on Normative Modelling.</p>
</section>
<section id="step-5-transfering-the-models-to-unseen-sites">
<h3>Step 5: Transfering the models to unseen sites<a class="headerlink" href="#step-5-transfering-the-models-to-unseen-sites" title="Link to this heading"></a></h3>
<p>Similarly to what was done before for the FCON data, we also need to
prepare the ICBM specific data, in order to run the transfer function:
training and testing set of covariates, measures and batch effects:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_adapt</span> <span class="o">=</span> <span class="p">(</span><span class="n">icbm_tr</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">Y_adapt</span> <span class="o">=</span> <span class="n">icbm_tr</span><span class="p">[</span><span class="n">idps</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="c1"># batch_effects_adapt = icbm_tr[[&#39;sitenum&#39;,&#39;sex&#39;]].to_numpy(dtype=int)</span>
<span class="n">batch_effects_adapt</span> <span class="o">=</span> <span class="n">icbm_tr</span><span class="p">[[</span><span class="s2">&quot;sitenum&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;X_adaptation.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_adapt</span><span class="p">),</span> <span class="n">file</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;Y_adaptation.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Y_adapt</span><span class="p">),</span> <span class="n">file</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;adbefile.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">batch_effects_adapt</span><span class="p">),</span> <span class="n">file</span><span class="p">)</span>

<span class="c1"># Test data (new dataset)</span>
<span class="n">X_test_txfr</span> <span class="o">=</span> <span class="p">(</span><span class="n">icbm_te</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">Y_test_txfr</span> <span class="o">=</span> <span class="n">icbm_te</span><span class="p">[</span><span class="n">idps</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="c1"># batch_effects_test_txfr = icbm_te[[&#39;sitenum&#39;,&#39;sex&#39;]].to_numpy(dtype=int)</span>
<span class="n">batch_effects_test_txfr</span> <span class="o">=</span> <span class="n">icbm_te</span><span class="p">[[</span><span class="s2">&quot;sitenum&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;X_test_txfr.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_test_txfr</span><span class="p">),</span> <span class="n">file</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;Y_test_txfr.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Y_test_txfr</span><span class="p">),</span> <span class="n">file</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;txbefile.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">batch_effects_test_txfr</span><span class="p">),</span> <span class="n">file</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">respfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span> <span class="s2">&quot;Y_adaptation.pkl&quot;</span><span class="p">)</span>
<span class="n">covfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span> <span class="s2">&quot;X_adaptation.pkl&quot;</span><span class="p">)</span>
<span class="n">testrespfile_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span> <span class="s2">&quot;Y_test_txfr.pkl&quot;</span><span class="p">)</span>
<span class="n">testcovfile_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span> <span class="s2">&quot;X_test_txfr.pkl&quot;</span><span class="p">)</span>
<span class="n">trbefile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span> <span class="s2">&quot;adbefile.pkl&quot;</span><span class="p">)</span>
<span class="n">tsbefile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span> <span class="s2">&quot;txbefile.pkl&quot;</span><span class="p">)</span>

<span class="n">log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span> <span class="s2">&quot;log_transfer/&quot;</span><span class="p">)</span>
<span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span> <span class="s2">&quot;Transfer/&quot;</span><span class="p">)</span>
<span class="n">model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">processing_dir</span><span class="p">,</span> <span class="s2">&quot;Models/&quot;</span>
<span class="p">)</span>  <span class="c1"># path to the previously trained models</span>
<span class="n">outputsuffix</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;_transfer&quot;</span>  <span class="c1"># suffix added to the output files from the transfer function</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Here, the difference is that the transfer function needs a model path,
which points to the models we just trained, and new site data (training
and testing). That is basically the only difference.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">yhat</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">z_scores</span> <span class="o">=</span> <span class="n">ptk</span><span class="o">.</span><span class="n">normative</span><span class="o">.</span><span class="n">transfer</span><span class="p">(</span>
    <span class="n">covfile</span><span class="o">=</span><span class="n">covfile</span><span class="p">,</span>
    <span class="n">respfile</span><span class="o">=</span><span class="n">respfile</span><span class="p">,</span>
    <span class="n">tsbefile</span><span class="o">=</span><span class="n">tsbefile</span><span class="p">,</span>
    <span class="n">trbefile</span><span class="o">=</span><span class="n">trbefile</span><span class="p">,</span>
    <span class="n">inscaler</span><span class="o">=</span><span class="s2">&quot;standardize&quot;</span><span class="p">,</span>
    <span class="n">outscaler</span><span class="o">=</span><span class="s2">&quot;standardize&quot;</span><span class="p">,</span>
    <span class="n">linear_mu</span><span class="o">=</span><span class="s2">&quot;True&quot;</span><span class="p">,</span>
    <span class="n">random_intercept_mu</span><span class="o">=</span><span class="s2">&quot;True&quot;</span><span class="p">,</span>
    <span class="n">centered_intercept_mu</span><span class="o">=</span><span class="s2">&quot;True&quot;</span><span class="p">,</span>
    <span class="n">model_path</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span>
    <span class="n">alg</span><span class="o">=</span><span class="s2">&quot;hbr&quot;</span><span class="p">,</span>
    <span class="n">log_path</span><span class="o">=</span><span class="n">log_dir</span><span class="p">,</span>
    <span class="n">binary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span>
    <span class="n">testcov</span><span class="o">=</span><span class="n">testcovfile_path</span><span class="p">,</span>
    <span class="n">testresp</span><span class="o">=</span><span class="n">testrespfile_path</span><span class="p">,</span>
    <span class="n">outputsuffix</span><span class="o">=</span><span class="n">outputsuffix</span><span class="p">,</span>
    <span class="n">savemodel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">nuts_sampler</span><span class="o">=</span><span class="s2">&quot;nutpie&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output_path</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">EV</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s2">&quot;EXPV_estimate.pkl&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">EV</span><span class="p">)</span>
</pre></div>
</div>
<p>And that is it, you now have models that benefited from prior knowledge
about different scanner sites to learn on unseen sites.</p>
</section>
<section id="step-6-interpreting-model-performance">
<h3>Step 6: Interpreting model performance<a class="headerlink" href="#step-6-interpreting-model-performance" title="Link to this heading"></a></h3>
<p>Output evaluation metrics definitions: * yhat - predictive mean * ys2
- predictive variance * nm - normative model * Z - deviance scores *
Rho - Pearson correlation between true and predicted responses * pRho -
parametric p-value for this correlation * RMSE - root mean squared
error between true/predicted responses * SMSE - standardised mean
squared error * EV - explained variance * MSLL - mean standardized log
loss * See page 23 in
<a class="reference external" href="http://www.gaussianprocess.org/gpml/chapters/RW2.pdf">http://www.gaussianprocess.org/gpml/chapters/RW2.pdf</a></p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="normative_modelling_walkthrough.html" class="btn btn-neutral float-left" title="DEMO ON NORMATIVE MODELING" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="apply_normative_models.html" class="btn btn-neutral float-right" title="Using lifespan models to make predictions on new data" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Andre F. Marquand.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>