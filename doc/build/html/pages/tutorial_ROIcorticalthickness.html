

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Bayesian Linear Regression &mdash; Predictive Clinical Neuroscience Toolkit 0.20 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pages/css/pcntoolkit_tabs.css" type="text/css" />
  <link rel="stylesheet" href="../_static/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pages/css/pcntoolkit.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pages/css/pcntoolkit_nomaxwidth.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Hierarchical Bayesian Regression" href="tutorial_HBR.html" />
    <link rel="prev" title="Gaussian Process Regression" href="tutorial_CPC2020.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/pcn-logo.png" class="logo" alt="Logo"/>
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
</ul>
<p class="caption"><span class="caption-text">Background</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="pcntoolkit_background.html">PCNtoolkit Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="pcntoolkit_background.html#intro-to-normative-modelling">Intro to normative modelling</a></li>
</ul>
<p class="caption"><span class="caption-text">Function &amp; Class Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modindex.html">Module Index</a></li>
</ul>
<p class="caption"><span class="caption-text">Current Events</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="updates.html">Updates</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="tutorial_CPC2020.html">Gaussian Process Regression</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Bayesian Linear Regression</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#step-0-install-necessary-libraries-grab-data-files">Step 0: Install necessary libraries &amp; grab data files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#step-1-prepare-covariate-data">Step 1: Prepare covariate data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#step-2-prepare-brain-data">Step 2: Prepare brain data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#step-3-combine-covariate-cortical-thickness-dataframes">Step 3: Combine covariate &amp; cortical thickness dataframes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#step-4-format-dataframes-to-run-normative-models">Step 4: Format dataframes to run normative models</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#create-train-test-split">Create train/test split</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#step-5-run-normative-model">Step 5: Run normative model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#step-6-interpreting-model-performance">Step 6: Interpreting model performance</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_HBR.html">Hierarchical Bayesian Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_braincharts_fit_nm.html">Estimating lifespan normative models</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_braincharts_apply_nm.html">Using lifespan models to make predictions on new data</a></li>
</ul>
<p class="caption"><span class="caption-text">Other Useful Stuff</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="FAQs.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="citing.html">How to cite PCNtoolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="acknowledgements.html">Acknowledgements</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Predictive Clinical Neuroscience Toolkit</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Bayesian Linear Regression</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/pages/tutorial_ROIcorticalthickness.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="bayesian-linear-regression">
<h1>Bayesian Linear Regression<a class="headerlink" href="#bayesian-linear-regression" title="Permalink to this headline">¶</a></h1>
<p>Normative Modeling Tutorial Using Multi-Site Cortical Thickness Data and Bayesian Linear Regression.</p>
<p>This notebook will prepare the data for normative modelling (assembling
data matrices from different datasets, preparing the covariates etc).</p>
<p>View on <a class="reference external" href="https://github.com/predictive-clinical-neuroscience/PCNtoolkit-demo">GitHub</a></p>
<p>Run in <a class="reference external" href="https://colab.research.google.com/github/predictive-clinical-neuroscience/PCNtoolkit-demo/blob/main/tutorials/ROI_blr_cortthick/NormativeModelTutorial.ipynb">Google Colab</a></p>
<p>Created by <a class="reference external" href="https://twitter.com/being_saige">Saige Rutherford</a></p>
<div></div><div class="section" id="step-0-install-necessary-libraries-grab-data-files">
<h2>Step 0: Install necessary libraries &amp; grab data files<a class="headerlink" href="#step-0-install-necessary-libraries-grab-data-files" title="Permalink to this headline">¶</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span> git clone https://github.com/predictive-clinical-neuroscience/PCNtoolkit-demo.git
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set this path to the git cloned PCNtoolkit-demo repository --&gt; Uncomment whichever line you need for either running on your own computer or on Google Colab.</span>
<span class="c1">#os.chdir(&#39;/Users/saigerutherford/repos/PCNtoolkit-demo/&#39;) # if running on your own computer, use this line (but obvi change the path)</span>
<span class="c1">#os.chdir(&#39;PCNtoolkit-demo/&#39;) # if running on Google Colab, use this line</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span> pip install -r requirements.txt
</pre></div>
</div>
</div>
<div class="section" id="step-1-prepare-covariate-data">
<h2>Step 1: Prepare covariate data<a class="headerlink" href="#step-1-prepare-covariate-data" title="Permalink to this headline">¶</a></h2>
<p>For this tutorial we will use data from the <a class="reference external" href="https://www.humanconnectome.org/study/hcp-young-adult">Human Connectome Project
Young Adult
study</a>,
<a class="reference external" href="https://www.cam-can.org/">CAMCAN</a>, and
<a class="reference external" href="https://brain-development.org/ixi-dataset/">IXI</a> to create a
multi-site dataset.</p>
<p>Our first step is to prepare and combine the covariate (age &amp; sex) data
from each site.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">joypy</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">pcntoolkit.normative</span> <span class="kn">import</span> <span class="n">estimate</span><span class="p">,</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">pcntoolkit.utils</span> <span class="kn">import</span> <span class="n">create_bspline_basis</span><span class="p">,</span> <span class="n">compute_MSLL</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hcp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/HCP1200_age_gender.csv&#39;</span><span class="p">)</span>
<span class="n">cam</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/cam_age_gender.csv&#39;</span><span class="p">)</span>
<span class="n">ixi</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/IXI_age_gender.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cam_hcp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">hcp</span><span class="p">,</span> <span class="n">cam</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cov</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">cam_hcp</span><span class="p">,</span> <span class="n">ixi</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font_scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;darkgrid&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">displot</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;site&quot;</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="s2">&quot;stack&quot;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cov</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;site&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="step-2-prepare-brain-data">
<h2>Step 2: Prepare brain data<a class="headerlink" href="#step-2-prepare-brain-data" title="Permalink to this headline">¶</a></h2>
<p>Next we will format and combine the MRI data. We are using cortical
thickness maps that are created by running recon-all from Freesurfer 6.
We need to merge together the left and right hemisphere text files for
each site, and then combine the different sites into a single dataframe.
We reduce the dimensionality of our data by using ROIs from the
Desikan-Killiany atlas.</p>
<p>Here is some psuedo-code (run from a terminal in the folder that has all
subject’s recon-all output folders) that was used to extract these ROIs:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">SUBJECTS_DIR</span><span class="o">=/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">study</span><span class="o">/</span><span class="n">freesurfer_data</span><span class="o">/</span>
<span class="n">aparcstats2table</span> <span class="o">--</span><span class="n">subject</span> <span class="n">sub</span><span class="o">-*</span> <span class="o">--</span><span class="n">hemi</span> <span class="n">lh</span> <span class="o">--</span><span class="n">meas</span> <span class="n">thickness</span> <span class="o">--</span><span class="n">tablefile</span> <span class="n">HCP1200_aparc_lh_thickness</span><span class="o">.</span><span class="n">txt</span>
<span class="n">aparcstats2table</span> <span class="o">--</span><span class="n">subject</span> <span class="n">sub</span><span class="o">-*</span> <span class="o">--</span><span class="n">hemi</span> <span class="n">rh</span> <span class="o">--</span><span class="n">meas</span> <span class="n">thickness</span> <span class="o">--</span><span class="n">tablefile</span> <span class="n">HCP1200_aparc_rh_thickness</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cam</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/CAMCAN_aparc_thickness.csv&#39;</span><span class="p">)</span>
<span class="n">hcpya</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/HCP1200_aparc_thickness.csv&#39;</span><span class="p">)</span>
<span class="n">ixi</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/IXI_aparc_thickness.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hcpya_cam</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">hcpya</span><span class="p">,</span> <span class="n">cam</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">brain_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ixi</span><span class="p">,</span> <span class="n">hcpya_cam</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>We also want to include the <a class="reference external" href="https://mathworld.wolfram.com/EulerCharacteristic.html">Euler
number</a> as a
covariate. So we extracted the euler number from each subject’s
recon-all output folder into a text file and we now need to format and
combine these into our brain dataframe.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hcp_euler</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/hcp-ya_euler.csv&#39;</span><span class="p">)</span>
<span class="n">cam_euler</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/cam_euler.csv&#39;</span><span class="p">)</span>
<span class="n">ixi_euler</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/ixi_euler.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hcp_euler</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;hcp&#39;</span>
<span class="n">cam_euler</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cam&#39;</span>
<span class="n">ixi_euler</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ixi&#39;</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hcp_euler</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\s*$&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">cam_euler</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\s*$&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ixi_euler</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\s*$&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hcp_euler</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">cam_euler</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ixi_euler</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hcp_euler</span><span class="p">[</span><span class="s1">&#39;rh_euler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hcp_euler</span><span class="p">[</span><span class="s1">&#39;rh_euler&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">hcp_euler</span><span class="p">[</span><span class="s1">&#39;lh_euler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hcp_euler</span><span class="p">[</span><span class="s1">&#39;lh_euler&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">cam_euler</span><span class="p">[</span><span class="s1">&#39;rh_euler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cam_euler</span><span class="p">[</span><span class="s1">&#39;rh_euler&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">cam_euler</span><span class="p">[</span><span class="s1">&#39;lh_euler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cam_euler</span><span class="p">[</span><span class="s1">&#39;lh_euler&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">ixi_euler</span><span class="p">[</span><span class="s1">&#39;rh_euler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ixi_euler</span><span class="p">[</span><span class="s1">&#39;rh_euler&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">ixi_euler</span><span class="p">[</span><span class="s1">&#39;lh_euler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ixi_euler</span><span class="p">[</span><span class="s1">&#39;lh_euler&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hcp_cam_euler</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">hcp_euler</span><span class="p">,</span> <span class="n">cam_euler</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_euler</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ixi_euler</span><span class="p">,</span> <span class="n">hcp_cam_euler</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, we need to center the euler number for each site. The euler
number is very site-specific so in order to use the same exclusion
threshold across sites we need to center the site by subtracting the
site median from all subjects at a site. Then we will take the square
root and multiply by negative one and exclude any subjects with a square
root above 10. This choice of threshold is fairly random. If possible
all of your data should be visually inspected to verify that the data
inclusion is not too strict or too lenient.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_euler</span><span class="p">[</span><span class="s1">&#39;avg_euler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_euler</span><span class="p">[[</span><span class="s1">&#39;lh_euler&#39;</span><span class="p">,</span><span class="s1">&#39;rh_euler&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_euler</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;site&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_euler</span><span class="p">[</span><span class="s1">&#39;site_median&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_euler</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_euler</span><span class="p">[</span><span class="s1">&#39;site_median&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_euler</span><span class="p">[</span><span class="s1">&#39;site_median&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s1">&#39;hcp&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">43</span><span class="p">,</span><span class="s1">&#39;cam&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">61</span><span class="p">,</span><span class="s1">&#39;ixi&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">56</span><span class="p">})</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_euler</span><span class="p">[</span><span class="s1">&#39;avg_euler_centered&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_euler</span><span class="p">[</span><span class="s1">&#39;avg_euler&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_euler</span><span class="p">[</span><span class="s1">&#39;site_median&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_euler</span><span class="p">[</span><span class="s1">&#39;avg_euler_centered_neg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_euler</span><span class="p">[</span><span class="s1">&#39;avg_euler_centered&#39;</span><span class="p">]</span><span class="o">*-</span><span class="mi">1</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_euler</span><span class="p">[</span><span class="s1">&#39;avg_euler_centered_neg_sqrt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">df_euler</span><span class="p">[</span><span class="s1">&#39;avg_euler_centered_neg&#39;</span><span class="p">]))</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_rows&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.width&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="c1">#create a color gradent function to be used in the colormap parameter</span>
<span class="k">def</span> <span class="nf">color_gradient</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">stop</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">stop</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">stop</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">start</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">stop</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="c1">#show the table</span>
<span class="c1">#plot the figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">380</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">joypy</span><span class="o">.</span><span class="n">joyplot</span><span class="p">(</span><span class="n">df_euler</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;avg_euler_centered_neg_sqrt&#39;</span><span class="p">],</span> <span class="n">overlap</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">&quot;site&quot;</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="s1">&#39;own&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
                          <span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xlabels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ylabels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">color_gradient</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="mf">.08</span><span class="p">,</span> <span class="mf">.45</span><span class="p">,</span> <span class="mf">.8</span><span class="p">),</span><span class="n">stop</span><span class="o">=</span><span class="p">(</span><span class="mf">.8</span><span class="p">,</span> <span class="mf">.34</span><span class="p">,</span> <span class="mf">.44</span><span class="p">))</span>
                          <span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> <span class="n">linecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">fade</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;sqrt(-Euler Number), median centered&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;sqrt(-Euler number)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Site&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">brain</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_euler</span><span class="p">,</span> <span class="n">brain_all</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">brain</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">brain_good</span> <span class="o">=</span> <span class="n">brain</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;avg_euler_centered_neg_sqrt &lt; 10&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">brain_good</span><span class="p">)</span>
</pre></div>
</div>
<p>We lose 63 subjects because they have a large euler number.</p>
</div>
<div class="section" id="step-3-combine-covariate-cortical-thickness-dataframes">
<h2>Step 3: Combine covariate &amp; cortical thickness dataframes<a class="headerlink" href="#step-3-combine-covariate-cortical-thickness-dataframes" title="Permalink to this headline">¶</a></h2>
<p>Even though the normative modeling code needs the covariate and features
(cortical thickness) in separate text files, we first need to merge them
together to make sure that we have the same subjects in each file and
that the rows (representing subjects) align.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># make sure to use how=&quot;inner&quot; so that we only include subjects that have data in both the covariate and the cortical thickness files</span>
<span class="n">all_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">brain_good</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="step-4-format-dataframes-to-run-normative-models">
<h2>Step 4: Format dataframes to run normative models<a class="headerlink" href="#step-4-format-dataframes-to-run-normative-models" title="Permalink to this headline">¶</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Remove any subjects that have NaN variables in any of the columns</span>
<span class="n">all_data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lh_bankssts_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_caudalanteriorcingulate_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_caudalmiddlefrontal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_cuneus_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_entorhinal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_fusiform_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_inferiorparietal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_inferiortemporal_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_isthmuscingulate_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_lateraloccipital_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_lateralorbitofrontal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_lingual_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_medialorbitofrontal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_middletemporal_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_parahippocampal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_paracentral_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_parsopercularis_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_parsorbitalis_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_parstriangularis_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_pericalcarine_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_postcentral_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_posteriorcingulate_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_precentral_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_precuneus_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_rostralanteriorcingulate_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_rostralmiddlefrontal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_superiorfrontal_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_superiorparietal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_superiortemporal_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_supramarginal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_frontalpole_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_temporalpole_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_transversetemporal_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_insula_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_MeanThickness_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_bankssts_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_caudalanteriorcingulate_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_caudalmiddlefrontal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_cuneus_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_entorhinal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_fusiform_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_inferiorparietal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_inferiortemporal_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_isthmuscingulate_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_lateraloccipital_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_lateralorbitofrontal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_lingual_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_medialorbitofrontal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_middletemporal_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_parahippocampal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_paracentral_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_parsopercularis_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_parsorbitalis_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_parstriangularis_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_pericalcarine_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_postcentral_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_posteriorcingulate_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_precentral_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_precuneus_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_rostralanteriorcingulate_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_rostralmiddlefrontal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_superiorfrontal_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_superiorparietal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_superiortemporal_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_supramarginal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_frontalpole_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_temporalpole_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_transversetemporal_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_insula_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_MeanThickness_thickness&#39;</span><span class="p">,</span><span class="s1">&#39;age&#39;</span><span class="p">,</span><span class="s1">&#39;sex&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Separate the covariate &amp; features into their own dataframes</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_data_features</span> <span class="o">=</span> <span class="n">all_data</span><span class="p">[[</span><span class="s1">&#39;lh_bankssts_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_caudalanteriorcingulate_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_caudalmiddlefrontal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_cuneus_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_entorhinal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_fusiform_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_inferiorparietal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_inferiortemporal_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_isthmuscingulate_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_lateraloccipital_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_lateralorbitofrontal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_lingual_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_medialorbitofrontal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_middletemporal_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_parahippocampal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_paracentral_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_parsopercularis_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_parsorbitalis_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_parstriangularis_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_pericalcarine_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_postcentral_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_posteriorcingulate_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_precentral_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_precuneus_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_rostralanteriorcingulate_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_rostralmiddlefrontal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_superiorfrontal_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_superiorparietal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_superiortemporal_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_supramarginal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_frontalpole_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_temporalpole_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_transversetemporal_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;lh_insula_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;lh_MeanThickness_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_bankssts_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_caudalanteriorcingulate_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_caudalmiddlefrontal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_cuneus_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_entorhinal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_fusiform_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_inferiorparietal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_inferiortemporal_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_isthmuscingulate_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_lateraloccipital_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_lateralorbitofrontal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_lingual_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_medialorbitofrontal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_middletemporal_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_parahippocampal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_paracentral_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_parsopercularis_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_parsorbitalis_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_parstriangularis_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_pericalcarine_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_postcentral_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_posteriorcingulate_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_precentral_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_precuneus_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_rostralanteriorcingulate_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_rostralmiddlefrontal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_superiorfrontal_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_superiorparietal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_superiortemporal_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_supramarginal_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_frontalpole_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_temporalpole_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_transversetemporal_thickness&#39;</span><span class="p">,</span>
       <span class="s1">&#39;rh_insula_thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;rh_MeanThickness_thickness&#39;</span><span class="p">]]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_data_covariates</span> <span class="o">=</span> <span class="n">all_data</span><span class="p">[[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span><span class="s1">&#39;sex&#39;</span><span class="p">,</span><span class="s1">&#39;site&#39;</span><span class="p">]]</span>
</pre></div>
</div>
<p>Right now, the sites are coded in a single column using a string. We
need to instead dummy encode the site variable so that there is a column
for each site and the columns contain binary variables (0/1). Luckily
pandas has a nice built in function, <code class="docutils literal notranslate"><span class="pre">pd.get_dummies</span></code> to help us
format the site column this way!</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_data_covariates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">all_data_covariates</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_data</span><span class="p">[</span><span class="s1">&#39;Average_Thickness&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_data</span><span class="p">[[</span><span class="s1">&#39;lh_MeanThickness_thickness&#39;</span><span class="p">,</span><span class="s1">&#39;rh_MeanThickness_thickness&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Take a sneak peak to see if there are any super obvious site effects. If
there were, we would see a large separation in the fitted regression
line for each site.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">set_theme</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;darkgrid&quot;</span><span class="p">,</span><span class="n">font_scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">lmplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">all_data</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Average_Thickness&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;site&quot;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">3.25</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">95</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="create-train-test-split">
<h3>Create train/test split<a class="headerlink" href="#create-train-test-split" title="Permalink to this headline">¶</a></h3>
<p>We will use 80% of the data for training and 20% for testing. We
stratify our train/test split using the site variable to make sure that
the train/test sets both contain data from all sites. The model wouldn’t
learn the site effects if all of the data from one site was only in the
test set.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">all_data_covariates</span><span class="p">,</span> <span class="n">all_data_features</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">all_data</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</pre></div>
</div>
<p>Verify that your train &amp; test arrays are the same size</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tr_cov_size</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span>
<span class="n">tr_resp_size</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">shape</span>
<span class="n">te_cov_size</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">shape</span>
<span class="n">te_resp_size</span> <span class="o">=</span> <span class="n">y_test</span><span class="o">.</span><span class="n">shape</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Train covariate size is: &quot;</span><span class="p">,</span> <span class="n">tr_cov_size</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test covariate size is: &quot;</span><span class="p">,</span> <span class="n">te_cov_size</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Train response size is: &quot;</span><span class="p">,</span> <span class="n">tr_resp_size</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test response size is: &quot;</span><span class="p">,</span> <span class="n">te_resp_size</span><span class="p">)</span>
</pre></div>
</div>
<p>Save out each ROI to its own file:</p>
<p>We setup the normative model so that for each Y (brain region) we fit a
separate model. While the estimate function in the pcntoolkit can handle
having all of the Y’s in a single text file, for this tutorial we are
going to organize our Y’s so that they are each in their own text file
and directory.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;/Users/saigerutherford/repos/PCNToolkit-demo/&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">data</span><span class="o">/</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">y_train</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">y_train</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;resp_tr_&#39;</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;cov_tr.txt&#39;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_train</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;resp_tr.txt&#39;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">y_test</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">y_test</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;resp_te_&#39;</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_test</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;cov_te.txt&#39;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_test</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;resp_te.txt&#39;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span> <span class="k">if</span> <span class="o">[[</span> ! -e data/ROI_models/ <span class="o">]]</span><span class="p">;</span> <span class="k">then</span> mkdir data/ROI_models<span class="p">;</span> <span class="k">fi</span>
<span class="o">!</span> <span class="k">if</span> <span class="o">[[</span> ! -e data/covariate_files/ <span class="o">]]</span><span class="p">;</span> <span class="k">then</span> mkdir data/covariate_files<span class="p">;</span> <span class="k">fi</span>
<span class="o">!</span> <span class="k">if</span> <span class="o">[[</span> ! -e data/response_files/ <span class="o">]]</span><span class="p">;</span> <span class="k">then</span> mkdir data/response_files<span class="p">;</span> <span class="k">fi</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span> <span class="k">for</span> i <span class="k">in</span> <span class="sb">`</span>cat data/roi_dir_names<span class="sb">`</span><span class="p">;</span> <span class="k">do</span> <span class="nb">cd</span> data/ROI_models<span class="p">;</span> mkdir <span class="si">${</span><span class="nv">i</span><span class="si">}</span><span class="p">;</span> <span class="nb">cd</span> ../../<span class="p">;</span> cp resp_tr_<span class="si">${</span><span class="nv">i</span><span class="si">}</span>.txt data/ROI_models/<span class="si">${</span><span class="nv">i</span><span class="si">}</span>/resp_tr.txt<span class="p">;</span> cp resp_te_<span class="si">${</span><span class="nv">i</span><span class="si">}</span>.txt data/ROI_models/<span class="si">${</span><span class="nv">i</span><span class="si">}</span>/resp_te.txt<span class="p">;</span> cp cov_tr.txt data/ROI_models/<span class="si">${</span><span class="nv">i</span><span class="si">}</span>/cov_tr.txt<span class="p">;</span> cp cov_te.txt data/ROI_models/<span class="si">${</span><span class="nv">i</span><span class="si">}</span>/cov_te.txt<span class="p">;</span> <span class="k">done</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span> mv resp_*.txt data/response_files/
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span> mv cov_t*.txt data/covariate_files/
</pre></div>
</div>
</div>
</div>
<div class="section" id="step-5-run-normative-model">
<h2>Step 5: Run normative model<a class="headerlink" href="#step-5-run-normative-model" title="Permalink to this headline">¶</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set this path to wherever your ROI_models folder is located (where you copied all of the covariate &amp; response text files to in Step 4)</span>
<span class="n">data_dir</span> <span class="o">=</span> <span class="s1">&#39;/Users/saigerutherford/repos/PCNToolkit-demo/data/ROI_models/&#39;</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a list of all the ROIs you want to run a normative model for</span>
<span class="n">roi_ids</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lh_MeanThickness_thickness&#39;</span><span class="p">,</span>
           <span class="s1">&#39;rh_MeanThickness_thickness&#39;</span><span class="p">,</span>
           <span class="s1">&#39;lh_bankssts_thickness&#39;</span><span class="p">,</span>
           <span class="s1">&#39;lh_caudalanteriorcingulate_thickness&#39;</span><span class="p">,</span>
           <span class="s1">&#39;lh_superiorfrontal_thickness&#39;</span><span class="p">,</span>
           <span class="s1">&#39;rh_superiorfrontal_thickness&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>When we split the data into train and test sets, we did not reset the
index. This means that the row numbers in the train/test matrices are
still the same as before splitting the data. We will need the test set
row numbers of which subjects belong to which site in order to evaluate
per site performance metrics, so we need to reset the row numbers in the
train/test split matrices.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_col_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;site_cam&#39;</span><span class="p">,</span> <span class="s1">&#39;site_hcp&#39;</span><span class="p">,</span> <span class="s1">&#39;site_ixi&#39;</span><span class="p">]</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/covariate_files/cov_tr.txt&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">x_col_names</span><span class="p">)</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/covariate_files/cov_te.txt&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">x_col_names</span><span class="p">)</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/response_files/resp_tr.txt&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/response_files/resp_te.txt&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">X_test</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">y_train</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">y_test</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Extract site indices:</p>
<p>Get site ids so that we can evaluate the test metrics independently for
each site</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cam_idx</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">X_test</span><span class="p">[</span><span class="s1">&#39;site_cam&#39;</span> <span class="p">]</span><span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<span class="n">hcp_idx</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">X_test</span><span class="p">[</span><span class="s1">&#39;site_hcp&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<span class="n">ixi_idx</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">X_test</span><span class="p">[</span><span class="s1">&#39;site_ixi&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

<span class="c1"># Save the site indices into a single list</span>
<span class="n">sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">cam_idx</span><span class="p">,</span> <span class="n">hcp_idx</span><span class="p">,</span> <span class="n">ixi_idx</span><span class="p">]</span>

<span class="c1"># Create a list with sites names to use in evaluating per-site metrics</span>
<span class="n">site_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cam&#39;</span><span class="p">,</span> <span class="s1">&#39;hcp&#39;</span><span class="p">,</span> <span class="s1">&#39;ixi&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Basis expansion:</p>
<p>Now, we set up a B-spline basis set that allows us to perform nonlinear
regression using a linear model. This basis is deliberately chosen to
not to be too flexible so that in can only model relatively slowly
varying trends. To increase the flexibility of the model you can change
the parameterisation (e.g. by adding knot points to the Bspline basis or
increasing the order of the interpolating polynomial).</p>
<p>Note that in the neuroimaging literature, it is more common to use a
polynomial basis expansion for this. Piecewise polynomials like
B-splines are superior because they do not introduce a global curvature.
See the reference below for further information.</p>
<p><a class="reference external" href="https://cran.r-project.org/web/packages/crs/vignettes/spline_primer.pdf">Primer on regression
splines</a></p>
<p><a class="reference external" href="https://www.sciencedirect.com/science/article/abs/pii/S1053811910000832?via%3Dihub">Reference for why polynomials are a bad
idea</a></p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a cubic B-spline basis (used for regression)</span>
<span class="n">xmin</span> <span class="o">=</span> <span class="mi">10</span><span class="c1">#16 # xmin &amp; xmax are the boundaries for ages of participants in the dataset</span>
<span class="n">xmax</span> <span class="o">=</span> <span class="mi">95</span><span class="c1">#90</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">create_bspline_basis</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">)</span>

<span class="c1"># create the basis expansion for the covariates for each of the</span>
<span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">roi_ids</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating basis expansion for ROI:&#39;</span><span class="p">,</span> <span class="n">roi</span><span class="p">)</span>
    <span class="n">roi_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">roi</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">roi_dir</span><span class="p">)</span>

    <span class="c1"># create output dir</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">roi_dir</span><span class="p">,</span><span class="s1">&#39;blr&#39;</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># load train &amp; test covariate data matrices</span>
    <span class="n">X_tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">roi_dir</span><span class="p">,</span> <span class="s1">&#39;cov_tr.txt&#39;</span><span class="p">))</span>
    <span class="n">X_te</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">roi_dir</span><span class="p">,</span> <span class="s1">&#39;cov_te.txt&#39;</span><span class="p">))</span>

    <span class="c1"># add intercept column</span>
    <span class="n">X_tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">X_tr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">X_tr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">X_te</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">X_te</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">X_te</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">roi_dir</span><span class="p">,</span> <span class="s1">&#39;cov_int_tr.txt&#39;</span><span class="p">),</span> <span class="n">X_tr</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">roi_dir</span><span class="p">,</span> <span class="s1">&#39;cov_int_te.txt&#39;</span><span class="p">),</span> <span class="n">X_te</span><span class="p">)</span>

    <span class="c1"># create Bspline basis set</span>
    <span class="n">Phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">B</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">X_tr</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">Phis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">B</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">X_te</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">X_tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">X_tr</span><span class="p">,</span> <span class="n">Phi</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">X_te</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">X_te</span><span class="p">,</span> <span class="n">Phis</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">roi_dir</span><span class="p">,</span> <span class="s1">&#39;cov_bspline_tr.txt&#39;</span><span class="p">),</span> <span class="n">X_tr</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">roi_dir</span><span class="p">,</span> <span class="s1">&#39;cov_bspline_te.txt&#39;</span><span class="p">),</span> <span class="n">X_te</span><span class="p">)</span>
</pre></div>
</div>
<p>Prepare output structures:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create pandas dataframes with header names to save out the overall and per-site model evaluation metrics</span>
<span class="n">blr_metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">,</span> <span class="s1">&#39;MSLL&#39;</span><span class="p">,</span> <span class="s1">&#39;EV&#39;</span><span class="p">,</span> <span class="s1">&#39;SMSE&#39;</span><span class="p">,</span> <span class="s1">&#39;RMSE&#39;</span><span class="p">,</span> <span class="s1">&#39;Rho&#39;</span><span class="p">])</span>
<span class="n">blr_site_metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">,</span> <span class="s1">&#39;site&#39;</span><span class="p">,</span> <span class="s1">&#39;y_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;y_var&#39;</span><span class="p">,</span> <span class="s1">&#39;yhat_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;yhat_var&#39;</span><span class="p">,</span> <span class="s1">&#39;MSLL&#39;</span><span class="p">,</span> <span class="s1">&#39;EV&#39;</span><span class="p">,</span> <span class="s1">&#39;SMSE&#39;</span><span class="p">,</span> <span class="s1">&#39;RMSE&#39;</span><span class="p">,</span> <span class="s1">&#39;Rho&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>Estimate the normative models:</p>
<p>In this step, we estimate the normative models one at a time. In
principle we could also do this on the whole data matrix at once
(e.g. with the response variables stored in a n_subjects x
n_brain_measures numpy array). However, doing it this way gives us some
extra flexibility in that it does not require that the subjects are
exactly the same for each of the brain measures.</p>
<p>This code fragment will loop through each region of interest in the
roi_ids list (set a few code blocks above) using Bayesian linear
regression and evaluate the model on the independent test set. It will
then compute error metrics such as the explained variance, mean
standardized log loss and Pearson correlation between true and predicted
test responses separately for each scanning site.</p>
<p>We supply the estimate function with a few specific arguments that are
worthy of commenting on: * alg = ‘blr’ : specifies we should use
Bayesian linear regression * optimizer = ‘powell’ : use Powell’s
derivative-free optimization method (faster in this case than L-BFGS) *
savemodel = False : do not write out the final estimated model to disk
* saveoutput = False : return the outputs directly rather than writing
them to disk * standardize = False : Do not standardize the covariates
or response variables</p>
<p>One important consideration is whether or not to standardize. Whilst
this generally only has a minor effect on the final model accuracy, it
has implications for the interpretation of models and how they are
configured. If the covariates and responses are both standardized, the
model will return standardized coefficients. If (as in this case) the
response variables are not standardized, then the scaling both
covariates and responses will be reflected in the estimated
coefficients. Also, under the linear modelling approach employed here,
if the coefficients are unstandardized and do not have a zero mean, it
is necessary to add an intercept column to the design matrix. This is
done in the code block above.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Loop through ROIs</span>
<span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">roi_ids</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running ROI:&#39;</span><span class="p">,</span> <span class="n">roi</span><span class="p">)</span>
    <span class="n">roi_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">roi</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">roi_dir</span><span class="p">)</span>

    <span class="c1"># configure the covariates to use. Change *_bspline_* to *_int_* to</span>
    <span class="n">cov_file_tr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">roi_dir</span><span class="p">,</span> <span class="s1">&#39;cov_bspline_tr.txt&#39;</span><span class="p">)</span>
    <span class="n">cov_file_te</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">roi_dir</span><span class="p">,</span> <span class="s1">&#39;cov_bspline_te.txt&#39;</span><span class="p">)</span>

    <span class="c1"># load train &amp; test response files</span>
    <span class="n">resp_file_tr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">roi_dir</span><span class="p">,</span> <span class="s1">&#39;resp_tr.txt&#39;</span><span class="p">)</span>
    <span class="n">resp_file_te</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">roi_dir</span><span class="p">,</span> <span class="s1">&#39;resp_te.txt&#39;</span><span class="p">)</span>

    <span class="c1"># run a basic model</span>
    <span class="n">yhat_te</span><span class="p">,</span> <span class="n">s2_te</span><span class="p">,</span> <span class="n">nm</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">metrics_te</span> <span class="o">=</span> <span class="n">estimate</span><span class="p">(</span><span class="n">cov_file_tr</span><span class="p">,</span>
                                                 <span class="n">resp_file_tr</span><span class="p">,</span>
                                                 <span class="n">testresp</span><span class="o">=</span><span class="n">resp_file_te</span><span class="p">,</span>
                                                 <span class="n">testcov</span><span class="o">=</span><span class="n">cov_file_te</span><span class="p">,</span>
                                                 <span class="n">alg</span> <span class="o">=</span> <span class="s1">&#39;blr&#39;</span><span class="p">,</span>
                                                 <span class="n">optimizer</span> <span class="o">=</span> <span class="s1">&#39;powell&#39;</span><span class="p">,</span>
                                                 <span class="n">savemodel</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                 <span class="n">saveoutput</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                 <span class="n">standardize</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="c1"># display and save metrics</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;EV=&#39;</span><span class="p">,</span> <span class="n">metrics_te</span><span class="p">[</span><span class="s1">&#39;EXPV&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RHO=&#39;</span><span class="p">,</span> <span class="n">metrics_te</span><span class="p">[</span><span class="s1">&#39;Rho&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MSLL=&#39;</span><span class="p">,</span> <span class="n">metrics_te</span><span class="p">[</span><span class="s1">&#39;MSLL&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">blr_metrics</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">blr_metrics</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">roi</span><span class="p">,</span> <span class="n">metrics_te</span><span class="p">[</span><span class="s1">&#39;MSLL&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">metrics_te</span><span class="p">[</span><span class="s1">&#39;EXPV&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">metrics_te</span><span class="p">[</span><span class="s1">&#39;SMSE&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                         <span class="n">metrics_te</span><span class="p">[</span><span class="s1">&#39;RMSE&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">metrics_te</span><span class="p">[</span><span class="s1">&#39;Rho&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>

    <span class="c1"># Compute metrics per site in test set, save to pandas df</span>
    <span class="c1"># load true test data</span>
    <span class="n">X_te</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">cov_file_te</span><span class="p">)</span>
    <span class="n">y_te</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">resp_file_te</span><span class="p">)</span>
    <span class="n">y_te</span> <span class="o">=</span> <span class="n">y_te</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="c1"># make sure it is a 2-d array</span>

    <span class="c1"># load training data (required to compute the MSLL)</span>
    <span class="n">y_tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">resp_file_tr</span><span class="p">)</span>
    <span class="n">y_tr</span> <span class="o">=</span> <span class="n">y_tr</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">site</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sites</span><span class="p">):</span>
        <span class="n">y_mean_te_site</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_te</span><span class="p">[</span><span class="n">site</span><span class="p">])]])</span>
        <span class="n">y_var_te_site</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">y_te</span><span class="p">[</span><span class="n">site</span><span class="p">])]])</span>
        <span class="n">yhat_mean_te_site</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">yhat_te</span><span class="p">[</span><span class="n">site</span><span class="p">])]])</span>
        <span class="n">yhat_var_te_site</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">yhat_te</span><span class="p">[</span><span class="n">site</span><span class="p">])]])</span>

        <span class="n">metrics_te_site</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">y_te</span><span class="p">[</span><span class="n">site</span><span class="p">],</span> <span class="n">yhat_te</span><span class="p">[</span><span class="n">site</span><span class="p">],</span> <span class="n">s2_te</span><span class="p">[</span><span class="n">site</span><span class="p">],</span> <span class="n">y_mean_te_site</span><span class="p">,</span> <span class="n">y_var_te_site</span><span class="p">)</span>

        <span class="n">site_name</span> <span class="o">=</span> <span class="n">site_names</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>
        <span class="n">blr_site_metrics</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">blr_site_metrics</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">roi</span><span class="p">,</span> <span class="n">site_names</span><span class="p">[</span><span class="n">num</span><span class="p">],</span>
                                                       <span class="n">y_mean_te_site</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                       <span class="n">y_var_te_site</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                       <span class="n">yhat_mean_te_site</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                       <span class="n">yhat_var_te_site</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                       <span class="n">metrics_te_site</span><span class="p">[</span><span class="s1">&#39;MSLL&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                                       <span class="n">metrics_te_site</span><span class="p">[</span><span class="s1">&#39;EXPV&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                                       <span class="n">metrics_te_site</span><span class="p">[</span><span class="s1">&#39;SMSE&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                                       <span class="n">metrics_te_site</span><span class="p">[</span><span class="s1">&#39;RMSE&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                                       <span class="n">metrics_te_site</span><span class="p">[</span><span class="s1">&#39;Rho&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Save per site test set metrics variable to CSV file</span>
<span class="n">blr_site_metrics</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;blr_site_metrics.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index_label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Save overall test set metrics to CSV file</span>
<span class="n">blr_metrics</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;blr_metrics.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index_label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="step-6-interpreting-model-performance">
<h2>Step 6: Interpreting model performance<a class="headerlink" href="#step-6-interpreting-model-performance" title="Permalink to this headline">¶</a></h2>
<p>Output evaluation metrics definitions</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 86%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><strong>key value</strong></p></td>
<td><p><strong>Description</strong></p></td>
</tr>
<tr class="row-even"><td><p>yhat</p></td>
<td><p>predictive mean</p></td>
</tr>
<tr class="row-odd"><td><p>ys2</p></td>
<td><p>predictive variance</p></td>
</tr>
<tr class="row-even"><td><p>nm</p></td>
<td><p>normative model</p></td>
</tr>
<tr class="row-odd"><td><p>Z</p></td>
<td><p>deviance scores</p></td>
</tr>
<tr class="row-even"><td><p>Rho</p></td>
<td><p>Pearson correlation between true and predicted responses</p></td>
</tr>
<tr class="row-odd"><td><p>pRho</p></td>
<td><p>parametric p-value for this correlation</p></td>
</tr>
<tr class="row-even"><td><p>RMSE</p></td>
<td><p>root mean squared error between true/predicted responses</p></td>
</tr>
<tr class="row-odd"><td><p>SMSE</p></td>
<td><p>standardised mean squared error</p></td>
</tr>
<tr class="row-even"><td><p>EV</p></td>
<td><p>explained variance</p></td>
</tr>
<tr class="row-odd"><td><p>MSLL</p></td>
<td><p>mean standardized log loss <a class="reference external" href="http://www.gaussianprocess.org/gpml/chapters/RW2.pdf">See page 23</a></p></td>
</tr>
</tbody>
</table>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="tutorial_HBR.html" class="btn btn-neutral float-right" title="Hierarchical Bayesian Regression" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="tutorial_CPC2020.html" class="btn btn-neutral float-left" title="Gaussian Process Regression" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, Andre F. Marquand.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>