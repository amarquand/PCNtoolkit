

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Intro to normative modelling &mdash; Predictive Clinical Neuroscience Toolkit 0.20 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/pcntoolkit_tabs.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/pcntoolkit.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/pcntoolkit_nomaxwidth.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Module Index" href="../modindex.html" />
    <link rel="prev" title="PCNtoolkit Background" href="pcntoolkit_background.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/pcn-logo.png" class="logo" alt="Logo"/>
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
</ul>
<p class="caption"><span class="caption-text">Background</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="pcntoolkit_background.html">PCNtoolkit Background</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Intro to normative modelling</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#data-formats">Data formats</a></li>
<li class="toctree-l2"><a class="reference internal" href="#basic-usage-command-line">Basic usage (command line)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#basic-usage-scripted">Basic usage (scripted)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#paralellising-estimation-to-speed-things-up">Paralellising estimation to speed things up</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Function Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modindex.html">Module Index</a></li>
</ul>
<p class="caption"><span class="caption-text">Current Events</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="updates.html">Updates</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="tutorial_CPC2020.html">Tutorial: Gaussian Process Regression (from Computational Psychiatry Course 2020)</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_ROIcorticalthickness.html">Tutorial 2: Bayesian Linear Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_HBR.html">Tutorial: Hierarchical Bayesian Regressian</a></li>
</ul>
<p class="caption"><span class="caption-text">Other Useful Stuff</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="FAQs.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="citing.html">How to cite PCNtoolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="acknowledgements.html">Acknowledgements</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Predictive Clinical Neuroscience Toolkit</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Intro to normative modelling</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/pages/scripts.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="intro-to-normative-modelling">
<h1>Intro to normative modelling<a class="headerlink" href="#intro-to-normative-modelling" title="Permalink to this headline">¶</a></h1>
<p>Normative modelling essentially aims to predict centiles of variance in a response variable (e.g. a region of interest or other neuroimaging-derived measure) on the basis of a set of covariates (e.g. age, clinical scores, diagnosis) A conceptual overview of the approach can be found in [this publication](<a class="reference external" href="https://www.nature.com/articles/s41380-019-0441-1">https://www.nature.com/articles/s41380-019-0441-1</a>). For example, the image below shows an example of a normative model that aims to predict vertex-wise cortical thickness data, essentially fitting a separate model for each vertex.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/nm_concept.png"><img alt="../_images/nm_concept.png" src="../_images/nm_concept.png" style="height: 300px;" /></a>
</div>
<p>In practice, this is done by regressing the biological response variables against a set of clinical or demographic covariates. In the instructions that follow, it is helpful to think of these as being stored in matrices as shown below:</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/nm_overview.png"><img alt="../_images/nm_overview.png" src="../_images/nm_overview.png" style="height: 300px;" /></a>
</div>
<p>There are many options for this, but techniques that provide a distributional form for the centiles are appealing, since they help to estimate extreme centiles more efficiently. Bayesian methods are also beneficial in this regard because they also allow separation of modelling uncertainty from variation in the data. Many applications of normative modelling use Gaussian Process Regression, which is the default method in this toolkit. Typically (but not [always](<a class="reference external" href="https://link.springer.com/chapter/10.1007/978-3-030-00931-1_15">https://link.springer.com/chapter/10.1007/978-3-030-00931-1_15</a>)), each response variable is estimated independently.</p>
<div class="section" id="data-formats">
<h2>Data formats<a class="headerlink" href="#data-formats" title="Permalink to this headline">¶</a></h2>
<p>Generally the covariates are specified in text format, roughly following the FSL convention in that the text file should contain one entry
(i.e. subject) per line, with columns space or tab separated and no headers. For example:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>head cov.txt
<span class="m">52</span> <span class="m">55</span> <span class="m">94</span> <span class="m">4</span>.6
<span class="m">49</span> <span class="m">43</span> <span class="m">59</span> <span class="m">4</span>.6
<span class="m">56</span> <span class="m">80</span> <span class="m">63</span> <span class="m">5</span>.6
<span class="m">39</span> <span class="m">48</span> <span class="m">42</span> <span class="m">4</span>.3
</pre></div>
</div>
<p>For the response variables, the following data formats are supported:</p>
<ul class="simple">
<li><p>NIfTI (e.g. .nii.gz or .img/.hdr)</p></li>
<li><p>CIFTI (e.g. .dtseries.nii)</p></li>
<li><p>Pickle/pandas (e.g. .pkl)</p></li>
<li><p>ASCII text (e.g. .txt, .csv, .tsv)</p></li>
</ul>
<p>For nifti/cifti formats, data should be in timeseries format with subjects along the time dimension and these images will be masked and reshaped into vectors. If no mask is specified, one will be created automatically from the image data.</p>
</div>
<div class="section" id="basic-usage-command-line">
<h2>Basic usage (command line)<a class="headerlink" href="#basic-usage-command-line" title="Permalink to this headline">¶</a></h2>
<p>The simplest method to estimate a normative model is using the <code class="docutils literal notranslate"><span class="pre">`normative.py`</span></code> script which can be run from the command line or imported as a python module. For example, the following command will estimate a normative model on the basis of the matrix of covariates and responses specified in cov.txt and resp.txt respectively. These are simply tab or space separated ASCII text files that contain the variables of interest, with one subject per row.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python normative.py -c cov.txt -k <span class="m">5</span> -a blr resp.txt
</pre></div>
</div>
<p>The argument <code class="docutils literal notranslate"><span class="pre">-a</span> <span class="pre">blr</span></code> tells the script to use Bayesian Linear regression rather than the default Gaussian process regression model and <code class="docutils literal notranslate"><span class="pre">-k</span> <span class="pre">5</span></code> tells the script to run internal 5-fold cross-validation across all subjects in the covariates and responses files. Alternatively, the model can be evaluated on a separate dataset by specifying test covariates (and optionally also test responses).
The following estimation algorithms are supported</p>
<p><strong>Table 1:</strong> Estimation algorithms
.. list-table:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>:widths: 50 50 50
:header-rows: 1

 * -key value
   -Description
   -Reference
 * -gpr (default)
   -Gaussian Process Regression
   -Marquand et al 2016 https://www.sciencedirect.com/science/article/pii/S0006322316000020
 * -hbr
   -Hierarchical Bayesian Regression
   -Kia et al 2020 https://arxiv.org/abs/2005.12055
 * -blr
   -Bayesian Linear Regression
   -Huertas et al 2017 https://www.sciencedirect.com/science/article/pii/S1053811917306560
 * -np
   -Neural Processes
   -Kia et al 2018 https://arxiv.org/abs/1812.04998
 * -rfa
   -Random Feature Approximation
   -Rahimi and Recht 2007 https://people.eecs.berkeley.edu/~brecht/papers/07.rah.rec.nips.pdf
</pre></div>
</div>
<p>Note that keyword arguments can also be specified from the command line to offer additional flexibility. For example, the following command will fit a normative model to the same data, but without standardizing the data first and additionally writing out model coefficients (this is not done by default because they can use a lot of disk space).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python normative.py -c cov.txt -k <span class="m">5</span> -a blr resp.txt <span class="nv">standardize</span><span class="o">=</span>False <span class="nv">savemodel</span><span class="o">=</span>True
</pre></div>
</div>
<p>A full set of keyword arguments is provided in the table below. At a minimum, a set of responses and covariates must be provided and either the corresponding number of cross-validation folds or a set of test covariates.</p>
<p><strong>Table 2:</strong> Keywords and command line arguments
.. list-table:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>:widths: 50 50 50
:header-rows: 1

 * -keyword
   -Command line shortcut
   -Description
 * -covfunc
   --c filename
   -Covariate file
 * -cvfolds
   --k num_folds
   -Number of cross-validation folds
 * -testcov
   --t filename
   -Test covariates
 * -testresp
   --r filename
   -Test responses
 * maskfile
   --m filename
   -mask to apply to the response variables (nifti/cifti only)
 * -alg
   --a algorithm
   -Estimation algorithm: &#39;gpr&#39; (default), &#39;blr&#39;, &#39;np&#39;, &#39;hbr&#39; or &#39;rfa&#39;. See table above.
 * -function
   --f function
   -function to call (estimate, predict, transfer, extend). See below
 * -standardize
   --s (skip)
   -Standardize the covariates and response variables using the training data
 * -configparam
   --x config
   -Pass the value of config to the estimation algorithm (deprecated)
 * -outputsuffix
 * -
   -Suffix to apply to the output variables
 * -saveoutput
   -
   - Write output (default = True)
 * -savemodel
   -
   -Save the model coefficients and meta-data (default = False)
 * -warp
   -
   -Warping function to apply to the responses (blr only)
</pre></div>
</div>
</div>
<div class="section" id="basic-usage-scripted">
<h2>Basic usage (scripted)<a class="headerlink" href="#basic-usage-scripted" title="Permalink to this headline">¶</a></h2>
<p>The same can be done by importing the estimate function from normative.py. For example, the following code snippet will: (i) mask the nifti data specified in resp_train.nii.gz using the mask specified (which must have the same voxel size as the response variables) (ii) fit a linear normative model to each voxel, (iii) apply this to make predictions using the test covariates and (iv) compute deviation scores and error metrics by comparing against the true test response variables.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pcntoolkit.normative</span> <span class="kn">import</span> <span class="n">estimate</span>

<span class="c1"># estimate a normative model</span>
<span class="n">estimate</span><span class="p">(</span><span class="s2">&quot;cov_train.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;resp_train.nii.gz&quot;</span><span class="p">,</span> <span class="n">maskfile</span><span class="o">=</span><span class="s2">&quot;mask.nii.gz&quot;</span><span class="p">,</span> \
        <span class="n">testresp</span><span class="o">=</span><span class="s2">&quot;resp_test.nii.gz&quot;</span><span class="p">,</span> <span class="n">testcov</span><span class="o">=</span><span class="s2">&quot;cov_test.txt&quot;</span><span class="p">,</span> <span class="n">alg</span><span class="o">=</span><span class="s2">&quot;blr&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The estimate function does all these operations in a single step. In some cases it may be desirable to separate these steps. For example, if a normative model has been estimated on a large dataset, it may be desirable to save the model before applying it to a new dataset (e.g. from a a different site). For example, the following code snippet will first fit a model, then apply it to a set of dummy covariates so that the normative model can be plotted</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pcntoolkit.normative</span> <span class="kn">import</span> <span class="n">estimate</span><span class="p">,</span> <span class="n">predict</span>

<span class="c1"># fit a normative model, using training covariates and responses</span>
<span class="c1"># then apply to test dataset. Saved with file suffix &#39;_estimate&#39;</span>
<span class="n">estimate</span><span class="p">(</span><span class="n">cov_file_tr</span><span class="p">,</span> <span class="n">resp_file_tr</span><span class="p">,</span> <span class="n">testresp</span><span class="o">=</span><span class="n">resp_file_te</span><span class="p">,</span> \
        <span class="n">testcov</span><span class="o">=</span><span class="n">cov_file_te</span><span class="p">,</span> <span class="n">alg</span><span class="o">=</span><span class="s1">&#39;blr&#39;</span><span class="p">,</span> <span class="n">optimizer</span> <span class="o">=</span> <span class="s1">&#39;powell&#39;</span><span class="p">,</span> \
        <span class="n">savemodel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">standardize</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

<span class="c1"># make predictions on a set of dummy covariates (with no responses)</span>
<span class="c1"># Saved with file suffix &#39;_predict&#39;</span>
<span class="n">yhat</span><span class="p">,</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">cov_file_dummy</span><span class="p">)</span>
</pre></div>
</div>
<p>For further information, see the [developer documentation](<a class="reference external" href="https://amarquand.github.io/PCNtoolkit/doc/build/html/modindex.html#module-normative">https://amarquand.github.io/PCNtoolkit/doc/build/html/modindex.html#module-normative</a>). The same can be achieved from the command line, using te <code class="docutils literal notranslate"><span class="pre">-f</span></code> argument, for example, by specifying <code class="docutils literal notranslate"><span class="pre">-f</span> <span class="pre">predict</span></code>.</p>
</div>
<div class="section" id="paralellising-estimation-to-speed-things-up">
<h2>Paralellising estimation to speed things up<a class="headerlink" href="#paralellising-estimation-to-speed-things-up" title="Permalink to this headline">¶</a></h2>
<p>Normative model estimation is typically quite computationally expensive, especially for large datasets. This is exacerbated by high-resolution data (e.g. voxelwise data). For such cases normative model estimation can be paralellised across multiple compute nodes which can be achieved using the <code class="docutils literal notranslate"><span class="pre">normative_parallel.py</span></code> script. This involves splitting the response matrix into a set of batches, each of a specified size, i.e.:</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/nm_parallel.png"><img alt="../_images/nm_parallel.png" src="../_images/nm_parallel.png" style="height: 300px;" /></a>
</div>
<p>Each of these are then submitted to a cluster and reassembled once the cluster jobs have been completed. The following code snippet illustrates this procedure:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pcntoolkit.normative_parallel</span> <span class="kn">import</span> <span class="n">execute_nm</span><span class="p">,</span> <span class="n">collect_nm</span><span class="p">,</span> <span class="n">delete_nm</span>

<span class="c1"># General config parameters</span>
<span class="n">normative_path</span> <span class="o">=</span> <span class="s1">&#39;/&lt;path-to-my&gt;/pcntoolkit/normative.py&#39;</span>
<span class="n">python_path</span><span class="o">=</span><span class="s1">&#39;/&lt;path-to-my&gt;/bin/python&#39;</span>
<span class="n">working_dir</span> <span class="o">=</span> <span class="s1">&#39;/&lt;where-results-will-be_stored&gt;/&#39;</span>
<span class="n">log_dir</span> <span class="o">=</span> <span class="s1">&#39;/&lt;where-logs-will-be_stored&gt;/&#39;</span>

<span class="c1"># cluster paramateters</span>
<span class="n">job_name</span> <span class="o">=</span> <span class="s1">&#39;nm_demo&#39;</span>   <span class="c1"># name for the cluster job</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">10</span>        <span class="c1"># number of models (e.g. voxels) per batch</span>
<span class="n">memory</span> <span class="o">=</span> <span class="s1">&#39;4gb&#39;</span>         <span class="c1"># memory required</span>
<span class="n">duration</span> <span class="o">=</span> <span class="s1">&#39;01:00:00&#39;</span>  <span class="c1"># walltime</span>
<span class="n">cluster</span> <span class="o">=</span> <span class="s1">&#39;torque&#39;</span>

<span class="c1"># fit the model. Specifying binary=True means results will be stored in .pkl format</span>
<span class="n">execute_nm</span><span class="p">(</span><span class="n">working_dir</span><span class="p">,</span> <span class="n">python_path</span><span class="p">,</span> <span class="n">normative_path</span><span class="p">,</span> <span class="n">job_name</span><span class="p">,</span> <span class="n">cov_file</span><span class="o">.</span><span class="n">txt</span><span class="p">,</span> \
        <span class="n">resp_file</span><span class="o">.</span><span class="n">pkl</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">memory</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">cluster_spec</span><span class="o">=</span><span class="n">cluster</span><span class="p">,</span> \
        <span class="n">cv_folds</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">log_path</span><span class="o">=</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># wait until jobs complete ...</span>

<span class="c1"># reassemble results</span>
<span class="n">collect_nm</span><span class="p">(</span><span class="n">working_dir</span><span class="p">,</span> <span class="n">job_name</span><span class="p">,</span> <span class="n">collect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># remove temporary files</span>
<span class="n">delete_nm</span><span class="p">(</span><span class="n">working_dir</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>At the present time, only ASCII and pickle format are supported using normative parallel. Note also that it may be necessary to customise the script to support your local cluster architecture. This can be done using fairly obvious modifications to the <code class="docutils literal notranslate"><span class="pre">execute_nm()</span></code> function.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../modindex.html" class="btn btn-neutral float-right" title="Module Index" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="pcntoolkit_background.html" class="btn btn-neutral float-left" title="PCNtoolkit Background" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, Andre F. Marquand.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>