

<!doctype html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>normative &#8212; Predictive Clinical Neuroscience Toolkit 0.17 documentation</title>
    <link rel="stylesheet" href="../_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <!--[if lt IE 9]>
    <script src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Predictive Clinical Neuroscience Toolkit 0.17 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">normative</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for normative</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/Users/andre/sfw/anaconda3/bin/python</span>

<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1">#  Usage:</span>
<span class="c1">#  python normative.py -m [maskfile] -k [number of CV folds] -c &lt;covariates&gt;</span>
<span class="c1">#                      -t [test covariates] -r [test responses] &lt;infile&gt;</span>
<span class="c1">#</span>
<span class="c1">#  Either the -k switch or -t switch should be specified, but not both.</span>
<span class="c1">#  If -t is selected, a set of responses should be provided with the -r switch</span>
<span class="c1">#</span>
<span class="c1">#  Written by A. Marquand</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">glob</span>

<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span>
<span class="k">try</span><span class="p">:</span>  <span class="c1"># run as a package if installed</span>
    <span class="kn">from</span> <span class="nn">pcntoolkit</span> <span class="kn">import</span> <span class="n">fileio</span>
    <span class="kn">from</span> <span class="nn">pcntoolkit</span> <span class="kn">import</span> <span class="n">configs</span>
    <span class="kn">from</span> <span class="nn">pcntoolkit.normative_model.norm_utils</span> <span class="kn">import</span> <span class="n">norm_init</span>
    <span class="kn">from</span> <span class="nn">pcntoolkit.utils</span> <span class="kn">import</span> <span class="n">compute_pearsonr</span><span class="p">,</span> <span class="n">CustomCV</span><span class="p">,</span> <span class="n">explained_var</span><span class="p">,</span> <span class="n">compute_MSLL</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="c1">#sys.path.append(os.path.join(path,&#39;normative_model&#39;))</span>
    <span class="k">del</span> <span class="n">path</span>

    <span class="kn">import</span> <span class="nn">fileio</span>
    <span class="kn">import</span> <span class="nn">configs</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">compute_pearsonr</span><span class="p">,</span> <span class="n">CustomCV</span><span class="p">,</span> <span class="n">explained_var</span><span class="p">,</span> <span class="n">compute_MSLL</span>
    <span class="kn">from</span> <span class="nn">normative_model.norm_utils</span> <span class="kn">import</span> <span class="n">norm_init</span>

<span class="n">PICKLE_PROTOCOL</span> <span class="o">=</span> <span class="n">configs</span><span class="o">.</span><span class="n">PICKLE_PROTOCOL</span>

<div class="viewcode-block" id="load_response_vars"><a class="viewcode-back" href="../modindex.html#normative.load_response_vars">[docs]</a><span class="k">def</span> <span class="nf">load_response_vars</span><span class="p">(</span><span class="n">datafile</span><span class="p">,</span> <span class="n">maskfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vol</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; load response variables (of any data type)&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">fileio</span><span class="o">.</span><span class="n">file_type</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;nifti&#39;</span><span class="p">:</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">load_nifti</span><span class="p">(</span><span class="n">datafile</span><span class="p">,</span> <span class="n">vol</span><span class="o">=</span><span class="n">vol</span><span class="p">)</span>
        <span class="n">volmask</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">create_mask</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">maskfile</span><span class="p">)</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">vol2vec</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">volmask</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>
        <span class="n">volmask</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">fileio</span><span class="o">.</span><span class="n">file_type</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;cifti&#39;</span><span class="p">:</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">T</span>

    <span class="k">return</span> <span class="n">Y</span><span class="p">,</span> <span class="n">volmask</span></div>


<div class="viewcode-block" id="get_args"><a class="viewcode-back" href="../modindex.html#normative.get_args">[docs]</a><span class="k">def</span> <span class="nf">get_args</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Parse command line arguments&quot;&quot;&quot;</span>

    <span class="c1"># parse arguments</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Normative Modeling&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;responses&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Function to call&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;func&quot;</span><span class="p">,</span> 
                        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;estimate&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;mask file&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;maskfile&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;covariates file&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;covfile&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-k&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;cross-validation folds&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;cvfolds&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-t&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;covariates (test data)&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;testcov&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-r&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;responses (test data)&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;testresp&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-a&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;algorithm&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;alg&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;gpr&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-x&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;algorithm specific config options&quot;</span><span class="p">,</span> 
                        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;configparam&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_false&#39;</span><span class="p">,</span> 
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Flag to skip standardization.&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;standardize&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;keyword_args&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">REMAINDER</span><span class="p">)</span>
    
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    
    <span class="c1"># Process required  arguemnts </span>
    <span class="n">wdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">curdir</span><span class="p">)</span>
    <span class="n">respfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wdir</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">responses</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">covfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s2">&quot;No covariates specified&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">covfile</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">covfile</span>
    
    <span class="c1"># Process optional arguments</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">maskfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">maskfile</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">maskfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wdir</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">maskfile</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">testcov</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">cvfolds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">testcov</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">testresp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cvfolds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">cvfolds</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running under &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cvfolds</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; fold cross-validation.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test covariates specified&quot;</span><span class="p">)</span>
        <span class="n">testcov</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">testcov</span>
        <span class="n">cvfolds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">testresp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">testresp</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No test response variables specified&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">testresp</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">testresp</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">cvfolds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ignoring cross-valdation specification (test data given)&quot;</span><span class="p">)</span>

    <span class="c1"># Process addtional keyword arguments. These are always added as strings</span>
    <span class="n">kw_args</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">keyword_args</span><span class="p">:</span>
        <span class="n">kw_arg</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
    
        <span class="n">exec</span><span class="p">(</span><span class="s2">&quot;kw_args.update({&#39;&quot;</span> <span class="o">+</span>  <span class="n">kw_arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39; : &quot;</span> <span class="o">+</span> 
                              <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kw_arg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="s2">&quot;})&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">respfile</span><span class="p">,</span> <span class="n">maskfile</span><span class="p">,</span> <span class="n">covfile</span><span class="p">,</span> <span class="n">cvfolds</span><span class="p">,</span> \
            <span class="n">testcov</span><span class="p">,</span> <span class="n">testresp</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">alg</span><span class="p">,</span> \
            <span class="n">args</span><span class="o">.</span><span class="n">configparam</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">standardize</span><span class="p">,</span> <span class="n">kw_args</span></div>
            

<div class="viewcode-block" id="evaluate"><a class="viewcode-back" href="../modindex.html#normative.evaluate">[docs]</a><span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">Yhat</span><span class="p">,</span> <span class="n">S2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mY</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sY</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Rho&#39;</span><span class="p">,</span> <span class="s1">&#39;RMSE&#39;</span><span class="p">,</span> <span class="s1">&#39;SMSE&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPV&#39;</span><span class="p">,</span> <span class="s1">&#39;MSLL&#39;</span><span class="p">]):</span>
    <span class="sd">&#39;&#39;&#39; Compute error metrics</span>
<span class="sd">    This function will compute error metrics based on a set of predictions Yhat</span>
<span class="sd">    and a set of true response variables Y, namely:</span>
<span class="sd">    </span>
<span class="sd">    * Rho: Pearson correlation</span>
<span class="sd">    * RMSE: root mean squared error</span>
<span class="sd">    * SMSE: standardized mean squared error</span>
<span class="sd">    * EXPV: explained variance</span>
<span class="sd">        </span>
<span class="sd">    If the predictive variance is also specified the log loss will be computed</span>
<span class="sd">    (which also takes into account the predictive variance). If the mean and </span>
<span class="sd">    standard deviation are also specified these will be used to standardize </span>
<span class="sd">    this, yielding the mean standardized log loss</span>
<span class="sd">    </span>
<span class="sd">    :param Y: N x P array of true response variables</span>
<span class="sd">    :param Yhat: N x P array of predicted response variables</span>
<span class="sd">    :param S2: predictive variance</span>
<span class="sd">    :param mY: mean of the training set</span>
<span class="sd">    :param sY: standard deviation of the training set</span>

<span class="sd">    :returns metrics: evaluation metrics</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">feature_num</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="c1"># Remove metrics that cannot be computed with only a single data point </span>
    <span class="k">if</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;MSLL&#39;</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="n">metrics</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;MSLL&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;SMSE&#39;</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="n">metrics</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;SMSE&#39;</span><span class="p">)</span>
    
    <span class="c1"># find and remove bad variables from the response variables</span>
    <span class="n">nz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="n">MSE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">Y</span> <span class="o">-</span> <span class="n">Yhat</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="s1">&#39;RMSE&#39;</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
        <span class="n">RMSE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">MSE</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;RMSE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RMSE</span>
    
    <span class="k">if</span> <span class="s1">&#39;Rho&#39;</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
        <span class="n">Rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">feature_num</span><span class="p">)</span>
        <span class="n">pRho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">feature_num</span><span class="p">)</span>    
        <span class="n">Rho</span><span class="p">[</span><span class="n">nz</span><span class="p">],</span> <span class="n">pRho</span><span class="p">[</span><span class="n">nz</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_pearsonr</span><span class="p">(</span><span class="n">Y</span><span class="p">[:,</span><span class="n">nz</span><span class="p">],</span> <span class="n">Yhat</span><span class="p">[:,</span><span class="n">nz</span><span class="p">])</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Rho&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Rho</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;pRho&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pRho</span>
        
    <span class="k">if</span> <span class="s1">&#39;SMSE&#39;</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
        <span class="n">SMSE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">MSE</span><span class="p">)</span>
        <span class="n">SMSE</span><span class="p">[</span><span class="n">nz</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSE</span><span class="p">[</span><span class="n">nz</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">Y</span><span class="p">[:,</span><span class="n">nz</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;SMSE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SMSE</span>
    
    <span class="k">if</span> <span class="s1">&#39;EXPV&#39;</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
        <span class="n">EXPV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">feature_num</span><span class="p">)</span>
        <span class="n">EXPV</span><span class="p">[</span><span class="n">nz</span><span class="p">]</span> <span class="o">=</span> <span class="n">explained_var</span><span class="p">(</span><span class="n">Y</span><span class="p">[:,</span><span class="n">nz</span><span class="p">],</span> <span class="n">Yhat</span><span class="p">[:,</span><span class="n">nz</span><span class="p">])</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;EXPV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">EXPV</span>
        
    <span class="k">if</span> <span class="s1">&#39;MSLL&#39;</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">S2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mY</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sY</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)):</span>
            <span class="n">MSLL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">feature_num</span><span class="p">)</span>
            <span class="n">MSLL</span><span class="p">[</span><span class="n">nz</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_MSLL</span><span class="p">(</span><span class="n">Y</span><span class="p">[:,</span><span class="n">nz</span><span class="p">],</span> <span class="n">Yhat</span><span class="p">[:,</span><span class="n">nz</span><span class="p">],</span> <span class="n">S2</span><span class="p">[:,</span><span class="n">nz</span><span class="p">],</span> 
                                    <span class="n">mY</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> 
                                    <span class="p">(</span><span class="n">sY</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MSLL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSLL</span>
    
    <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="save_results"><a class="viewcode-back" href="../modindex.html#normative.save_results">[docs]</a><span class="k">def</span> <span class="nf">save_results</span><span class="p">(</span><span class="n">respfile</span><span class="p">,</span> <span class="n">Yhat</span><span class="p">,</span> <span class="n">S2</span><span class="p">,</span> <span class="n">maskvol</span><span class="p">,</span> <span class="n">Z</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outputsuffix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                 <span class="n">results</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing outputs ...&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">respfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">exfile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">file_ext</span> <span class="o">=</span> <span class="s1">&#39;.pkl&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fileio</span><span class="o">.</span><span class="n">file_type</span><span class="p">(</span><span class="n">respfile</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;cifti&#39;</span> <span class="ow">or</span> \
           <span class="n">fileio</span><span class="o">.</span><span class="n">file_type</span><span class="p">(</span><span class="n">respfile</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;nifti&#39;</span><span class="p">:</span>
            <span class="n">exfile</span> <span class="o">=</span> <span class="n">respfile</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exfile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">file_ext</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">respfile</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">outputsuffix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">outputsuffix</span><span class="p">)</span> <span class="o">+</span> <span class="n">file_ext</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">file_ext</span>

    <span class="n">fileio</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">Yhat</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;yhat&#39;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">),</span> <span class="n">example</span><span class="o">=</span><span class="n">exfile</span><span class="p">,</span> 
                                   <span class="n">mask</span><span class="o">=</span><span class="n">maskvol</span><span class="p">)</span>
    <span class="n">fileio</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">S2</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;ys2&#39;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">),</span> <span class="n">example</span><span class="o">=</span><span class="n">exfile</span><span class="p">,</span> 
                <span class="n">mask</span><span class="o">=</span><span class="n">maskvol</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fileio</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">),</span> <span class="n">example</span><span class="o">=</span><span class="n">exfile</span><span class="p">,</span> 
                    <span class="n">mask</span><span class="o">=</span><span class="n">maskvol</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>        
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">fileio</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">metric</span> <span class="o">+</span> <span class="n">ext</span><span class="p">),</span> 
                        <span class="n">example</span><span class="o">=</span><span class="n">exfile</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">maskvol</span><span class="p">)</span></div>

<div class="viewcode-block" id="estimate"><a class="viewcode-back" href="../modindex.html#normative.estimate">[docs]</a><span class="k">def</span> <span class="nf">estimate</span><span class="p">(</span><span class="n">covfile</span><span class="p">,</span> <span class="n">respfile</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Estimate a normative model</span>

<span class="sd">    This will estimate a model in one of two settings according to theparticular parameters specified (see below)</span>
<span class="sd">        </span>
<span class="sd">    * under k-fold cross-validation.</span>
<span class="sd">      requires respfile, covfile and cvfolds&gt;=2</span>
<span class="sd">    * estimating a training dataset then applying to a second test dataset.</span>
<span class="sd">      requires respfile, covfile, testcov and testresp.</span>
<span class="sd">    * estimating on a training dataset ouput of forward maps mean and se. </span>
<span class="sd">      requires respfile, covfile and testcov</span>

<span class="sd">    The models are estimated on the basis of data stored on disk in ascii or</span>
<span class="sd">    neuroimaging data formats (nifti or cifti). Ascii data should be in</span>
<span class="sd">    tab or space delimited format with the number of subjects in rows and the</span>
<span class="sd">    number of variables in columns. Neuroimaging data will be reshaped</span>
<span class="sd">    into the appropriate format</span>

<span class="sd">    Basic usage::</span>

<span class="sd">        estimate(covfile, respfile, [extra_arguments])</span>

<span class="sd">    where the variables are defined below. Note that either the cfolds</span>
<span class="sd">    parameter or (testcov, testresp) should be specified, but not both.</span>

<span class="sd">    :param respfile: response variables for the normative model</span>
<span class="sd">    :param covfile: covariates used to predict the response variable</span>
<span class="sd">    :param maskfile: mask used to apply to the data (nifti only)</span>
<span class="sd">    :param cvfolds: Number of cross-validation folds</span>
<span class="sd">    :param testcov: Test covariates</span>
<span class="sd">    :param testresp: Test responses</span>
<span class="sd">    :param alg: Algorithm for normative model</span>
<span class="sd">    :param configparam: Parameters controlling the estimation algorithm</span>
<span class="sd">    :param saveoutput: Save the output to disk? Otherwise returned as arrays</span>
<span class="sd">    :param outputsuffix: Text string to add to the output filenames</span>

<span class="sd">    All outputs are written to disk in the same format as the input. These are:</span>

<span class="sd">    :outputs: * yhat - predictive mean</span>
<span class="sd">              * ys2 - predictive variance</span>
<span class="sd">              * nm - normative model</span>
<span class="sd">              * Z - deviance scores</span>
<span class="sd">              * Rho - Pearson correlation between true and predicted responses</span>
<span class="sd">              * pRho - parametric p-value for this correlation</span>
<span class="sd">              * rmse - root mean squared error between true/predicted responses</span>
<span class="sd">              * smse - standardised mean squared error</span>

<span class="sd">    The outputsuffix may be useful to estimate multiple normative models in the</span>
<span class="sd">    same directory (e.g. for custom cross-validation schemes)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># parse keyword arguments </span>
    <span class="n">maskfile</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;maskfile&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">cvfolds</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;cvfolds&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">testcov</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;testcov&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">testresp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;testresp&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">alg</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;alg&#39;</span><span class="p">,</span><span class="s1">&#39;gpr&#39;</span><span class="p">)</span>
    <span class="n">outputsuffix</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;outputsuffix&#39;</span><span class="p">,</span><span class="s1">&#39;_estimate&#39;</span><span class="p">)</span>
    <span class="n">standardize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;standardize&#39;</span><span class="p">,</span><span class="s1">&#39;True&#39;</span><span class="p">)</span>
    <span class="n">warp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;warp&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># convert from strings if necessary</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">standardize</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">standardize</span> <span class="o">=</span> <span class="n">standardize</span><span class="o">==</span><span class="s1">&#39;True&#39;</span>
    <span class="n">saveoutput</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;saveoutput&#39;</span><span class="p">,</span><span class="s1">&#39;True&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">saveoutput</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">saveoutput</span> <span class="o">=</span> <span class="n">saveoutput</span><span class="o">==</span><span class="s1">&#39;True&#39;</span>
    <span class="n">savemodel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;savemodel&#39;</span><span class="p">,</span><span class="s1">&#39;False&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">savemodel</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">savemodel</span> <span class="o">=</span> <span class="n">savemodel</span><span class="o">==</span><span class="s1">&#39;True&#39;</span>
    
    <span class="k">if</span> <span class="n">savemodel</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s1">&#39;Models&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s1">&#39;Models&#39;</span><span class="p">)</span>

    <span class="c1"># load data</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing data in &quot;</span> <span class="o">+</span> <span class="n">respfile</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">covfile</span><span class="p">)</span>
    <span class="n">Y</span><span class="p">,</span> <span class="n">maskvol</span> <span class="o">=</span> <span class="n">load_response_vars</span><span class="p">(</span><span class="n">respfile</span><span class="p">,</span> <span class="n">maskfile</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">Nmod</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">testcov</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">cvfolds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="c1"># we have a separate test dataset</span>
        
        <span class="n">run_cv</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">cvfolds</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">Xte</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">testcov</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Xte</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Xte</span> <span class="o">=</span> <span class="n">Xte</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">testresp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Yte</span><span class="p">,</span> <span class="n">testmask</span> <span class="o">=</span> <span class="n">load_response_vars</span><span class="p">(</span><span class="n">testresp</span><span class="p">,</span> <span class="n">maskfile</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Yte</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">Yte</span> <span class="o">=</span> <span class="n">Yte</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sub_te</span> <span class="o">=</span> <span class="n">Xte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">Yte</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">sub_te</span><span class="p">,</span> <span class="n">Nmod</span><span class="p">])</span>
            
        <span class="c1"># treat as a single train-test split</span>
        <span class="n">testids</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">Xte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">splits</span> <span class="o">=</span> <span class="n">CustomCV</span><span class="p">((</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),),</span> <span class="p">(</span><span class="n">testids</span><span class="p">,))</span>

        <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Y</span><span class="p">,</span> <span class="n">Yte</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">X</span><span class="p">,</span> <span class="n">Xte</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">run_cv</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># we are running under cross-validation</span>
        <span class="n">splits</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">cvfolds</span><span class="p">)</span>
        <span class="n">testids</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># find and remove bad variables from the response variables</span>
    <span class="c1"># note: the covariates are assumed to have already been checked</span>
    <span class="n">nz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># run cross-validation loop</span>
    <span class="n">Yhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
    <span class="n">S2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
    <span class="n">nlZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nmod</span><span class="p">,</span> <span class="n">cvfolds</span><span class="p">))</span>
    
    <span class="n">mean_resp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">std_resp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mean_cov</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">std_cov</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">if</span> <span class="n">warp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Ywarp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Yhat</span><span class="p">)</span>
        <span class="n">mean_resp_warp</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">splits</span><span class="o">.</span><span class="n">n_splits</span><span class="p">)]</span>
        <span class="n">std_resp_warp</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">splits</span><span class="o">.</span><span class="n">n_splits</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">splits</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">)):</span>

        <span class="n">fold</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">te</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># standardize responses and covariates, ignoring invalid entries</span>
        <span class="n">iy</span><span class="p">,</span> <span class="n">jy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">nz</span><span class="p">)</span>
        <span class="n">mY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">jy</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">sY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">jy</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mean_resp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mY</span><span class="p">)</span>
        <span class="n">std_resp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sY</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">standardize</span><span class="p">:</span>
            <span class="n">Yz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
            <span class="n">Yz</span><span class="p">[:,</span> <span class="n">nz</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y</span><span class="p">[:,</span> <span class="n">nz</span><span class="p">]</span> <span class="o">-</span> <span class="n">mY</span><span class="p">)</span> <span class="o">/</span> <span class="n">sY</span>
            <span class="n">mX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">tr</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">sX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">tr</span><span class="p">,</span> <span class="p">:],</span>  <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">Xz</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">mX</span><span class="p">)</span> <span class="o">/</span> <span class="n">sX</span>
            <span class="n">mean_cov</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mX</span><span class="p">)</span>
            <span class="n">std_cov</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sX</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Yz</span> <span class="o">=</span> <span class="n">Y</span>
            <span class="n">Xz</span> <span class="o">=</span> <span class="n">X</span>
            
        <span class="c1"># estimate the models for all subjects</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nz</span><span class="p">)):</span>  
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Estimating model &quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;of&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nz</span><span class="p">))</span>
            <span class="n">nm</span> <span class="o">=</span> <span class="n">norm_init</span><span class="p">(</span><span class="n">Xz</span><span class="p">[</span><span class="n">tr</span><span class="p">,</span> <span class="p">:],</span> <span class="n">Yz</span><span class="p">[</span><span class="n">tr</span><span class="p">,</span> <span class="n">nz</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">alg</span><span class="o">=</span><span class="n">alg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span> 
                <span class="n">nm</span> <span class="o">=</span> <span class="n">nm</span><span class="o">.</span><span class="n">estimate</span><span class="p">(</span><span class="n">Xz</span><span class="p">[</span><span class="n">tr</span><span class="p">,</span> <span class="p">:],</span> <span class="n">Yz</span><span class="p">[</span><span class="n">tr</span><span class="p">,</span> <span class="n">nz</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>     
                
                <span class="n">yhat</span><span class="p">,</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">nm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xz</span><span class="p">[</span><span class="n">te</span><span class="p">,</span> <span class="p">:],</span> <span class="n">Xz</span><span class="p">[</span><span class="n">tr</span><span class="p">,</span> <span class="p">:],</span> <span class="n">Yz</span><span class="p">[</span><span class="n">tr</span><span class="p">,</span> <span class="n">nz</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">savemodel</span><span class="p">:</span>
                    <span class="n">nm</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;Models/NM_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fold</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nz</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">outputsuffix</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span> <span class="p">)</span>
                
                <span class="k">if</span> <span class="n">standardize</span><span class="p">:</span>
                    <span class="n">Yhat</span><span class="p">[</span><span class="n">te</span><span class="p">,</span> <span class="n">nz</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">yhat</span> <span class="o">*</span> <span class="n">sY</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">mY</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">S2</span><span class="p">[</span><span class="n">te</span><span class="p">,</span> <span class="n">nz</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">s2</span> <span class="o">*</span> <span class="n">sY</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Yhat</span><span class="p">[</span><span class="n">te</span><span class="p">,</span> <span class="n">nz</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">yhat</span>
                    <span class="n">S2</span><span class="p">[</span><span class="n">te</span><span class="p">,</span> <span class="n">nz</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">s2</span>
                    
                <span class="n">nlZ</span><span class="p">[</span><span class="n">nz</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fold</span><span class="p">]</span> <span class="o">=</span> <span class="n">nm</span><span class="o">.</span><span class="n">neg_log_lik</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="n">run_cv</span> <span class="ow">or</span> <span class="n">testresp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="c1"># warp the labels?</span>
                    <span class="k">if</span> <span class="n">warp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">warp_param</span> <span class="o">=</span> <span class="n">nm</span><span class="o">.</span><span class="n">blr</span><span class="o">.</span><span class="n">hyp</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nm</span><span class="o">.</span><span class="n">blr</span><span class="o">.</span><span class="n">warp</span><span class="o">.</span><span class="n">get_n_params</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> 
                        <span class="n">Ywarp</span><span class="p">[</span><span class="n">te</span><span class="p">,</span> <span class="n">nz</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">nm</span><span class="o">.</span><span class="n">blr</span><span class="o">.</span><span class="n">warp</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">te</span><span class="p">,</span> <span class="n">nz</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">warp_param</span><span class="p">)</span>
                        <span class="n">Ytest</span> <span class="o">=</span> <span class="n">Ywarp</span><span class="p">[</span><span class="n">te</span><span class="p">,</span> <span class="n">nz</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                        
                        <span class="c1"># Save warped mean of the training data (for MSLL)</span>
                        <span class="n">yw</span> <span class="o">=</span> <span class="n">nm</span><span class="o">.</span><span class="n">blr</span><span class="o">.</span><span class="n">warp</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">tr</span><span class="p">,</span> <span class="n">nz</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">warp_param</span><span class="p">)</span>
                        <span class="n">mean_resp_warp</span><span class="p">[</span><span class="n">fold</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">yw</span><span class="p">)</span>
                        <span class="n">std_resp_warp</span><span class="p">[</span><span class="n">fold</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">yw</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">Ytest</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">te</span><span class="p">,</span> <span class="n">nz</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> 
                    
                    <span class="n">Z</span><span class="p">[</span><span class="n">te</span><span class="p">,</span> <span class="n">nz</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Ytest</span> <span class="o">-</span> <span class="n">Yhat</span><span class="p">[</span><span class="n">te</span><span class="p">,</span> <span class="n">nz</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="o">/</span> \
                                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">S2</span><span class="p">[</span><span class="n">te</span><span class="p">,</span> <span class="n">nz</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>       
                    
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_obj</span><span class="p">,</span> <span class="n">exc_tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">exc_tb</span><span class="o">.</span><span class="n">tb_frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model &quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;of&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nz</span><span class="p">),</span>
                      <span class="s2">&quot;FAILED!..skipping and writing NaN to outputs&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">exc_tb</span><span class="o">.</span><span class="n">tb_lineno</span><span class="p">)</span>

                <span class="n">Yhat</span><span class="p">[</span><span class="n">te</span><span class="p">,</span> <span class="n">nz</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
                <span class="n">S2</span><span class="p">[</span><span class="n">te</span><span class="p">,</span> <span class="n">nz</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
                <span class="n">nlZ</span><span class="p">[</span><span class="n">nz</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fold</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">testcov</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">Z</span><span class="p">[</span><span class="n">te</span><span class="p">,</span> <span class="n">nz</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">testresp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">Z</span><span class="p">[</span><span class="n">te</span><span class="p">,</span> <span class="n">nz</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">savemodel</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving model meta-data...&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;Models/meta_data.md&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">({</span><span class="s1">&#39;valid_voxels&#39;</span><span class="p">:</span><span class="n">nz</span><span class="p">,</span> <span class="s1">&#39;fold_num&#39;</span><span class="p">:</span><span class="n">cvfolds</span><span class="p">,</span> 
                         <span class="s1">&#39;mean_resp&#39;</span><span class="p">:</span><span class="n">mean_resp</span><span class="p">,</span> <span class="s1">&#39;std_resp&#39;</span><span class="p">:</span><span class="n">std_resp</span><span class="p">,</span> 
                         <span class="s1">&#39;mean_cov&#39;</span><span class="p">:</span><span class="n">mean_cov</span><span class="p">,</span> <span class="s1">&#39;std_cov&#39;</span><span class="p">:</span><span class="n">std_cov</span><span class="p">,</span> 
                         <span class="s1">&#39;regressor&#39;</span><span class="p">:</span><span class="n">alg</span><span class="p">,</span> <span class="s1">&#39;standardize&#39;</span><span class="p">:</span><span class="n">standardize</span><span class="p">},</span> <span class="n">file</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">PICKLE_PROTOCOL</span><span class="p">)</span>    

    <span class="c1"># compute performance metrics</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">run_cv</span> <span class="ow">or</span> <span class="n">testresp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluating the model ...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">warp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">testids</span><span class="p">,</span> <span class="p">:],</span> <span class="n">Yhat</span><span class="p">[</span><span class="n">testids</span><span class="p">,</span> <span class="p">:],</span> 
                               <span class="n">S2</span><span class="o">=</span><span class="n">S2</span><span class="p">[</span><span class="n">testids</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mY</span><span class="o">=</span><span class="n">mean_resp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                               <span class="n">sY</span><span class="o">=</span><span class="n">std_resp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">Ywarp</span><span class="p">[</span><span class="n">testids</span><span class="p">,</span> <span class="p">:],</span> <span class="n">Yhat</span><span class="p">[</span><span class="n">testids</span><span class="p">,</span> <span class="p">:],</span> 
                               <span class="n">S2</span><span class="o">=</span><span class="n">S2</span><span class="p">[</span><span class="n">testids</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mY</span><span class="o">=</span><span class="n">mean_resp_warp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                               <span class="n">sY</span><span class="o">=</span><span class="n">std_resp_warp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        
        
    <span class="c1"># Set writing options</span>
    <span class="k">if</span> <span class="n">saveoutput</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">run_cv</span> <span class="ow">or</span> <span class="n">testresp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">save_results</span><span class="p">(</span><span class="n">respfile</span><span class="p">,</span> <span class="n">Yhat</span><span class="p">[</span><span class="n">testids</span><span class="p">,</span> <span class="p">:],</span> <span class="n">S2</span><span class="p">[</span><span class="n">testids</span><span class="p">,</span> <span class="p">:],</span> <span class="n">maskvol</span><span class="p">,</span> 
                         <span class="n">Z</span><span class="o">=</span><span class="n">Z</span><span class="p">[</span><span class="n">testids</span><span class="p">,</span> <span class="p">:],</span> <span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">,</span> <span class="n">outputsuffix</span><span class="o">=</span><span class="n">outputsuffix</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">save_results</span><span class="p">(</span><span class="n">respfile</span><span class="p">,</span> <span class="n">Yhat</span><span class="p">[</span><span class="n">testids</span><span class="p">,</span> <span class="p">:],</span> <span class="n">S2</span><span class="p">[</span><span class="n">testids</span><span class="p">,</span> <span class="p">:],</span> <span class="n">maskvol</span><span class="p">,</span>
                         <span class="n">outputsuffix</span><span class="o">=</span><span class="n">outputsuffix</span><span class="p">)</span>
                
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">run_cv</span> <span class="ow">or</span> <span class="n">testresp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">output</span> <span class="o">=</span> <span class="p">(</span><span class="n">Yhat</span><span class="p">[</span><span class="n">testids</span><span class="p">,</span> <span class="p">:],</span> <span class="n">S2</span><span class="p">[</span><span class="n">testids</span><span class="p">,</span> <span class="p">:],</span> <span class="n">nm</span><span class="p">,</span> <span class="n">Z</span><span class="p">[</span><span class="n">testids</span><span class="p">,</span> <span class="p">:],</span> <span class="n">results</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="p">(</span><span class="n">Yhat</span><span class="p">[</span><span class="n">testids</span><span class="p">,</span> <span class="p">:],</span> <span class="n">S2</span><span class="p">[</span><span class="n">testids</span><span class="p">,</span> <span class="p">:],</span> <span class="n">nm</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="fit"><a class="viewcode-back" href="../modindex.html#normative.fit">[docs]</a><span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="n">covfile</span><span class="p">,</span> <span class="n">respfile</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    
    <span class="c1"># parse keyword arguments </span>
    <span class="n">maskfile</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;maskfile&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">alg</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;alg&#39;</span><span class="p">,</span><span class="s1">&#39;gpr&#39;</span><span class="p">)</span>
    <span class="n">savemodel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;savemodel&#39;</span><span class="p">,</span><span class="s1">&#39;True&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;True&#39;</span>
    <span class="n">standardize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;standardize&#39;</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">outputsuffix</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;outputsuffix&#39;</span><span class="p">,</span><span class="s1">&#39;_fit&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">savemodel</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s1">&#39;Models&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s1">&#39;Models&#39;</span><span class="p">)</span>

    <span class="c1"># load data</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing data in &quot;</span> <span class="o">+</span> <span class="n">respfile</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">covfile</span><span class="p">)</span>
    <span class="n">Y</span><span class="p">,</span> <span class="n">maskvol</span> <span class="o">=</span> <span class="n">load_response_vars</span><span class="p">(</span><span class="n">respfile</span><span class="p">,</span> <span class="n">maskfile</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    
    <span class="c1"># find and remove bad variables from the response variables</span>
    <span class="c1"># note: the covariates are assumed to have already been checked</span>
    <span class="n">nz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">mean_resp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">std_resp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mean_cov</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">std_cov</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># standardize responses and covariates, ignoring invalid entries</span>
    <span class="n">mY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y</span><span class="p">[:,</span> <span class="n">nz</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">sY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">Y</span><span class="p">[:,</span> <span class="n">nz</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">mean_resp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mY</span><span class="p">)</span>
    <span class="n">std_resp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sY</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">standardize</span><span class="p">:</span>
        <span class="n">Yz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
        <span class="n">Yz</span><span class="p">[:,</span> <span class="n">nz</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y</span><span class="p">[:,</span> <span class="n">nz</span><span class="p">]</span> <span class="o">-</span> <span class="n">mY</span><span class="p">)</span> <span class="o">/</span> <span class="n">sY</span>
        <span class="n">mX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">sX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">X</span><span class="p">,</span>  <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Xz</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">mX</span><span class="p">)</span> <span class="o">/</span> <span class="n">sX</span>
        <span class="n">mean_resp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mY</span><span class="p">)</span>
        <span class="n">std_resp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sY</span><span class="p">)</span>
        <span class="n">mean_cov</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mX</span><span class="p">)</span>
        <span class="n">std_cov</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sX</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Yz</span> <span class="o">=</span> <span class="n">Y</span>
        <span class="n">Xz</span> <span class="o">=</span> <span class="n">X</span>

    <span class="c1"># estimate the models for all subjects</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nz</span><span class="p">)):</span>  
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Estimating model &quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;of&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nz</span><span class="p">))</span>
        <span class="n">nm</span> <span class="o">=</span> <span class="n">norm_init</span><span class="p">(</span><span class="n">Xz</span><span class="p">,</span> <span class="n">Yz</span><span class="p">[:,</span> <span class="n">nz</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">alg</span><span class="o">=</span><span class="n">alg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">nm</span> <span class="o">=</span> <span class="n">nm</span><span class="o">.</span><span class="n">estimate</span><span class="p">(</span><span class="n">Xz</span><span class="p">,</span> <span class="n">Yz</span><span class="p">[:,</span> <span class="n">nz</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>     
            
        <span class="k">if</span> <span class="n">savemodel</span><span class="p">:</span>
            <span class="n">nm</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;Models/NM_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nz</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">outputsuffix</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span> <span class="p">)</span>

    <span class="k">if</span> <span class="n">savemodel</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving model meta-data...&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;Models/meta_data.md&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">({</span><span class="s1">&#39;valid_voxels&#39;</span><span class="p">:</span><span class="n">nz</span><span class="p">,</span>
                         <span class="s1">&#39;mean_resp&#39;</span><span class="p">:</span><span class="n">mean_resp</span><span class="p">,</span> <span class="s1">&#39;std_resp&#39;</span><span class="p">:</span><span class="n">std_resp</span><span class="p">,</span> 
                         <span class="s1">&#39;mean_cov&#39;</span><span class="p">:</span><span class="n">mean_cov</span><span class="p">,</span> <span class="s1">&#39;std_cov&#39;</span><span class="p">:</span><span class="n">std_cov</span><span class="p">,</span> 
                         <span class="s1">&#39;regressor&#39;</span><span class="p">:</span><span class="n">alg</span><span class="p">,</span> <span class="s1">&#39;standardize&#39;</span><span class="p">:</span><span class="n">standardize</span><span class="p">},</span> <span class="n">file</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">PICKLE_PROTOCOL</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">nm</span></div>

    
<div class="viewcode-block" id="predict"><a class="viewcode-back" href="../modindex.html#normative.predict">[docs]</a><span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">covfile</span><span class="p">,</span> <span class="n">respfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maskfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Make predictions on the basis of a pre-estimated normative model </span>
<span class="sd">    If only the covariates are specified then only predicted mean and variance </span>
<span class="sd">    will be returned. If the test responses are also specified then quantities</span>
<span class="sd">    That depend on those will also be returned (Z scores and error metrics)</span>

<span class="sd">    Basic usage::</span>

<span class="sd">        predict(covfile, [extra_arguments])</span>

<span class="sd">    where the variables are defined below.</span>

<span class="sd">    :param covfile: test covariates used to predict the response variable</span>
<span class="sd">    :param respfile: test response variables for the normative model</span>
<span class="sd">    :param maskfile: mask used to apply to the data (nifti only)</span>
<span class="sd">    :param model_path: Directory containing the normative model and metadata.</span>
<span class="sd">     When using parallel prediction, do not pass the model path. It will be automatically</span>
<span class="sd">     decided.</span>
<span class="sd">    :param output_path: Directory to store the results</span>
<span class="sd">    :param outputsuffix: Text string to add to the output filenames</span>
<span class="sd">    :param batch_size: batch size (for use with normative_parallel)</span>
<span class="sd">    :param job_id: batch id</span>

<span class="sd">    All outputs are written to disk in the same format as the input. These are:</span>

<span class="sd">    :outputs: * Yhat - predictive mean</span>
<span class="sd">              * S2 - predictive variance</span>
<span class="sd">              * Z - Z scores</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    
    <span class="n">model_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;model_path&#39;</span><span class="p">,</span> <span class="s1">&#39;Models&#39;</span><span class="p">)</span>
    <span class="n">job_id</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;job_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;batch_size&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">output_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;output_path&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">outputsuffix</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;outputsuffix&#39;</span><span class="p">,</span> <span class="s1">&#39;_predict&#39;</span><span class="p">)</span>
    <span class="n">inputsuffix</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;inputsuffix&#39;</span><span class="p">,</span> <span class="s1">&#39;_estimate&#39;</span><span class="p">)</span>
    <span class="n">alg</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;alg&#39;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">respfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">respfile</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Response file does not exist. Only returning predictions&quot;</span><span class="p">)</span>
        <span class="n">respfile</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">model_path</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Models directory does not exist!&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;meta_data.md&#39;</span><span class="p">)):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;meta_data.md&#39;</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">meta_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="n">standardize</span> <span class="o">=</span> <span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;standardize&#39;</span><span class="p">]</span>
            <span class="n">mY</span> <span class="o">=</span> <span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;mean_resp&#39;</span><span class="p">]</span>
            <span class="n">sY</span> <span class="o">=</span> <span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;std_resp&#39;</span><span class="p">]</span>
            <span class="n">mX</span> <span class="o">=</span> <span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;mean_cov&#39;</span><span class="p">]</span>
            <span class="n">sX</span> <span class="o">=</span> <span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;std_cov&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">standardize</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">output_path</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">output_path</span><span class="p">)):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
    
    <span class="c1"># load data</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading data ...&quot;</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">covfile</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    
    <span class="n">sample_num</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">feature_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;NM_*&#39;</span> <span class="o">+</span> <span class="n">inputsuffix</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">)))</span>

    <span class="n">Yhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">sample_num</span><span class="p">,</span> <span class="n">feature_num</span><span class="p">])</span>
    <span class="n">S2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">sample_num</span><span class="p">,</span> <span class="n">feature_num</span><span class="p">])</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">sample_num</span><span class="p">,</span> <span class="n">feature_num</span><span class="p">])</span>
    
        
    <span class="k">if</span> <span class="n">standardize</span><span class="p">:</span>
        <span class="n">Xz</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">mX</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">sX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Xz</span> <span class="o">=</span> <span class="n">X</span>
        
    <span class="c1"># estimate the models for all subjects</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">feature_num</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Prediction by model &quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;of&quot;</span><span class="p">,</span> <span class="n">feature_num</span><span class="p">)</span>      
        <span class="n">nm</span> <span class="o">=</span> <span class="n">norm_init</span><span class="p">(</span><span class="n">Xz</span><span class="p">)</span>
        <span class="n">nm</span> <span class="o">=</span> <span class="n">nm</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;NM_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> 
                                  <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">inputsuffix</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">alg</span><span class="o">!=</span><span class="s1">&#39;hbr&#39;</span> <span class="ow">or</span> <span class="n">nm</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="s1">&#39;transferred&#39;</span><span class="p">]</span><span class="o">==</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">yhat</span><span class="p">,</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">nm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xz</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tsbefile</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;tsbefile&#39;</span><span class="p">)</span> 
            <span class="n">batch_effects_test</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">tsbefile</span><span class="p">)</span>
            <span class="n">yhat</span><span class="p">,</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">nm</span><span class="o">.</span><span class="n">predict_on_new_sites</span><span class="p">(</span><span class="n">Xz</span><span class="p">,</span> <span class="n">batch_effects_test</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">standardize</span><span class="p">:</span>
            <span class="n">Yhat</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">yhat</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">*</span> <span class="n">sY</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">mY</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">S2</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s2</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">*</span> <span class="n">sY</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Yhat</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">yhat</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">S2</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s2</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">respfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">save_results</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Yhat</span><span class="p">,</span> <span class="n">S2</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">outputsuffix</span><span class="o">=</span><span class="n">outputsuffix</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">(</span><span class="n">Yhat</span><span class="p">,</span> <span class="n">S2</span><span class="p">)</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Y</span><span class="p">,</span> <span class="n">maskvol</span> <span class="o">=</span> <span class="n">load_response_vars</span><span class="p">(</span><span class="n">respfile</span><span class="p">,</span> <span class="n">maskfile</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        
        <span class="c1"># warp the targets?</span>
        <span class="k">if</span> <span class="s1">&#39;blr&#39;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">nm</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">nm</span><span class="o">.</span><span class="n">blr</span><span class="o">.</span><span class="n">warp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warp_param</span> <span class="o">=</span> <span class="n">nm</span><span class="o">.</span><span class="n">blr</span><span class="o">.</span><span class="n">hyp</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nm</span><span class="o">.</span><span class="n">blr</span><span class="o">.</span><span class="n">warp</span><span class="o">.</span><span class="n">get_n_params</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> 
                <span class="n">Y</span> <span class="o">=</span> <span class="n">nm</span><span class="o">.</span><span class="n">blr</span><span class="o">.</span><span class="n">warp</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">warp_param</span><span class="p">)</span>
        
        <span class="n">Z</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="n">Yhat</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">S2</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluating the model ...&quot;</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">Yhat</span><span class="p">,</span> <span class="n">S2</span><span class="o">=</span><span class="n">S2</span><span class="p">,</span> 
                           <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Rho&#39;</span><span class="p">,</span> <span class="s1">&#39;RMSE&#39;</span><span class="p">,</span> <span class="s1">&#39;SMSE&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPV&#39;</span><span class="p">])</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluations Writing outputs ...&quot;</span><span class="p">)</span>
        <span class="n">save_results</span><span class="p">(</span><span class="n">respfile</span><span class="p">,</span> <span class="n">Yhat</span><span class="p">,</span> <span class="n">S2</span><span class="p">,</span> <span class="n">maskvol</span><span class="p">,</span> <span class="n">Z</span><span class="o">=</span><span class="n">Z</span><span class="p">,</span> <span class="n">outputsuffix</span><span class="o">=</span><span class="n">outputsuffix</span><span class="p">,</span> 
                     <span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">(</span><span class="n">Yhat</span><span class="p">,</span> <span class="n">S2</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="transfer"><a class="viewcode-back" href="../modindex.html#normative.transfer">[docs]</a><span class="k">def</span> <span class="nf">transfer</span><span class="p">(</span><span class="n">covfile</span><span class="p">,</span> <span class="n">respfile</span><span class="p">,</span> <span class="n">testcov</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">testresp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maskfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
             <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Transfer learning on the basis of a pre-estimated normative model by using </span>
<span class="sd">    the posterior distribution over the parameters as an informed prior for </span>
<span class="sd">    new data. currently only supported for HBR.</span>
<span class="sd">    </span>
<span class="sd">    Basic usage::</span>

<span class="sd">        transfer(covfile, respfile [extra_arguments])</span>

<span class="sd">    where the variables are defined below.</span>

<span class="sd">    :param covfile: test covariates used to predict the response variable</span>
<span class="sd">    :param respfile: test response variables for the normative model</span>
<span class="sd">    :param maskfile: mask used to apply to the data (nifti only)</span>
<span class="sd">    :param testcov: Test covariates</span>
<span class="sd">    :param testresp: Test responses</span>
<span class="sd">    :param model_path: Directory containing the normative model and metadata</span>
<span class="sd">    :param trbefile: Training batch effects file</span>
<span class="sd">    :param batch_size: batch size (for use with normative_parallel)</span>
<span class="sd">    :param job_id: batch id</span>

<span class="sd">    All outputs are written to disk in the same format as the input. These are:</span>

<span class="sd">    :outputs: * Yhat - predictive mean</span>
<span class="sd">              * S2 - predictive variance</span>
<span class="sd">              * Z - Z scores</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">alg</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;alg&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">alg</span> <span class="o">!=</span> <span class="s1">&#39;hbr&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model transferring is only possible for HBR models.&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="s1">&#39;model_path&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="ow">not</span> <span class="s1">&#39;output_path&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="ow">not</span> <span class="s1">&#39;trbefile&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;InputError: Some mandatory arguments are missing.&#39;</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;model_path&#39;</span><span class="p">)</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;output_path&#39;</span><span class="p">)</span>
        <span class="n">trbefile</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;trbefile&#39;</span><span class="p">)</span>
        <span class="n">batch_effects_train</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">trbefile</span><span class="p">)</span>
    
    <span class="n">outputsuffix</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;outputsuffix&#39;</span><span class="p">,</span> <span class="s1">&#39;_transfer&#39;</span><span class="p">)</span>
    <span class="n">inputsuffix</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;inputsuffix&#39;</span><span class="p">,</span> <span class="s1">&#39;_estimate&#39;</span><span class="p">)</span>
    <span class="n">tsbefile</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;tsbefile&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    
    <span class="n">job_id</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;job_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;batch_size&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
            
    <span class="c1"># load data</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading data ...&quot;</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">covfile</span><span class="p">)</span>
    <span class="n">Y</span><span class="p">,</span> <span class="n">maskvol</span> <span class="o">=</span> <span class="n">load_response_vars</span><span class="p">(</span><span class="n">respfile</span><span class="p">,</span> <span class="n">maskfile</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">feature_num</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">sY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>    
    
    <span class="k">if</span> <span class="n">testcov</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># we have a separate test dataset</span>
        <span class="n">Xte</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">testcov</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Xte</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Xte</span> <span class="o">=</span> <span class="n">Xte</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">ts_sample_num</span> <span class="o">=</span> <span class="n">Xte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">testresp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Yte</span><span class="p">,</span> <span class="n">testmask</span> <span class="o">=</span> <span class="n">load_response_vars</span><span class="p">(</span><span class="n">testresp</span><span class="p">,</span> <span class="n">maskfile</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Yte</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">Yte</span> <span class="o">=</span> <span class="n">Yte</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Yte</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ts_sample_num</span><span class="p">,</span> <span class="n">feature_num</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">tsbefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">batch_effects_test</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">tsbefile</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">batch_effects_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">Xte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">2</span><span class="p">])</span>

    <span class="n">Yhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ts_sample_num</span><span class="p">,</span> <span class="n">feature_num</span><span class="p">])</span>
    <span class="n">S2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ts_sample_num</span><span class="p">,</span> <span class="n">feature_num</span><span class="p">])</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ts_sample_num</span><span class="p">,</span> <span class="n">feature_num</span><span class="p">])</span>
    
    <span class="c1"># estimate the models for all subjects</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">feature_num</span><span class="p">):</span>
              
        <span class="n">nm</span> <span class="o">=</span> <span class="n">norm_init</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># when using normative_parallel</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Transferring model &quot;</span><span class="p">,</span> <span class="n">job_id</span><span class="o">*</span><span class="n">batch_size</span><span class="o">+</span><span class="n">i</span><span class="p">)</span>
            <span class="n">nm</span> <span class="o">=</span> <span class="n">nm</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;NM_0_&#39;</span> <span class="o">+</span> 
                                      <span class="nb">str</span><span class="p">(</span><span class="n">job_id</span><span class="o">*</span><span class="n">batch_size</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">inputsuffix</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Transferring model &quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;of&quot;</span><span class="p">,</span> <span class="n">feature_num</span><span class="p">)</span>
            <span class="n">nm</span> <span class="o">=</span> <span class="n">nm</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;NM_0_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">inputsuffix</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">))</span>
        
        <span class="n">nm</span> <span class="o">=</span> <span class="n">nm</span><span class="o">.</span><span class="n">estimate_on_new_sites</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span> <span class="n">batch_effects_train</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">nm</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;NM_0_&#39;</span> <span class="o">+</span> 
                             <span class="nb">str</span><span class="p">(</span><span class="n">job_id</span><span class="o">*</span><span class="n">batch_size</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">outputsuffix</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">))</span>
            <span class="n">nm</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;Models&#39;</span><span class="p">,</span> <span class="s1">&#39;NM_0_&#39;</span> <span class="o">+</span> 
                             <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">outputsuffix</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nm</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;NM_0_&#39;</span> <span class="o">+</span> 
                             <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">outputsuffix</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">testcov</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">yhat</span><span class="p">,</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">nm</span><span class="o">.</span><span class="n">predict_on_new_sites</span><span class="p">(</span><span class="n">Xte</span><span class="p">,</span> <span class="n">batch_effects_test</span><span class="p">)</span>
            <span class="n">Yhat</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">yhat</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">S2</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s2</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
   
    <span class="k">if</span> <span class="n">testresp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">save_results</span><span class="p">(</span><span class="n">respfile</span><span class="p">,</span> <span class="n">Yhat</span><span class="p">,</span> <span class="n">S2</span><span class="p">,</span> <span class="n">maskvol</span><span class="p">,</span> <span class="n">outputsuffix</span><span class="o">=</span><span class="n">outputsuffix</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">Yhat</span><span class="p">,</span> <span class="n">S2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="p">(</span><span class="n">Yte</span> <span class="o">-</span> <span class="n">Yhat</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">S2</span><span class="p">)</span>
    
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluating the model ...&quot;</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">Yte</span><span class="p">,</span> <span class="n">Yhat</span><span class="p">,</span> <span class="n">S2</span><span class="o">=</span><span class="n">S2</span><span class="p">,</span> <span class="n">mY</span><span class="o">=</span><span class="n">mY</span><span class="p">,</span> <span class="n">sY</span><span class="o">=</span><span class="n">sY</span><span class="p">)</span>
                
        <span class="n">save_results</span><span class="p">(</span><span class="n">respfile</span><span class="p">,</span> <span class="n">Yhat</span><span class="p">,</span> <span class="n">S2</span><span class="p">,</span> <span class="n">maskvol</span><span class="p">,</span> <span class="n">Z</span><span class="o">=</span><span class="n">Z</span><span class="p">,</span> <span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">,</span>
                     <span class="n">outputsuffix</span><span class="o">=</span><span class="n">outputsuffix</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">(</span><span class="n">Yhat</span><span class="p">,</span> <span class="n">S2</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span></div>


<div class="viewcode-block" id="extend"><a class="viewcode-back" href="../modindex.html#normative.extend">[docs]</a><span class="k">def</span> <span class="nf">extend</span><span class="p">(</span><span class="n">covfile</span><span class="p">,</span> <span class="n">respfile</span><span class="p">,</span> <span class="n">maskfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    
    <span class="n">alg</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;alg&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">alg</span> <span class="o">!=</span> <span class="s1">&#39;hbr&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model extention is only possible for HBR models.&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="s1">&#39;model_path&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="ow">not</span> <span class="s1">&#39;output_path&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="ow">not</span> <span class="s1">&#39;trbefile&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="ow">not</span> <span class="s1">&#39;dummycovfile&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span><span class="ow">or</span> \
        <span class="p">(</span><span class="ow">not</span> <span class="s1">&#39;dummybefile&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;InputError: Some mandatory arguments are missing.&#39;</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;model_path&#39;</span><span class="p">)</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;output_path&#39;</span><span class="p">)</span>
        <span class="n">trbefile</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;trbefile&#39;</span><span class="p">)</span>
        <span class="n">dummycovfile</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dummycovfile&#39;</span><span class="p">)</span>
        <span class="n">dummybefile</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dummybefile&#39;</span><span class="p">)</span>
    
    <span class="n">outputsuffix</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;outputsuffix&#39;</span><span class="p">,</span> <span class="s1">&#39;_extend&#39;</span><span class="p">)</span>
    <span class="n">inputsuffix</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;inputsuffix&#39;</span><span class="p">,</span> <span class="s1">&#39;_estimate&#39;</span><span class="p">)</span>
    <span class="n">informative_prior</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;job_id&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span>
    <span class="n">generation_factor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;generation_factor&#39;</span><span class="p">,</span> <span class="s1">&#39;10&#39;</span><span class="p">))</span>
    <span class="n">job_id</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;job_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;batch_size&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
            
    <span class="c1"># load data</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading data ...&quot;</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">covfile</span><span class="p">)</span>
    <span class="n">Y</span><span class="p">,</span> <span class="n">maskvol</span> <span class="o">=</span> <span class="n">load_response_vars</span><span class="p">(</span><span class="n">respfile</span><span class="p">,</span> <span class="n">maskfile</span><span class="p">)</span>
    <span class="n">batch_effects_train</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">trbefile</span><span class="p">)</span>
    <span class="n">X_dummy</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">dummycovfile</span><span class="p">)</span>
    <span class="n">batch_effects_dummy</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">dummybefile</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_dummy</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">X_dummy</span> <span class="o">=</span> <span class="n">X_dummy</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">feature_num</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="c1"># estimate the models for all subjects</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">feature_num</span><span class="p">):</span>
              
        <span class="n">nm</span> <span class="o">=</span> <span class="n">norm_init</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># when using nirmative_parallel</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extending model &quot;</span><span class="p">,</span> <span class="n">job_id</span><span class="o">*</span><span class="n">batch_size</span><span class="o">+</span><span class="n">i</span><span class="p">)</span>
            <span class="n">nm</span> <span class="o">=</span> <span class="n">nm</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;NM_0_&#39;</span> <span class="o">+</span> 
                                      <span class="nb">str</span><span class="p">(</span><span class="n">job_id</span><span class="o">*</span><span class="n">batch_size</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">inputsuffix</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extending model &quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;of&quot;</span><span class="p">,</span> <span class="n">feature_num</span><span class="p">)</span>
            <span class="n">nm</span> <span class="o">=</span> <span class="n">nm</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;NM_0_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">inputsuffix</span> <span class="o">+</span><span class="s1">&#39;.pkl&#39;</span><span class="p">))</span>
        
        <span class="n">nm</span> <span class="o">=</span> <span class="n">nm</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">[:,</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">batch_effects_train</span><span class="p">,</span> <span class="n">X_dummy</span><span class="p">,</span> <span class="n">batch_effects_dummy</span><span class="p">,</span> 
               <span class="n">samples</span><span class="o">=</span><span class="n">generation_factor</span><span class="p">,</span> <span class="n">informative_prior</span><span class="o">=</span><span class="n">informative_prior</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">nm</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;NM_0_&#39;</span> <span class="o">+</span> 
                             <span class="nb">str</span><span class="p">(</span><span class="n">job_id</span><span class="o">*</span><span class="n">batch_size</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">outputsuffix</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">))</span>
            <span class="n">nm</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;Models&#39;</span><span class="p">,</span> <span class="s1">&#39;NM_0_&#39;</span> <span class="o">+</span> 
                             <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">outputsuffix</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nm</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;NM_0_&#39;</span> <span class="o">+</span> 
                             <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">outputsuffix</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../modindex.html#normative.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Parse arguments and estimate model</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

    <span class="n">rfile</span><span class="p">,</span> <span class="n">mfile</span><span class="p">,</span> <span class="n">cfile</span><span class="p">,</span> <span class="n">cv</span><span class="p">,</span> <span class="n">tcfile</span><span class="p">,</span> <span class="n">trfile</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">alg</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">kw</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    
    <span class="c1"># collect required arguments</span>
    <span class="n">pos_args</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cfile&#39;</span><span class="p">,</span> <span class="s1">&#39;rfile&#39;</span><span class="p">]</span>
    
    <span class="c1"># collect basic keyword arguments controlling model estimation</span>
    <span class="n">kw_args</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;maskfile=mfile&#39;</span><span class="p">,</span>
               <span class="s1">&#39;cvfolds=cv&#39;</span><span class="p">,</span>
               <span class="s1">&#39;testcov=tcfile&#39;</span><span class="p">,</span>
               <span class="s1">&#39;testresp=trfile&#39;</span><span class="p">,</span>
               <span class="s1">&#39;alg=alg&#39;</span><span class="p">,</span>
               <span class="s1">&#39;configparam=cfg&#39;</span><span class="p">,</span>
               <span class="s1">&#39;standardize=std&#39;</span><span class="p">]</span>
    
    <span class="c1"># add additional keyword arguments</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
        <span class="n">kw_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">kw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
    <span class="n">all_args</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pos_args</span> <span class="o">+</span> <span class="n">kw_args</span><span class="p">)</span>

    <span class="c1"># Executing the target function</span>
    <span class="n">exec</span><span class="p">(</span><span class="n">func</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">all_args</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span></div>

<span class="c1"># For running from the command line:</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Predictive Clinical Neuroscience Toolkit 0.17 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">normative</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Andre F. Marquand.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.2.1.
    </div>
  </body>
</html>