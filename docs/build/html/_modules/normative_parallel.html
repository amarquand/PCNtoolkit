

<!doctype html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>normative_parallel &#8212; Predictive Clinical Neuroscience Toolkit 0.17 documentation</title>
    <link rel="stylesheet" href="../_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <!--[if lt IE 9]>
    <script src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Predictive Clinical Neuroscience Toolkit 0.17 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">normative_parallel</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for normative_parallel</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/.../anaconda/bin/python/</span>

<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># Run parallel normative modelling.</span>
<span class="c1"># All processing takes place in the processing directory (processing_dir)</span>
<span class="c1"># All inputs should be text files or binaries and space seperated</span>
<span class="c1">#</span>
<span class="c1"># It is possible to run these functions using...</span>
<span class="c1">#</span>
<span class="c1"># * k-fold cross-validation</span>
<span class="c1"># * estimating a training dataset then applying to a second test dataset</span>
<span class="c1">#</span>
<span class="c1"># First,the data is split for parallel processing.</span>
<span class="c1"># Second, the splits are submitted to the cluster.</span>
<span class="c1"># Third, the output is collected and combined.</span>
<span class="c1">#</span>
<span class="c1"># witten by (primarily) T Wolfers, (adaptated) SM Kia, H Huijsdens, L Parks, </span>
<span class="c1"># AF Marquand</span>
<span class="c1"># -----------------------------------------------------------------------------</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">fileinput</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">call</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pcntoolkit</span> <span class="k">as</span> <span class="nn">ptk</span>
    <span class="kn">import</span> <span class="nn">pcntoolkit.fileio</span> <span class="k">as</span> <span class="nn">fileio</span>
    <span class="kn">from</span> <span class="nn">pcntoolkit</span> <span class="kn">import</span> <span class="n">configs</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">path</span>
    <span class="kn">import</span> <span class="nn">fileio</span>
    <span class="kn">import</span> <span class="nn">configs</span>
    
<span class="n">PICKLE_PROTOCOL</span> <span class="o">=</span> <span class="n">configs</span><span class="o">.</span><span class="n">PICKLE_PROTOCOL</span>


<div class="viewcode-block" id="execute_nm"><a class="viewcode-back" href="../modindex.html#normative_parallel.execute_nm">[docs]</a><span class="k">def</span> <span class="nf">execute_nm</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span>
               <span class="n">python_path</span><span class="p">,</span>
               <span class="n">job_name</span><span class="p">,</span>
               <span class="n">covfile_path</span><span class="p">,</span>
               <span class="n">respfile_path</span><span class="p">,</span>
               <span class="n">batch_size</span><span class="p">,</span>
               <span class="n">memory</span><span class="p">,</span>
               <span class="n">duration</span><span class="p">,</span>
               <span class="n">normative_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">func</span><span class="o">=</span><span class="s1">&#39;estimate&#39;</span><span class="p">,</span>
               <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is a mother function that executes all parallel normative</span>
<span class="sd">    modelling routines. Different specifications are possible using the sub-</span>
<span class="sd">    functions.</span>

<span class="sd">    :Parameters:</span>
<span class="sd">        * processing_dir     -&gt; Full path to the processing dir</span>
<span class="sd">        * python_path        -&gt; Full path to the python distribution</span>
<span class="sd">        * normative_path     -&gt; Full path to the normative.py. If None (default)</span>
<span class="sd">                                then it will automatically retrieves the path from </span>
<span class="sd">                                the installed packeage.</span>
<span class="sd">        * job_name           -&gt; Name for the bash script that is the output of</span>
<span class="sd">                                this function</span>
<span class="sd">        * covfile_path       -&gt; Full path to a .txt file that contains all</span>
<span class="sd">                                covariats (subjects x covariates) for the</span>
<span class="sd">                                responsefile</span>
<span class="sd">        * respfile_path      -&gt; Full path to a .txt that contains all features</span>
<span class="sd">                                (subjects x features)</span>
<span class="sd">        * batch_size         -&gt; Number of features in each batch</span>
<span class="sd">        * memory             -&gt; Memory requirements written as string</span>
<span class="sd">                                for example 4gb or 500mb</span>
<span class="sd">        * duation            -&gt; The approximate duration of the job, a string</span>
<span class="sd">                                with HH:MM:SS for example 01:01:01</span>
<span class="sd">        * cv_folds           -&gt; Number of cross validations</span>
<span class="sd">        * testcovfile_path   -&gt; Full path to a .txt file that contains all</span>
<span class="sd">                                covariats (subjects x covariates) for the</span>
<span class="sd">                                testresponse file</span>
<span class="sd">        * testrespfile_path  -&gt; Full path to a .txt file that contains all</span>
<span class="sd">                                test features</span>
<span class="sd">        * log_path           -&gt; Pathfor saving log files</span>
<span class="sd">        * binary             -&gt; If True uses binary format for response file</span>
<span class="sd">                                otherwise it is text</span>

<span class="sd">    written by (primarily) T Wolfers, (adapted) SM Kia</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">normative_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">normative_path</span> <span class="o">=</span> <span class="n">ptk</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/normative.py&#39;</span>
        
    <span class="n">cv_folds</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cv_folds&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">testcovfile_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;testcovfile_path&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">testrespfile_path</span><span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;testrespfile_path&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">cluster_spec</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;cluster_spec&#39;</span><span class="p">,</span> <span class="s1">&#39;torque&#39;</span><span class="p">)</span>
    <span class="n">log_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;log_path&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">binary</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    
    <span class="n">split_nm</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span>
             <span class="n">respfile_path</span><span class="p">,</span>
             <span class="n">batch_size</span><span class="p">,</span>
             <span class="n">binary</span><span class="p">,</span>
             <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">batch_dir</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;batch_*&#39;</span><span class="p">)</span>
    <span class="c1"># print(batch_dir)</span>
    <span class="n">number_of_batches</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_dir</span><span class="p">)</span>
    <span class="c1"># print(number_of_batches)</span>

    <span class="k">if</span> <span class="n">binary</span><span class="p">:</span>
        <span class="n">file_extentions</span> <span class="o">=</span> <span class="s1">&#39;.pkl&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">file_extentions</span> <span class="o">=</span> <span class="s1">&#39;.txt&#39;</span>
    
    <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;batch_size&#39;</span><span class="p">:</span><span class="nb">str</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)})</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">number_of_batches</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;job_id&#39;</span><span class="p">:</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)})</span>
        <span class="k">if</span> <span class="n">testrespfile_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cv_folds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s2">&quot;&quot;&quot;If the response file is specified</span>
<span class="s2">                                     cv_folds must be equal to None&quot;&quot;&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># specified train/test split</span>
                <span class="n">batch_processing_dir</span> <span class="o">=</span> <span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;batch_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
                <span class="n">batch_job_name</span> <span class="o">=</span> <span class="n">job_name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.sh&#39;</span>
                <span class="n">batch_respfile_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch_processing_dir</span> <span class="o">+</span> <span class="s1">&#39;resp_batch_&#39;</span> <span class="o">+</span>
                                       <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">file_extentions</span><span class="p">)</span>
                <span class="n">batch_testrespfile_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch_processing_dir</span> <span class="o">+</span>
                                           <span class="s1">&#39;testresp_batch_&#39;</span> <span class="o">+</span>
                                           <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">file_extentions</span><span class="p">)</span>
                <span class="n">batch_job_path</span> <span class="o">=</span> <span class="n">batch_processing_dir</span> <span class="o">+</span> <span class="n">batch_job_name</span>
                <span class="k">if</span> <span class="n">cluster_spec</span> <span class="o">==</span> <span class="s1">&#39;torque&#39;</span><span class="p">:</span>
                    <span class="c1"># update the response file </span>
                    <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;testrespfile_path&#39;</span><span class="p">:</span> \
                                   <span class="n">batch_testrespfile_path</span><span class="p">})</span>
                    <span class="n">bashwrap_nm</span><span class="p">(</span><span class="n">batch_processing_dir</span><span class="p">,</span>
                                <span class="n">python_path</span><span class="p">,</span>
                                <span class="n">normative_path</span><span class="p">,</span>
                                <span class="n">batch_job_name</span><span class="p">,</span>
                                <span class="n">covfile_path</span><span class="p">,</span>
                                <span class="n">batch_respfile_path</span><span class="p">,</span>
                                <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">,</span>
                                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">qsub_nm</span><span class="p">(</span><span class="n">job_path</span><span class="o">=</span><span class="n">batch_job_path</span><span class="p">,</span>
                            <span class="n">log_path</span><span class="o">=</span><span class="n">log_path</span><span class="p">,</span>
                            <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span>
                            <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">cluster_spec</span> <span class="o">==</span> <span class="s1">&#39;sbatch&#39;</span><span class="p">:</span>
                    <span class="c1"># update the response file </span>
                    <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;testrespfile_path&#39;</span><span class="p">:</span> \
                                   <span class="n">batch_testrespfile_path</span><span class="p">})</span>
                    <span class="n">sbatchwrap_nm</span><span class="p">(</span><span class="n">batch_processing_dir</span><span class="p">,</span>
                                <span class="n">python_path</span><span class="p">,</span>
                                <span class="n">normative_path</span><span class="p">,</span>
                                <span class="n">batch_job_name</span><span class="p">,</span>
                                <span class="n">covfile_path</span><span class="p">,</span>
                                <span class="n">batch_respfile_path</span><span class="p">,</span>
                                <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">,</span>
                                <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span>
                                <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">,</span>
                                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">sbatch_nm</span><span class="p">(</span><span class="n">job_path</span><span class="o">=</span><span class="n">batch_job_path</span><span class="p">,</span>
                            <span class="n">log_path</span><span class="o">=</span><span class="n">log_path</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">cluster_spec</span> <span class="o">==</span> <span class="s1">&#39;new&#39;</span><span class="p">:</span>
                    <span class="c1"># this part requires addition in different envioronment [</span>
                    <span class="n">sbatchwrap_nm</span><span class="p">(</span><span class="n">processing_dir</span><span class="o">=</span><span class="n">batch_processing_dir</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">,</span>
                                  <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">sbatch_nm</span><span class="p">(</span><span class="n">processing_dir</span><span class="o">=</span><span class="n">batch_processing_dir</span><span class="p">)</span>
                    <span class="c1"># ]</span>
        <span class="k">if</span> <span class="n">testrespfile_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">testcovfile_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># forward model</span>
                <span class="n">batch_processing_dir</span> <span class="o">=</span> <span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;batch_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
                <span class="n">batch_job_name</span> <span class="o">=</span> <span class="n">job_name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.sh&#39;</span>
                <span class="n">batch_respfile_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch_processing_dir</span> <span class="o">+</span> <span class="s1">&#39;resp_batch_&#39;</span> <span class="o">+</span>
                                       <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">file_extentions</span><span class="p">)</span>
                <span class="n">batch_job_path</span> <span class="o">=</span> <span class="n">batch_processing_dir</span> <span class="o">+</span> <span class="n">batch_job_name</span>
                <span class="k">if</span> <span class="n">cluster_spec</span> <span class="o">==</span> <span class="s1">&#39;torque&#39;</span><span class="p">:</span>
                    <span class="n">bashwrap_nm</span><span class="p">(</span><span class="n">batch_processing_dir</span><span class="p">,</span>
                                <span class="n">python_path</span><span class="p">,</span>
                                <span class="n">normative_path</span><span class="p">,</span>
                                <span class="n">batch_job_name</span><span class="p">,</span>
                                <span class="n">covfile_path</span><span class="p">,</span>
                                <span class="n">batch_respfile_path</span><span class="p">,</span>
                                <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">,</span>
                                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">qsub_nm</span><span class="p">(</span><span class="n">job_path</span><span class="o">=</span><span class="n">batch_job_path</span><span class="p">,</span>
                            <span class="n">log_path</span><span class="o">=</span><span class="n">log_path</span><span class="p">,</span>
                            <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span>
                            <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">cluster_spec</span> <span class="o">==</span> <span class="s1">&#39;sbatch&#39;</span><span class="p">:</span>
                    <span class="n">sbatchwrap_nm</span><span class="p">(</span><span class="n">batch_processing_dir</span><span class="p">,</span>
                                <span class="n">python_path</span><span class="p">,</span>
                                <span class="n">normative_path</span><span class="p">,</span>
                                <span class="n">batch_job_name</span><span class="p">,</span>
                                <span class="n">covfile_path</span><span class="p">,</span>
                                <span class="n">batch_respfile_path</span><span class="p">,</span>
                                <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">,</span>
                                <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span>
                                <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">,</span>
                                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">sbatch_nm</span><span class="p">(</span><span class="n">job_path</span><span class="o">=</span><span class="n">batch_job_path</span><span class="p">,</span>
                              <span class="n">log_path</span><span class="o">=</span><span class="n">log_path</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">cluster_spec</span> <span class="o">==</span> <span class="s1">&#39;new&#39;</span><span class="p">:</span>
                    <span class="c1"># this part requires addition in different envioronment [</span>
                    <span class="n">bashwrap_nm</span><span class="p">(</span><span class="n">processing_dir</span><span class="o">=</span><span class="n">batch_processing_dir</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">,</span>
                                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">qsub_nm</span><span class="p">(</span><span class="n">processing_dir</span><span class="o">=</span><span class="n">batch_processing_dir</span><span class="p">)</span>
                    <span class="c1"># ]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># cross-validation</span>
                <span class="n">batch_processing_dir</span> <span class="o">=</span> <span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;batch_&#39;</span> <span class="o">+</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
                <span class="n">batch_job_name</span> <span class="o">=</span> <span class="n">job_name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.sh&#39;</span>
                <span class="n">batch_respfile_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch_processing_dir</span> <span class="o">+</span>
                                       <span class="s1">&#39;resp_batch_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span>
                                       <span class="n">file_extentions</span><span class="p">)</span>
                <span class="n">batch_job_path</span> <span class="o">=</span> <span class="n">batch_processing_dir</span> <span class="o">+</span> <span class="n">batch_job_name</span>
                <span class="k">if</span> <span class="n">cluster_spec</span> <span class="o">==</span> <span class="s1">&#39;torque&#39;</span><span class="p">:</span>
                    <span class="n">bashwrap_nm</span><span class="p">(</span><span class="n">batch_processing_dir</span><span class="p">,</span>
                                <span class="n">python_path</span><span class="p">,</span>
                                <span class="n">normative_path</span><span class="p">,</span>
                                <span class="n">batch_job_name</span><span class="p">,</span>
                                <span class="n">covfile_path</span><span class="p">,</span>
                                <span class="n">batch_respfile_path</span><span class="p">,</span>
                                <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">,</span>
                                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">qsub_nm</span><span class="p">(</span><span class="n">job_path</span><span class="o">=</span><span class="n">batch_job_path</span><span class="p">,</span>
                            <span class="n">log_path</span><span class="o">=</span><span class="n">log_path</span><span class="p">,</span>
                            <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span>
                            <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">cluster_spec</span> <span class="o">==</span> <span class="s1">&#39;sbatch&#39;</span><span class="p">:</span>
                    <span class="n">sbatchwrap_nm</span><span class="p">(</span><span class="n">batch_processing_dir</span><span class="p">,</span>
                                <span class="n">python_path</span><span class="p">,</span>
                                <span class="n">normative_path</span><span class="p">,</span>
                                <span class="n">batch_job_name</span><span class="p">,</span>
                                <span class="n">covfile_path</span><span class="p">,</span>
                                <span class="n">batch_respfile_path</span><span class="p">,</span>
                                <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">,</span>
                                <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span>
                                <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">,</span>
                                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">sbatch_nm</span><span class="p">(</span><span class="n">job_path</span><span class="o">=</span><span class="n">batch_job_path</span><span class="p">,</span>
                            <span class="n">log_path</span><span class="o">=</span><span class="n">log_path</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">cluster_spec</span> <span class="o">==</span> <span class="s1">&#39;new&#39;</span><span class="p">:</span>
                    <span class="c1"># this part requires addition in different envioronment [</span>
                    <span class="n">bashwrap_nm</span><span class="p">(</span><span class="n">processing_dir</span><span class="o">=</span><span class="n">batch_processing_dir</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">,</span>
                                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">qsub_nm</span><span class="p">(</span><span class="n">processing_dir</span><span class="o">=</span><span class="n">batch_processing_dir</span><span class="p">)</span></div>
                    <span class="c1"># ]</span>


<span class="sd">&quot;&quot;&quot;routines that are environment independent&quot;&quot;&quot;</span>


<div class="viewcode-block" id="split_nm"><a class="viewcode-back" href="../modindex.html#normative_parallel.split_nm">[docs]</a><span class="k">def</span> <span class="nf">split_nm</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span>
             <span class="n">respfile_path</span><span class="p">,</span>
             <span class="n">batch_size</span><span class="p">,</span>
             <span class="n">binary</span><span class="p">,</span>
             <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot; This function prepares the input files for normative_parallel.</span>

<span class="sd">    :Parameters:</span>
<span class="sd">        * processing_dir    -&gt; Full path to the folder of processing</span>
<span class="sd">        * respfile_path     -&gt; Full path to the responsefile.txt</span>
<span class="sd">                               (subjects x features)</span>
<span class="sd">        * batch_size        -&gt; Number of features in each batch</span>
<span class="sd">        * testrespfile_path -&gt; Full path to the test responsefile.txt</span>
<span class="sd">                               (subjects x features)</span>
<span class="sd">        * binary            -&gt; If True binary file</span>

<span class="sd">    :outputs:</span>
<span class="sd">        * The creation of a folder struture for batch-wise processing</span>

<span class="sd">    witten by (primarily) T Wolfers (adapted) SM Kia</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">testrespfile_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;testrespfile_path&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">dummy</span><span class="p">,</span> <span class="n">respfile_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">respfile_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">binary</span> <span class="ow">and</span> <span class="n">respfile_extension</span> <span class="o">!=</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">):</span>
        <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s2">&quot;&quot;&quot;If binary is True the file format for the</span>
<span class="s2">              testrespfile file must be .pkl&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">binary</span><span class="o">==</span><span class="kc">False</span> <span class="ow">and</span> <span class="n">respfile_extension</span> <span class="o">!=</span> <span class="s1">&#39;.txt&#39;</span><span class="p">):</span>
        <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s2">&quot;&quot;&quot;If binary is False the file format for the</span>
<span class="s2">              testrespfile file must be .txt&quot;&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># splits response into batches</span>
    <span class="k">if</span> <span class="n">testrespfile_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">binary</span><span class="o">==</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">respfile</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">load_ascii</span><span class="p">(</span><span class="n">respfile_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">respfile</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">respfile_path</span><span class="p">)</span>

        <span class="n">respfile</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">respfile</span><span class="p">)</span>

        <span class="n">numsub</span> <span class="o">=</span> <span class="n">respfile</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">batch_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
                              <span class="n">numsub</span><span class="p">,</span>
                              <span class="n">batch_size</span><span class="p">)</span>
        <span class="n">batch_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_vec</span><span class="p">,</span>
                              <span class="n">numsub</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_vec</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="n">resp_batch</span> <span class="o">=</span> <span class="n">respfile</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">(</span><span class="n">batch_vec</span><span class="p">[</span><span class="n">n</span><span class="p">]):</span> <span class="n">batch_vec</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;resp_batch_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;batch_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="n">batch</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="n">batch</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="n">batch</span> <span class="o">+</span> <span class="s1">&#39;/Models/&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">binary</span><span class="o">==</span><span class="kc">False</span><span class="p">):</span>
                <span class="n">fileio</span><span class="o">.</span><span class="n">save_pd</span><span class="p">(</span><span class="n">resp_batch</span><span class="p">,</span>
                               <span class="n">processing_dir</span> <span class="o">+</span> <span class="n">batch</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span>
                               <span class="n">resp</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resp_batch</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="n">batch</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span>
                                     <span class="n">resp</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">PICKLE_PROTOCOL</span><span class="p">)</span>

    <span class="c1"># splits response and test responsefile into batches</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dummy</span><span class="p">,</span> <span class="n">testrespfile_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">testrespfile_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">binary</span> <span class="ow">and</span> <span class="n">testrespfile_extension</span> <span class="o">!=</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">):</span>
            <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s2">&quot;&quot;&quot;If binary is True the file format for the</span>
<span class="s2">                  testrespfile file must be .pkl&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">binary</span><span class="o">==</span><span class="kc">False</span> <span class="ow">and</span> <span class="n">testrespfile_extension</span> <span class="o">!=</span> <span class="s1">&#39;.txt&#39;</span><span class="p">):</span>
            <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s2">&quot;&quot;&quot;If binary is False the file format for the</span>
<span class="s2">                  testrespfile file must be .txt&quot;&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">binary</span><span class="o">==</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">respfile</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">load_ascii</span><span class="p">(</span><span class="n">respfile_path</span><span class="p">)</span>
            <span class="n">testrespfile</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">load_ascii</span><span class="p">(</span><span class="n">testrespfile_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">respfile</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">respfile_path</span><span class="p">)</span>
            <span class="n">testrespfile</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">testrespfile_path</span><span class="p">)</span>

        <span class="n">respfile</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">respfile</span><span class="p">)</span>
        <span class="n">testrespfile</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">testrespfile</span><span class="p">)</span>

        <span class="n">numsub</span> <span class="o">=</span> <span class="n">respfile</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">batch_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">numsub</span><span class="p">,</span>
                              <span class="n">batch_size</span><span class="p">)</span>
        <span class="n">batch_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_vec</span><span class="p">,</span>
                              <span class="n">numsub</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_vec</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="n">resp_batch</span> <span class="o">=</span> <span class="n">respfile</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">(</span><span class="n">batch_vec</span><span class="p">[</span><span class="n">n</span><span class="p">]):</span> <span class="n">batch_vec</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>
            <span class="n">testresp_batch</span> <span class="o">=</span> <span class="n">testrespfile</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">(</span><span class="n">batch_vec</span><span class="p">[</span><span class="n">n</span><span class="p">]):</span> <span class="n">batch_vec</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span>
                                             <span class="mi">1</span><span class="p">]]</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;resp_batch_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">testresp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;testresp_batch_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;batch_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="n">batch</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="n">batch</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="n">batch</span> <span class="o">+</span> <span class="s1">&#39;/Models/&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">binary</span><span class="o">==</span><span class="kc">False</span><span class="p">):</span>
                <span class="n">fileio</span><span class="o">.</span><span class="n">save_pd</span><span class="p">(</span><span class="n">resp_batch</span><span class="p">,</span>
                               <span class="n">processing_dir</span> <span class="o">+</span> <span class="n">batch</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span>
                               <span class="n">resp</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">)</span>
                <span class="n">fileio</span><span class="o">.</span><span class="n">save_pd</span><span class="p">(</span><span class="n">testresp_batch</span><span class="p">,</span>
                               <span class="n">processing_dir</span> <span class="o">+</span> <span class="n">batch</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">testresp</span> <span class="o">+</span>
                               <span class="s1">&#39;.txt&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resp_batch</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="n">batch</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span>
                                     <span class="n">resp</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">PICKLE_PROTOCOL</span><span class="p">)</span>
                <span class="n">testresp_batch</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="n">batch</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span>
                                         <span class="n">testresp</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">PICKLE_PROTOCOL</span><span class="p">)</span></div>


<div class="viewcode-block" id="collect_nm"><a class="viewcode-back" href="../modindex.html#normative_parallel.collect_nm">[docs]</a><span class="k">def</span> <span class="nf">collect_nm</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span>
               <span class="n">job_name</span><span class="p">,</span>
               <span class="n">func</span><span class="o">=</span><span class="s1">&#39;estimate&#39;</span><span class="p">,</span>
               <span class="n">collect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">binary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">outputsuffix</span><span class="o">=</span><span class="s1">&#39;_estimate&#39;</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;This function checks and collects all batches.</span>

<span class="sd">    :Parameters:</span>
<span class="sd">        * processing_dir        -&gt; Full path to the processing directory</span>
<span class="sd">        * collect               -&gt; If True data is checked for failed batches</span>
<span class="sd">                                and collected; if False data is just checked</span>
<span class="sd">        * binary                -&gt; Results in pkl format? </span>

<span class="sd">    :ouptuts:</span>
<span class="sd">        * Text files containing all results accross all batches the combined</span>
<span class="sd">          output (written to disk)</span>
<span class="sd">        * returns 0 if batches fail, 1 otherwise</span>

<span class="sd">    written by (primarily) T Wolfers, (adapted) SM Kia</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">binary</span><span class="p">:</span>
        <span class="n">file_extentions</span> <span class="o">=</span> <span class="s1">&#39;.pkl&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">file_extentions</span> <span class="o">=</span> <span class="s1">&#39;.txt&#39;</span>

    <span class="c1"># detect number of subjects, batches, hyperparameters and CV</span>
    <span class="n">batches</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;batch_*/&#39;</span><span class="p">)</span>
    
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">batch_fail</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">if</span> <span class="n">func</span> <span class="o">!=</span> <span class="s1">&#39;fit&#39;</span><span class="p">:</span>
        <span class="n">file_example</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file_example</span> <span class="o">==</span> <span class="p">[]:</span>
                <span class="n">file_example</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">batch</span> <span class="o">+</span> <span class="s1">&#39;yhat&#39;</span> <span class="o">+</span> <span class="n">outputsuffix</span> <span class="o">+</span> <span class="n">file_extentions</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">binary</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">file_example</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_example</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file_example</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">file_example</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">numsubjects</span> <span class="o">=</span> <span class="n">file_example</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">file_example</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
        <span class="c1"># artificially creates files for batches that were not executed</span>
        <span class="n">batch_dirs</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;batch_*/&#39;</span><span class="p">)</span>
        <span class="n">batch_dirs</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">sort_nicely</span><span class="p">(</span><span class="n">batch_dirs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batch_dirs</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">batch</span> <span class="o">+</span> <span class="s1">&#39;yhat&#39;</span> <span class="o">+</span> <span class="n">outputsuffix</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filepath</span> <span class="o">==</span> <span class="p">[]:</span>
                <span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">batch1</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">batch</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">job_name</span> <span class="o">+</span> <span class="s1">&#39;*.sh&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">batch1</span><span class="p">)</span>
                <span class="n">batch_fail</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">collect</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">pRho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
                    <span class="n">pRho</span> <span class="o">=</span> <span class="n">pRho</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
                    <span class="n">pRho</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">pRho</span><span class="p">)</span>
                    <span class="n">fileio</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">pRho</span><span class="p">,</span> <span class="n">batch</span> <span class="o">+</span> <span class="s1">&#39;pRho&#39;</span> <span class="o">+</span> <span class="n">outputsuffix</span> <span class="o">+</span> <span class="n">file_extentions</span><span class="p">)</span>
                    
                    <span class="n">Rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
                    <span class="n">Rho</span> <span class="o">=</span> <span class="n">Rho</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
                    <span class="n">Rho</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">Rho</span><span class="p">)</span>
                    <span class="n">fileio</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">Rho</span><span class="p">,</span> <span class="n">batch</span> <span class="o">+</span> <span class="s1">&#39;Rho&#39;</span> <span class="o">+</span> <span class="n">outputsuffix</span> <span class="o">+</span> <span class="n">file_extentions</span><span class="p">)</span>
                    
                    <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
                    <span class="n">rmse</span> <span class="o">=</span> <span class="n">rmse</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
                    <span class="n">rmse</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>
                    <span class="n">fileio</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">rmse</span><span class="p">,</span> <span class="n">batch</span> <span class="o">+</span> <span class="s1">&#39;RMSE&#39;</span> <span class="o">+</span> <span class="n">outputsuffix</span> <span class="o">+</span> <span class="n">file_extentions</span><span class="p">)</span>
                    
                    <span class="n">smse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
                    <span class="n">smse</span> <span class="o">=</span> <span class="n">smse</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
                    <span class="n">smse</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">smse</span><span class="p">)</span>
                    <span class="n">fileio</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">smse</span><span class="p">,</span> <span class="n">batch</span> <span class="o">+</span> <span class="s1">&#39;SMSE&#39;</span> <span class="o">+</span> <span class="n">outputsuffix</span> <span class="o">+</span> <span class="n">file_extentions</span><span class="p">)</span>
                    
                    <span class="n">expv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
                    <span class="n">expv</span> <span class="o">=</span> <span class="n">expv</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
                    <span class="n">expv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">expv</span><span class="p">)</span>
                    <span class="n">fileio</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">expv</span><span class="p">,</span> <span class="n">batch</span> <span class="o">+</span> <span class="s1">&#39;EXPV&#39;</span> <span class="o">+</span> <span class="n">outputsuffix</span> <span class="o">+</span> <span class="n">file_extentions</span><span class="p">)</span>
                    
                    <span class="n">msll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
                    <span class="n">msll</span> <span class="o">=</span> <span class="n">msll</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
                    <span class="n">msll</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">msll</span><span class="p">)</span>
                    <span class="n">fileio</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">msll</span><span class="p">,</span> <span class="n">batch</span> <span class="o">+</span> <span class="s1">&#39;MSLL&#39;</span> <span class="o">+</span> <span class="n">outputsuffix</span> <span class="o">+</span> <span class="n">file_extentions</span><span class="p">)</span>
    
                    <span class="n">yhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">numsubjects</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">])</span>
                    <span class="n">yhat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">yhat</span><span class="p">)</span>
                    <span class="n">fileio</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">yhat</span><span class="p">,</span> <span class="n">batch</span> <span class="o">+</span> <span class="s1">&#39;yhat&#39;</span> <span class="o">+</span> <span class="n">outputsuffix</span> <span class="o">+</span> <span class="n">file_extentions</span><span class="p">)</span>
    
                    <span class="n">ys2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">numsubjects</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">])</span>
                    <span class="n">ys2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ys2</span><span class="p">)</span>
                    <span class="n">fileio</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">ys2</span><span class="p">,</span> <span class="n">batch</span> <span class="o">+</span> <span class="s1">&#39;ys2&#39;</span> <span class="o">+</span> <span class="n">outputsuffix</span> <span class="o">+</span> <span class="n">file_extentions</span><span class="p">)</span>
    
                    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">numsubjects</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">])</span>
                    <span class="n">Z</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
                    <span class="n">fileio</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">batch</span> <span class="o">+</span> <span class="s1">&#39;Z&#39;</span> <span class="o">+</span> <span class="n">outputsuffix</span> <span class="o">+</span> <span class="n">file_extentions</span><span class="p">)</span>
    
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">batch</span> <span class="o">+</span> <span class="s1">&#39;Models&#39;</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s1">&#39;Models&#39;</span><span class="p">)</span>
                        
                        
            <span class="k">else</span><span class="p">:</span> <span class="c1"># if more than 10% of yhat is nan then consider the batch as a failed batch</span>
                <span class="n">yhat</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filepath</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">yhat</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">yhat</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span><span class="o">&lt;</span><span class="mf">0.9</span><span class="p">:</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">batch1</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">batch</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">job_name</span> <span class="o">+</span> <span class="s1">&#39;*.sh&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;More than 10% nans in &#39;</span><span class="o">+</span> <span class="n">batch1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">batch_fail</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch1</span><span class="p">)</span>
    
    <span class="c1"># combines all output files across batches</span>
    <span class="k">if</span> <span class="n">collect</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">pRho_filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;batch_*/&#39;</span> <span class="o">+</span> <span class="s1">&#39;pRho&#39;</span> <span class="o">+</span> 
                                   <span class="n">outputsuffix</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pRho_filenames</span><span class="p">:</span>
            <span class="n">pRho_filenames</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">sort_nicely</span><span class="p">(</span><span class="n">pRho_filenames</span><span class="p">)</span>
            <span class="n">pRho_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pRho_filename</span> <span class="ow">in</span> <span class="n">pRho_filenames</span><span class="p">:</span>
                <span class="n">pRho_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">fileio</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pRho_filename</span><span class="p">)))</span>
            <span class="n">pRho_dfs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">pRho_dfs</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">fileio</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">pRho_dfs</span><span class="p">,</span> <span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;pRho&#39;</span> <span class="o">+</span> <span class="n">outputsuffix</span> <span class="o">+</span>
                        <span class="n">file_extentions</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">pRho_dfs</span>

        <span class="n">Rho_filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;batch_*/&#39;</span> <span class="o">+</span> <span class="s1">&#39;Rho&#39;</span> <span class="o">+</span> 
                                   <span class="n">outputsuffix</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Rho_filenames</span><span class="p">:</span>
            <span class="n">Rho_filenames</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">sort_nicely</span><span class="p">(</span><span class="n">Rho_filenames</span><span class="p">)</span>
            <span class="n">Rho_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">Rho_filename</span> <span class="ow">in</span> <span class="n">Rho_filenames</span><span class="p">:</span>
                <span class="n">Rho_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">fileio</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">Rho_filename</span><span class="p">)))</span>
            <span class="n">Rho_dfs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">Rho_dfs</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">fileio</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">Rho_dfs</span><span class="p">,</span> <span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;Rho&#39;</span> <span class="o">+</span> <span class="n">outputsuffix</span> <span class="o">+</span>
                        <span class="n">file_extentions</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">Rho_dfs</span>

        <span class="n">Z_filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;batch_*/&#39;</span> <span class="o">+</span> <span class="s1">&#39;Z&#39;</span> <span class="o">+</span> 
                                   <span class="n">outputsuffix</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Z_filenames</span><span class="p">:</span>
            <span class="n">Z_filenames</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">sort_nicely</span><span class="p">(</span><span class="n">Z_filenames</span><span class="p">)</span>
            <span class="n">Z_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">Z_filename</span> <span class="ow">in</span> <span class="n">Z_filenames</span><span class="p">:</span>
                <span class="n">Z_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">fileio</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">Z_filename</span><span class="p">)))</span>
            <span class="n">Z_dfs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">Z_dfs</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">fileio</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">Z_dfs</span><span class="p">,</span> <span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;Z&#39;</span> <span class="o">+</span> <span class="n">outputsuffix</span> <span class="o">+</span>
                        <span class="n">file_extentions</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">Z_dfs</span>
            
        <span class="n">yhat_filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;batch_*/&#39;</span> <span class="o">+</span> <span class="s1">&#39;yhat&#39;</span> <span class="o">+</span> 
                                   <span class="n">outputsuffix</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">yhat_filenames</span><span class="p">:</span>
            <span class="n">yhat_filenames</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">sort_nicely</span><span class="p">(</span><span class="n">yhat_filenames</span><span class="p">)</span>
            <span class="n">yhat_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">yhat_filename</span> <span class="ow">in</span> <span class="n">yhat_filenames</span><span class="p">:</span>
                <span class="n">yhat_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">fileio</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">yhat_filename</span><span class="p">)))</span>
            <span class="n">yhat_dfs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">yhat_dfs</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">fileio</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">yhat_dfs</span><span class="p">,</span> <span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;yhat&#39;</span> <span class="o">+</span> <span class="n">outputsuffix</span> <span class="o">+</span>
                        <span class="n">file_extentions</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">yhat_dfs</span>

        <span class="n">ys2_filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;batch_*/&#39;</span> <span class="o">+</span> <span class="s1">&#39;ys2&#39;</span> <span class="o">+</span> 
                                   <span class="n">outputsuffix</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ys2_filenames</span><span class="p">:</span>
            <span class="n">ys2_filenames</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">sort_nicely</span><span class="p">(</span><span class="n">ys2_filenames</span><span class="p">)</span>
            <span class="n">ys2_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ys2_filename</span> <span class="ow">in</span> <span class="n">ys2_filenames</span><span class="p">:</span>
                <span class="n">ys2_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">fileio</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ys2_filename</span><span class="p">)))</span>
            <span class="n">ys2_dfs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">ys2_dfs</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">fileio</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">ys2_dfs</span><span class="p">,</span> <span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;ys2&#39;</span> <span class="o">+</span> <span class="n">outputsuffix</span> <span class="o">+</span>
                        <span class="n">file_extentions</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">ys2_dfs</span>

        <span class="n">rmse_filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;batch_*/&#39;</span> <span class="o">+</span> <span class="s1">&#39;RMSE&#39;</span> <span class="o">+</span> 
                                   <span class="n">outputsuffix</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rmse_filenames</span><span class="p">:</span>
            <span class="n">rmse_filenames</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">sort_nicely</span><span class="p">(</span><span class="n">rmse_filenames</span><span class="p">)</span>
            <span class="n">rmse_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">rmse_filename</span> <span class="ow">in</span> <span class="n">rmse_filenames</span><span class="p">:</span>
                <span class="n">rmse_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">fileio</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">rmse_filename</span><span class="p">)))</span>
            <span class="n">rmse_dfs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">rmse_dfs</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">fileio</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">rmse_dfs</span><span class="p">,</span> <span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;RMSE&#39;</span> <span class="o">+</span> <span class="n">outputsuffix</span> <span class="o">+</span>
                        <span class="n">file_extentions</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">rmse_dfs</span>

        <span class="n">smse_filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;batch_*/&#39;</span> <span class="o">+</span> <span class="s1">&#39;SMSE&#39;</span> <span class="o">+</span> 
                                   <span class="n">outputsuffix</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">smse_filenames</span><span class="p">:</span>
            <span class="n">smse_filenames</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">sort_nicely</span><span class="p">(</span><span class="n">smse_filenames</span><span class="p">)</span>
            <span class="n">smse_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">smse_filename</span> <span class="ow">in</span> <span class="n">smse_filenames</span><span class="p">:</span>
                <span class="n">smse_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">fileio</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">smse_filename</span><span class="p">)))</span>
            <span class="n">smse_dfs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">smse_dfs</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">fileio</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">smse_dfs</span><span class="p">,</span> <span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;SMSE&#39;</span> <span class="o">+</span> <span class="n">outputsuffix</span> <span class="o">+</span>
                        <span class="n">file_extentions</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">smse_dfs</span>
            
        <span class="n">expv_filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;batch_*/&#39;</span> <span class="o">+</span> <span class="s1">&#39;EXPV&#39;</span> <span class="o">+</span> 
                                   <span class="n">outputsuffix</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">expv_filenames</span><span class="p">:</span>
            <span class="n">expv_filenames</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">sort_nicely</span><span class="p">(</span><span class="n">expv_filenames</span><span class="p">)</span>
            <span class="n">expv_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">expv_filename</span> <span class="ow">in</span> <span class="n">expv_filenames</span><span class="p">:</span>
                <span class="n">expv_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">fileio</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">expv_filename</span><span class="p">)))</span>
            <span class="n">expv_dfs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">expv_dfs</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">fileio</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">expv_dfs</span><span class="p">,</span> <span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;EXPV&#39;</span> <span class="o">+</span> <span class="n">outputsuffix</span> <span class="o">+</span>
                        <span class="n">file_extentions</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">expv_dfs</span>
            
        <span class="n">msll_filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;batch_*/&#39;</span> <span class="o">+</span> <span class="s1">&#39;MSLL&#39;</span> <span class="o">+</span> 
                                   <span class="n">outputsuffix</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">msll_filenames</span><span class="p">:</span>
            <span class="n">msll_filenames</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">sort_nicely</span><span class="p">(</span><span class="n">msll_filenames</span><span class="p">)</span>
            <span class="n">msll_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">msll_filename</span> <span class="ow">in</span> <span class="n">msll_filenames</span><span class="p">:</span>
                <span class="n">msll_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">fileio</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">msll_filename</span><span class="p">)))</span>
            <span class="n">msll_dfs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">msll_dfs</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">fileio</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">msll_dfs</span><span class="p">,</span> <span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;MSLL&#39;</span> <span class="o">+</span> <span class="n">outputsuffix</span> <span class="o">+</span>
                        <span class="n">file_extentions</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">msll_dfs</span>
        
        <span class="k">if</span> <span class="n">func</span> <span class="o">!=</span> <span class="s1">&#39;predict&#39;</span> <span class="ow">and</span> <span class="n">func</span> <span class="o">!=</span> <span class="s1">&#39;transfer&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;Models&#39;</span><span class="p">)</span> <span class="ow">and</span> \
               <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">batches</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;Models&#39;</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;Models&#39;</span><span class="p">)</span>
                
            <span class="n">meta_filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;batch_*/Models/&#39;</span> <span class="o">+</span> <span class="s1">&#39;meta_data.md&#39;</span><span class="p">)</span>
            <span class="n">mY</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">sY</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">mX</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">sX</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">meta_filenames</span><span class="p">:</span>
                <span class="n">meta_filenames</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">sort_nicely</span><span class="p">(</span><span class="n">meta_filenames</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">meta_filenames</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">meta_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;standardize&#39;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">meta_filename</span> <span class="ow">in</span> <span class="n">meta_filenames</span><span class="p">:</span>
                        <span class="n">mY</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;mean_resp&#39;</span><span class="p">])</span>
                        <span class="n">sY</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;std_resp&#39;</span><span class="p">])</span>
                        <span class="n">mX</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;mean_cov&#39;</span><span class="p">])</span>
                        <span class="n">sX</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;std_cov&#39;</span><span class="p">])</span>
                    <span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;mean_resp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">mY</span><span class="p">)</span> 
                    <span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;std_resp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">sY</span><span class="p">)</span> 
                    <span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;mean_cov&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">mX</span><span class="p">)</span> 
                    <span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;std_cov&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">sX</span><span class="p">)</span> 
                    
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span> <span class="s1">&#39;Models&#39;</span><span class="p">,</span> <span class="s1">&#39;meta_data.md&#39;</span><span class="p">),</span> 
                          <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">meta_data</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">PICKLE_PROTOCOL</span><span class="p">)</span>
            
            <span class="n">batch_dirs</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;batch_*/&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">batch_dirs</span><span class="p">:</span>
                <span class="n">batch_dirs</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">sort_nicely</span><span class="p">(</span><span class="n">batch_dirs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">batch_dir</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">batch_dirs</span><span class="p">):</span>
                    <span class="n">src_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">batch_dir</span> <span class="o">+</span> <span class="s1">&#39;Models/NM*&#39;</span> <span class="o">+</span> <span class="n">outputsuffix</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">src_files</span><span class="p">:</span>
                        <span class="n">src_files</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">sort_nicely</span><span class="p">(</span><span class="n">src_files</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">full_file_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">src_files</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">full_file_name</span><span class="p">):</span>
                                <span class="n">file_name</span> <span class="o">=</span> <span class="n">full_file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">n</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
                                <span class="n">n</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="n">batch_size</span> <span class="o">+</span> <span class="n">f</span><span class="p">)</span>
                                <span class="n">n</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">full_file_name</span><span class="p">,</span> <span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;Models/&#39;</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">func</span><span class="o">==</span><span class="s1">&#39;fit&#39;</span><span class="p">:</span>
                        <span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">+</span><span class="mi">1</span>
                        <span class="n">batch1</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">batch_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">job_name</span> <span class="o">+</span> <span class="s1">&#39;*.sh&#39;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed batch: &#39;</span> <span class="o">+</span> <span class="n">batch1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">batch_fail</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch1</span><span class="p">)</span>
                        
    <span class="c1"># list batches that were not executed</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of batches that failed:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">))</span>
    <span class="n">batch_fail_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">batch_fail</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">file_extentions</span> <span class="o">==</span> <span class="s1">&#39;.txt&#39;</span><span class="p">:</span>
        <span class="n">fileio</span><span class="o">.</span><span class="n">save_pd</span><span class="p">(</span><span class="n">batch_fail_df</span><span class="p">,</span> <span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;failed_batches&#39;</span><span class="o">+</span>
                <span class="n">file_extentions</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fileio</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">batch_fail_df</span><span class="p">,</span> <span class="n">processing_dir</span> <span class="o">+</span>
            <span class="s1">&#39;failed_batches&#39;</span> <span class="o">+</span>
            <span class="n">file_extentions</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">batch_fail</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="delete_nm"><a class="viewcode-back" href="../modindex.html#normative_parallel.delete_nm">[docs]</a><span class="k">def</span> <span class="nf">delete_nm</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span>
              <span class="n">binary</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function deletes all processing for normative modelling and just</span>
<span class="sd">    keeps the combined output.</span>

<span class="sd">    :Parameters:</span>
<span class="sd">        * processing_dir        -&gt; Full path to the processing directory</span>
<span class="sd">        * binary                -&gt; Results in pkl format? </span>

<span class="sd">    written by (primarily) T Wolfers, (adapted) SM Kia</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">binary</span><span class="p">:</span>
        <span class="n">file_extentions</span> <span class="o">=</span> <span class="s1">&#39;.pkl&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">file_extentions</span> <span class="o">=</span> <span class="s1">&#39;.txt&#39;</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;batch_*/&#39;</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;failed_batches&#39;</span> <span class="o">+</span> <span class="n">file_extentions</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;failed_batches&#39;</span> <span class="o">+</span> <span class="n">file_extentions</span><span class="p">)</span></div>


<span class="c1"># all routines below are envronment dependent and require adaptation in novel</span>
<span class="c1"># environments -&gt; copy those routines and adapt them in accrodance with your</span>
<span class="c1"># environment</span>

<div class="viewcode-block" id="bashwrap_nm"><a class="viewcode-back" href="../modindex.html#normative_parallel.bashwrap_nm">[docs]</a><span class="k">def</span> <span class="nf">bashwrap_nm</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span>
                <span class="n">python_path</span><span class="p">,</span>
                <span class="n">normative_path</span><span class="p">,</span>
                <span class="n">job_name</span><span class="p">,</span>
                <span class="n">covfile_path</span><span class="p">,</span>
                <span class="n">respfile_path</span><span class="p">,</span>
                <span class="n">func</span><span class="o">=</span><span class="s1">&#39;estimate&#39;</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot; This function wraps normative modelling into a bash script to run it</span>
<span class="sd">    on a torque cluster system.</span>

<span class="sd">    :Parameters:</span>
<span class="sd">        * processing_dir     -&gt; Full path to the processing dir</span>
<span class="sd">        * python_path        -&gt; Full path to the python distribution</span>
<span class="sd">        * normative_path     -&gt; Full path to the normative.py</span>
<span class="sd">        * job_name           -&gt; Name for the bash script that is the output of</span>
<span class="sd">                                this function</span>
<span class="sd">        * covfile_path       -&gt; Full path to a .txt file that contains all</span>
<span class="sd">                                covariats (subjects x covariates) for the</span>
<span class="sd">                                responsefile</span>
<span class="sd">        * respfile_path      -&gt; Full path to a .txt that contains all features</span>
<span class="sd">                                (subjects x features)</span>
<span class="sd">        * cv_folds           -&gt; Number of cross validations</span>
<span class="sd">        * testcovfile_path   -&gt; Full path to a .txt file that contains all</span>
<span class="sd">                                covariats (subjects x covariates) for the</span>
<span class="sd">                                testresponse file</span>
<span class="sd">        * testrespfile_path  -&gt; Full path to a .txt file that contains all</span>
<span class="sd">                                test features</span>
<span class="sd">        * alg                -&gt; which algorithm to use</span>
<span class="sd">        * configparam        -&gt; configuration parameters for this algorithm</span>

<span class="sd">    :outputs:</span>
<span class="sd">        * A bash.sh file containing the commands for normative modelling saved</span>
<span class="sd">          to the processing directory (written to disk)</span>

<span class="sd">    written by (primarily) T Wolfers</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># here we use pop not get to remove the arguments as they used </span>
    <span class="n">cv_folds</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;cv_folds&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">testcovfile_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;testcovfile_path&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">testrespfile_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;testrespfile_path&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">alg</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;alg&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">configparam</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;configparam&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">standardize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;standardize&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># change to processing dir</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">)</span>
    <span class="n">output_changedir</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cd &#39;</span> <span class="o">+</span> <span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">]</span>

    <span class="n">bash_lines</span> <span class="o">=</span> <span class="s1">&#39;#!/bin/bash</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">bash_cores</span> <span class="o">=</span> <span class="s1">&#39;export OMP_NUM_THREADS=1</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">bash_environment</span> <span class="o">=</span> <span class="p">[</span><span class="n">bash_lines</span> <span class="o">+</span> <span class="n">bash_cores</span><span class="p">]</span>

    <span class="c1"># creates call of function for normative modelling</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">testrespfile_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">testcovfile_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">job_call</span> <span class="o">=</span> <span class="p">[</span><span class="n">python_path</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">normative_path</span> <span class="o">+</span> <span class="s1">&#39; -c &#39;</span> <span class="o">+</span>
                    <span class="n">covfile_path</span> <span class="o">+</span> <span class="s1">&#39; -t &#39;</span> <span class="o">+</span> <span class="n">testcovfile_path</span> <span class="o">+</span> <span class="s1">&#39; -r &#39;</span> <span class="o">+</span>
                    <span class="n">testrespfile_path</span> <span class="o">+</span> <span class="s1">&#39; -f &#39;</span> <span class="o">+</span> <span class="n">func</span><span class="p">]</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">testrespfile_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">testcovfile_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">job_call</span> <span class="o">=</span> <span class="p">[</span><span class="n">python_path</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">normative_path</span> <span class="o">+</span> <span class="s1">&#39; -c &#39;</span> <span class="o">+</span>
                    <span class="n">covfile_path</span> <span class="o">+</span> <span class="s1">&#39; -t &#39;</span> <span class="o">+</span> <span class="n">testcovfile_path</span> <span class="o">+</span> <span class="s1">&#39; -f &#39;</span> <span class="o">+</span> <span class="n">func</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">cv_folds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">job_call</span> <span class="o">=</span> <span class="p">[</span><span class="n">python_path</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">normative_path</span> <span class="o">+</span> <span class="s1">&#39; -c &#39;</span> <span class="o">+</span>
                    <span class="n">covfile_path</span> <span class="o">+</span> <span class="s1">&#39; -k &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cv_folds</span><span class="p">)</span> <span class="o">+</span>  <span class="s1">&#39; -f &#39;</span> <span class="o">+</span> <span class="n">func</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">func</span> <span class="o">!=</span> <span class="s1">&#39;estimate&#39;</span><span class="p">:</span>
        <span class="n">job_call</span> <span class="o">=</span> <span class="p">[</span><span class="n">python_path</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">normative_path</span> <span class="o">+</span> <span class="s1">&#39; -c &#39;</span> <span class="o">+</span>
                    <span class="n">covfile_path</span> <span class="o">+</span>  <span class="s1">&#39; -f &#39;</span> <span class="o">+</span> <span class="n">func</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s2">&quot;&quot;&quot;For &#39;estimate&#39; function either testcov or cvfold</span>
<span class="s2">              must be specified.&quot;&quot;&quot;</span><span class="p">)</span>
        
    <span class="c1"># add algorithm-specific parameters</span>
    <span class="k">if</span> <span class="n">alg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">job_call</span> <span class="o">=</span> <span class="p">[</span><span class="n">job_call</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; -a &#39;</span> <span class="o">+</span> <span class="n">alg</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">configparam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_call</span> <span class="o">=</span> <span class="p">[</span><span class="n">job_call</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; -x &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">configparam</span><span class="p">)]</span>
    
    <span class="c1"># add standardization flag if it is false</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">standardize</span><span class="p">:</span>
        <span class="n">job_call</span> <span class="o">=</span> <span class="p">[</span><span class="n">job_call</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; -s&#39;</span><span class="p">]</span>
    
    <span class="c1"># add responses file</span>
    <span class="n">job_call</span> <span class="o">=</span> <span class="p">[</span><span class="n">job_call</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">respfile_path</span><span class="p">]</span>
    
    <span class="c1"># add in optional arguments. </span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">job_call</span> <span class="o">=</span> <span class="p">[</span><span class="n">job_call</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">k</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span> <span class="o">+</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>

    <span class="c1"># writes bash file into processing dir</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">processing_dir</span><span class="o">+</span><span class="n">job_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">bash_file</span><span class="p">:</span>
        <span class="n">bash_file</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">bash_environment</span> <span class="o">+</span> <span class="n">output_changedir</span> <span class="o">+</span> \
                             <span class="n">job_call</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">])</span>

    <span class="c1"># changes permissoins for bash.sh file</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="n">job_name</span><span class="p">,</span> <span class="mo">0o700</span><span class="p">)</span></div>


<div class="viewcode-block" id="qsub_nm"><a class="viewcode-back" href="../modindex.html#normative_parallel.qsub_nm">[docs]</a><span class="k">def</span> <span class="nf">qsub_nm</span><span class="p">(</span><span class="n">job_path</span><span class="p">,</span>
            <span class="n">log_path</span><span class="p">,</span>
            <span class="n">memory</span><span class="p">,</span>
            <span class="n">duration</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function submits a job.sh scipt to the torque custer using the qsub</span>
<span class="sd">    command.</span>

<span class="sd">    ** Input:</span>
<span class="sd">        * job_path      -&gt; Full path to the job.sh file</span>
<span class="sd">        * memory        -&gt; Memory requirements written as string for example</span>
<span class="sd">                           4gb or 500mb</span>
<span class="sd">        * duation       -&gt; The approximate duration of the job, a string with</span>
<span class="sd">                           HH:MM:SS for example 01:01:01</span>

<span class="sd">    ** Output:</span>
<span class="sd">        * Submission of the job to the (torque) cluster</span>

<span class="sd">    witten by (primarily) T Wolfers, (adapted) SM Kia</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># created qsub command</span>
    <span class="k">if</span> <span class="n">log_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">qsub_call</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;echo &#39;</span> <span class="o">+</span> <span class="n">job_path</span> <span class="o">+</span> <span class="s1">&#39; | qsub -N &#39;</span> <span class="o">+</span> <span class="n">job_path</span> <span class="o">+</span> <span class="s1">&#39; -l &#39;</span> <span class="o">+</span>
                     <span class="s1">&#39;procs=1&#39;</span> <span class="o">+</span> <span class="s1">&#39;,mem=&#39;</span> <span class="o">+</span> <span class="n">memory</span> <span class="o">+</span> <span class="s1">&#39;,walltime=&#39;</span> <span class="o">+</span> <span class="n">duration</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">qsub_call</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;echo &#39;</span> <span class="o">+</span> <span class="n">job_path</span> <span class="o">+</span> <span class="s1">&#39; | qsub -N &#39;</span> <span class="o">+</span> <span class="n">job_path</span> <span class="o">+</span>
                     <span class="s1">&#39; -l &#39;</span> <span class="o">+</span> <span class="s1">&#39;procs=1&#39;</span> <span class="o">+</span> <span class="s1">&#39;,mem=&#39;</span> <span class="o">+</span> <span class="n">memory</span> <span class="o">+</span> <span class="s1">&#39;,walltime=&#39;</span> <span class="o">+</span> <span class="n">duration</span> <span class="o">+</span>
                     <span class="s1">&#39; -o &#39;</span> <span class="o">+</span> <span class="n">log_path</span> <span class="o">+</span> <span class="s1">&#39; -e &#39;</span> <span class="o">+</span> <span class="n">log_path</span><span class="p">]</span>

    <span class="c1"># submits job to cluster</span>
    <span class="n">call</span><span class="p">(</span><span class="n">qsub_call</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="rerun_nm"><a class="viewcode-back" href="../modindex.html#normative_parallel.rerun_nm">[docs]</a><span class="k">def</span> <span class="nf">rerun_nm</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span>
             <span class="n">log_path</span><span class="p">,</span>
             <span class="n">memory</span><span class="p">,</span>
             <span class="n">duration</span><span class="p">,</span>
             <span class="n">binary</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function reruns all failed batched in processing_dir after collect_nm</span>
<span class="sd">    has identified he failed batches</span>

<span class="sd">    * Input:</span>
<span class="sd">        * processing_dir        -&gt; Full path to the processing directory</span>
<span class="sd">        * memory                -&gt; Memory requirements written as string</span>
<span class="sd">                                   for example 4gb or 500mb</span>
<span class="sd">        * duration               -&gt; The approximate duration of the job, a</span>
<span class="sd">                                   string with HH:MM:SS for example 01:01:01</span>

<span class="sd">    written by (primarily) T Wolfers, (adapted) SM Kia</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">binary</span><span class="p">:</span>
        <span class="n">file_extentions</span> <span class="o">=</span> <span class="s1">&#39;.pkl&#39;</span>
        <span class="n">failed_batches</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span>
                                       <span class="s1">&#39;failed_batches&#39;</span> <span class="o">+</span> <span class="n">file_extentions</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">failed_batches</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">jobpath</span> <span class="o">=</span> <span class="n">failed_batches</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">jobpath</span><span class="p">)</span>
            <span class="n">qsub_nm</span><span class="p">(</span><span class="n">job_path</span><span class="o">=</span><span class="n">jobpath</span><span class="p">,</span>
                    <span class="n">log_path</span><span class="o">=</span><span class="n">log_path</span><span class="p">,</span>
                    <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span>
                    <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">file_extentions</span> <span class="o">=</span> <span class="s1">&#39;.txt&#39;</span>
        <span class="n">failed_batches</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">load_pd</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span>
                                       <span class="s1">&#39;failed_batches&#39;</span> <span class="o">+</span> <span class="n">file_extentions</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">failed_batches</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">jobpath</span> <span class="o">=</span> <span class="n">failed_batches</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">jobpath</span><span class="p">)</span>
            <span class="n">qsub_nm</span><span class="p">(</span><span class="n">job_path</span><span class="o">=</span><span class="n">jobpath</span><span class="p">,</span>
                    <span class="n">log_path</span><span class="o">=</span><span class="n">log_path</span><span class="p">,</span>
                    <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span>
                    <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">)</span></div>

<span class="c1"># COPY the rotines above here and aadapt those to your cluster</span>
<span class="c1"># bashwarp_nm; qsub_nm; rerun_nm</span>

<div class="viewcode-block" id="sbatchwrap_nm"><a class="viewcode-back" href="../modindex.html#normative_parallel.sbatchwrap_nm">[docs]</a><span class="k">def</span> <span class="nf">sbatchwrap_nm</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span>
                  <span class="n">python_path</span><span class="p">,</span>
                  <span class="n">normative_path</span><span class="p">,</span>
                  <span class="n">job_name</span><span class="p">,</span>
                  <span class="n">covfile_path</span><span class="p">,</span>
                  <span class="n">respfile_path</span><span class="p">,</span>
                  <span class="n">memory</span><span class="p">,</span>
                  <span class="n">duration</span><span class="p">,</span>
                  <span class="n">func</span><span class="o">=</span><span class="s1">&#39;estimate&#39;</span><span class="p">,</span>
                  <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot; This function wraps normative modelling into a bash script to run it</span>
<span class="sd">    on a torque cluster system.</span>

<span class="sd">    :Parameters:</span>
<span class="sd">        * processing_dir     -&gt; Full path to the processing dir</span>
<span class="sd">        * python_path        -&gt; Full path to the python distribution</span>
<span class="sd">        * normative_path     -&gt; Full path to the normative.py</span>
<span class="sd">        * job_name           -&gt; Name for the bash script that is the output of</span>
<span class="sd">                                this function</span>
<span class="sd">        * covfile_path       -&gt; Full path to a .txt file that contains all</span>
<span class="sd">                                covariats (subjects x covariates) for the</span>
<span class="sd">                                responsefile</span>
<span class="sd">        * respfile_path      -&gt; Full path to a .txt that contains all features</span>
<span class="sd">                                (subjects x features)</span>
<span class="sd">        * cv_folds           -&gt; Number of cross validations</span>
<span class="sd">        * testcovfile_path   -&gt; Full path to a .txt file that contains all</span>
<span class="sd">                                covariats (subjects x covariates) for the</span>
<span class="sd">                                testresponse file</span>
<span class="sd">        * testrespfile_path  -&gt; Full path to a .txt file that contains all</span>
<span class="sd">                                test features</span>
<span class="sd">        * alg                -&gt; which algorithm to use</span>
<span class="sd">        * configparam        -&gt; configuration parameters for this algorithm</span>

<span class="sd">    :outputs:</span>
<span class="sd">        * A bash.sh file containing the commands for normative modelling saved</span>
<span class="sd">          to the processing directory (written to disk)</span>

<span class="sd">    written by (primarily) T Wolfers</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># here we use pop not get to remove the arguments as they used </span>
    <span class="n">cv_folds</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;cv_folds&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">testcovfile_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;testcovfile_path&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">testrespfile_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;testrespfile_path&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">alg</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;alg&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">configparam</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;configparam&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">standardize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;standardize&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># change to processing dir</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">)</span>
    <span class="n">output_changedir</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cd &#39;</span> <span class="o">+</span> <span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">]</span>

    <span class="n">sbatch_init</span><span class="o">=</span><span class="s1">&#39;#!/bin/bash</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">sbatch_jobname</span><span class="o">=</span><span class="s1">&#39;#SBATCH --job-name=&#39;</span> <span class="o">+</span> <span class="n">processing_dir</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">sbatch_account</span><span class="o">=</span><span class="s1">&#39;#SBATCH --account=p33_norment</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">sbatch_nodes</span><span class="o">=</span><span class="s1">&#39;#SBATCH --nodes=1</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">sbatch_tasks</span><span class="o">=</span><span class="s1">&#39;#SBATCH --ntasks=1</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">sbatch_time</span><span class="o">=</span><span class="s1">&#39;#SBATCH --time=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">sbatch_memory</span><span class="o">=</span><span class="s1">&#39;#SBATCH --mem-per-cpu=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">memory</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">sbatch_module</span><span class="o">=</span><span class="s1">&#39;module purge</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">sbatch_anaconda</span><span class="o">=</span><span class="s1">&#39;module load anaconda3</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">sbatch_exit</span><span class="o">=</span><span class="s1">&#39;set -o errexit</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="c1">#echo -n &quot;This script is running on &quot;</span>
    <span class="c1">#hostname</span>
    
    <span class="n">bash_environment</span> <span class="o">=</span> <span class="p">[</span><span class="n">sbatch_init</span> <span class="o">+</span> 
                        <span class="n">sbatch_jobname</span> <span class="o">+</span>
                        <span class="n">sbatch_account</span> <span class="o">+</span>
                        <span class="n">sbatch_nodes</span> <span class="o">+</span>
                        <span class="n">sbatch_tasks</span> <span class="o">+</span>
                        <span class="n">sbatch_time</span> <span class="o">+</span>
                        <span class="n">sbatch_module</span> <span class="o">+</span>
                        <span class="n">sbatch_anaconda</span><span class="p">]</span>

    <span class="c1"># creates call of function for normative modelling</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">testrespfile_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">testcovfile_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">job_call</span> <span class="o">=</span> <span class="p">[</span><span class="n">python_path</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">normative_path</span> <span class="o">+</span> <span class="s1">&#39; -c &#39;</span> <span class="o">+</span>
                    <span class="n">covfile_path</span> <span class="o">+</span> <span class="s1">&#39; -t &#39;</span> <span class="o">+</span> <span class="n">testcovfile_path</span> <span class="o">+</span> <span class="s1">&#39; -r &#39;</span> <span class="o">+</span>
                    <span class="n">testrespfile_path</span> <span class="o">+</span> <span class="s1">&#39; -f &#39;</span> <span class="o">+</span> <span class="n">func</span><span class="p">]</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">testrespfile_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">testcovfile_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">job_call</span> <span class="o">=</span> <span class="p">[</span><span class="n">python_path</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">normative_path</span> <span class="o">+</span> <span class="s1">&#39; -c &#39;</span> <span class="o">+</span>
                    <span class="n">covfile_path</span> <span class="o">+</span> <span class="s1">&#39; -t &#39;</span> <span class="o">+</span> <span class="n">testcovfile_path</span> <span class="o">+</span> <span class="s1">&#39; -f &#39;</span> <span class="o">+</span> <span class="n">func</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">cv_folds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">job_call</span> <span class="o">=</span> <span class="p">[</span><span class="n">python_path</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">normative_path</span> <span class="o">+</span> <span class="s1">&#39; -c &#39;</span> <span class="o">+</span>
                    <span class="n">covfile_path</span> <span class="o">+</span> <span class="s1">&#39; -k &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cv_folds</span><span class="p">)</span> <span class="o">+</span>  <span class="s1">&#39; -f &#39;</span> <span class="o">+</span> <span class="n">func</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">func</span> <span class="o">!=</span> <span class="s1">&#39;estimate&#39;</span><span class="p">:</span>
        <span class="n">job_call</span> <span class="o">=</span> <span class="p">[</span><span class="n">python_path</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">normative_path</span> <span class="o">+</span> <span class="s1">&#39; -c &#39;</span> <span class="o">+</span>
                    <span class="n">covfile_path</span> <span class="o">+</span>  <span class="s1">&#39; -f &#39;</span> <span class="o">+</span> <span class="n">func</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s2">&quot;&quot;&quot;For &#39;estimate&#39; function either testcov or cvfold</span>
<span class="s2">              must be specified.&quot;&quot;&quot;</span><span class="p">)</span>
        
    <span class="c1"># add algorithm-specific parameters</span>
    <span class="k">if</span> <span class="n">alg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">job_call</span> <span class="o">=</span> <span class="p">[</span><span class="n">job_call</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; -a &#39;</span> <span class="o">+</span> <span class="n">alg</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">configparam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_call</span> <span class="o">=</span> <span class="p">[</span><span class="n">job_call</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; -x &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">configparam</span><span class="p">)]</span>
    
    <span class="c1"># add standardization flag if it is false</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">standardize</span><span class="p">:</span>
        <span class="n">job_call</span> <span class="o">=</span> <span class="p">[</span><span class="n">job_call</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; -s&#39;</span><span class="p">]</span>
    
    <span class="c1"># add responses file</span>
    <span class="n">job_call</span> <span class="o">=</span> <span class="p">[</span><span class="n">job_call</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">respfile_path</span><span class="p">]</span>
    
    <span class="c1"># add in optional arguments. </span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">job_call</span> <span class="o">=</span> <span class="p">[</span><span class="n">job_call</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">k</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span> <span class="o">+</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>

    <span class="c1"># writes bash file into processing dir</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">processing_dir</span><span class="o">+</span><span class="n">job_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">bash_file</span><span class="p">:</span>
        <span class="n">bash_file</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">bash_environment</span> <span class="o">+</span> <span class="n">output_changedir</span> <span class="o">+</span> \
                             <span class="n">job_call</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">sbatch_exit</span><span class="p">])</span>

    <span class="c1"># changes permissoins for bash.sh file</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span> <span class="n">job_name</span><span class="p">,</span> <span class="mo">0o700</span><span class="p">)</span></div>

<div class="viewcode-block" id="sbatch_nm"><a class="viewcode-back" href="../modindex.html#normative_parallel.sbatch_nm">[docs]</a><span class="k">def</span> <span class="nf">sbatch_nm</span><span class="p">(</span><span class="n">job_path</span><span class="p">,</span>
              <span class="n">log_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function submits a job.sh scipt to the torque custer using the qsub</span>
<span class="sd">    command.</span>

<span class="sd">    ** Input:</span>
<span class="sd">        * job_path      -&gt; Full path to the job.sh file</span>
<span class="sd">        * log_path      -&gt; The logs are currently stored in the working dir</span>

<span class="sd">    ** Output:</span>
<span class="sd">        * Submission of the job to the (torque) cluster</span>

<span class="sd">    witten by (primarily) T Wolfers</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># created qsub command</span>
    <span class="n">sbatch_call</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sbatch &#39;</span> <span class="o">+</span> <span class="n">job_path</span><span class="p">]</span>

    <span class="c1"># submits job to cluster</span>
    <span class="n">call</span><span class="p">(</span><span class="n">sbatch_call</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">rerun_nm</span><span class="p">(</span><span class="n">processing_dir</span><span class="p">,</span>
                 <span class="n">memory</span><span class="p">,</span>
                 <span class="n">duration</span><span class="p">,</span>
                 <span class="n">new_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">new_duration</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">binary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function reruns all failed batched in processing_dir after collect_nm</span>
<span class="sd">        has identified he failed batches</span>
<span class="sd">    </span>
<span class="sd">        * Input:</span>
<span class="sd">            * processing_dir        -&gt; Full path to the processing directory</span>
<span class="sd">            * memory                -&gt; Memory requirements written as string</span>
<span class="sd">                                       for example 4gb or 500mb</span>
<span class="sd">            * duration              -&gt; The approximate duration of the job, a</span>
<span class="sd">                                       string with HH:MM:SS for example 01:01:01</span>
<span class="sd">            * new_memory            -&gt; If you want to change the memory </span>
<span class="sd">                                        you have to indicate it here.</span>
<span class="sd">            * new_duration          -&gt; If you want to change the duration </span>
<span class="sd">                                        you have to indicate it here.</span>
<span class="sd">        * Outputs:</span>
<span class="sd">            * Reruns failed batches. </span>
<span class="sd">    </span>
<span class="sd">        written by (primarily) T Wolfers</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;log_path&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    
        <span class="k">if</span> <span class="n">binary</span><span class="p">:</span>
            <span class="n">file_extentions</span> <span class="o">=</span> <span class="s1">&#39;.pkl&#39;</span>
            <span class="n">failed_batches</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span>
                                         <span class="s1">&#39;failed_batches&#39;</span> <span class="o">+</span> 
                                         <span class="n">file_extentions</span><span class="p">)</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">failed_batches</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">jobpath</span> <span class="o">=</span> <span class="n">failed_batches</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">jobpath</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_duration</span> <span class="o">!=</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">FileInput</span><span class="p">(</span><span class="n">jobpath</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">duration</span><span class="p">,</span> <span class="n">new_duration</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_memory</span> <span class="o">!=</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">FileInput</span><span class="p">(</span><span class="n">jobpath</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="n">new_memory</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">sbatch_nm</span><span class="p">(</span><span class="n">jobpath</span><span class="p">,</span>
                          <span class="n">log_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file_extentions</span> <span class="o">=</span> <span class="s1">&#39;.txt&#39;</span>
            <span class="n">failed_batches</span> <span class="o">=</span> <span class="n">fileio</span><span class="o">.</span><span class="n">load_pd</span><span class="p">(</span><span class="n">processing_dir</span> <span class="o">+</span>
                                           <span class="s1">&#39;failed_batches&#39;</span> <span class="o">+</span> <span class="n">file_extentions</span><span class="p">)</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">failed_batches</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">jobpath</span> <span class="o">=</span> <span class="n">failed_batches</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">jobpath</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_duration</span> <span class="o">!=</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">FileInput</span><span class="p">(</span><span class="n">jobpath</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">duration</span><span class="p">,</span> <span class="n">new_duration</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_memory</span> <span class="o">!=</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">FileInput</span><span class="p">(</span><span class="n">jobpath</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="n">new_memory</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">sbatch_nm</span><span class="p">(</span><span class="n">jobpath</span><span class="p">,</span>
                          <span class="n">log_path</span><span class="p">)</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Predictive Clinical Neuroscience Toolkit 0.17 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">normative_parallel</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Andre F. Marquand.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.2.1.
    </div>
  </body>
</html>